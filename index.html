<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Integral - JardÃ­n Escondido</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } }
    .pulse-green { animation: pulse-green 2s infinite; }
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
    .ticket-font { font-family: 'Courier New', monospace; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>
  <div id="print-area" class="hidden"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, query, orderBy, where, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyAVB0cuMbczpdp1EXWZZaXV2uEoW0LiYPo",
      authDomain: "jardin-escondido.firebaseapp.com",
      projectId: "jardin-escondido",
      storageBucket: "jardin-escondido.firebasestorage.app",
      messagingSenderId: "41075573711",
      appId: "1:41075573711:web:1566bc05ec7048d4fa48ba"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB, 'jardin-escondido-db');

    // ========== CONFIGURACIÃ“N DEL NEGOCIO ==========
    const CONFIG_NEGOCIO = {
      nombre: 'JardÃ­n Escondido',
      direccion: 'CallejÃ³n de Esfuerzo No. 4, Santa Ãšrsula Coapa',
      telefono: '56170149',
      email: 'contacto@jardinescondido.com',
      contacto: 'Regina Ravelo',
      condiciones: {
        anticipo: 20,
        liquidacion: 8, // dÃ­as antes del evento
        duracionBase: 5, // horas
        recepcion: 0.5, // media hora
        salida: 0.5 // media hora
      },
      estacionamiento: {
        valetParking: 50,
        cortesiaAnfitriones: 1
      }
    };

    // ========== PAQUETES DE EVENTOS (EDITABLES - se cargan de Firebase) ==========
    let PAQUETES = [
      {
        id: 'basico',
        nombre: 'Paquete BÃ¡sico',
        descripcion: 'Montaje clÃ¡sico con mesas redondas',
        incluye: [
          '100mÂ² Carpa a 3m de altura',
          '30mÂ² Pista para baile',
          'Barra de mezcladores',
          'Mesas redondas para 10 personas con mantel, cubremantel y sillas acojinadas',
          '2 Tablones con mantel blanco'
        ],
        precios: {
          25: { mobiliario: 14340, taquiza: 165, parrillada: 150 },
          30: { mobiliario: 14540, taquiza: 165, parrillada: 150 },
          50: { mobiliario: 14390, taquiza: 165, parrillada: 150 },
          60: { mobiliario: 16590, taquiza: 165, parrillada: 150 },
          70: { mobiliario: 22500, taquiza: 520, parrillada: 500 },
          80: { mobiliario: 21450, taquiza: 165, parrillada: 150 },
          100: { mobiliario: 20450, taquiza: 165, parrillada: 150 }
        }
      },
      {
        id: 'intermedio',
        nombre: 'Paquete Intermedio',
        descripcion: 'Con arreglos florales y sillas Tiffany',
        incluye: [
          '100mÂ² Carpa a 3m de altura',
          '30mÂ² Pista para baile',
          'Arreglos florales',
          'Mesas cuadradas con sillas Tiffany para 10 personas',
          'Barra de mezcladores',
          '2 Tablones con mantel blanco'
        ],
        precios: {
          50: { mobiliario: 24000, taquiza: 600, parrillada: 590 },
          60: { mobiliario: 26000, taquiza: 600, parrillada: 590 },
          70: { mobiliario: 28800, taquiza: 600, parrillada: 590 },
          80: { mobiliario: 31000, taquiza: 600, parrillada: 590 },
          100: { mobiliario: 35000, taquiza: 600, parrillada: 590 }
        }
      },
      {
        id: 'organico',
        nombre: 'Montaje OrgÃ¡nico',
        descripcion: 'Mesas rectangulares con sillas Avant Garde',
        incluye: [
          '100mÂ² Carpa a 3m de altura',
          '30mÂ² Pista para baile',
          'Mesas rectangulares con sillas Avant Garde para 10 personas',
          'Arreglos florales para centro de mesa',
          'Barra de mezcladores',
          '2 Tablones con mantel blanco'
        ],
        precios: {
          50: { mobiliario: 28000, taquiza: 670, parrillada: 660 },
          60: { mobiliario: 30500, taquiza: 670, parrillada: 660 },
          70: { mobiliario: 32900, taquiza: 670, parrillada: 660 },
          80: { mobiliario: 35500, taquiza: 670, parrillada: 660 },
          100: { mobiliario: 40000, taquiza: 670, parrillada: 660 }
        }
      }
    ];

    // ========== TIPOS DE ALIMENTOS (EDITABLES) ==========
    let TIPOS_ALIMENTO = [
      { id: 'taquiza', nombre: 'Taquiza 5 guisados', descripcion: 'Arroz, frijoles y complementos' },
      { id: 'parrillada', nombre: 'Parrillada de Pastor', descripcion: 'Con guarniciones' },
      { id: 'parrillada_bistec', nombre: 'Parrillada de Bistec', descripcion: 'Con guarniciones' },
      { id: 'menu_3tiempos', nombre: 'MenÃº 3 Tiempos', descripcion: 'Entrada, plato fuerte, postre' },
      { id: 'menu_mexicano', nombre: 'MenÃº Mexicano 2 Tiempos', descripcion: 'Plato fuerte y postre' }
    ];

    // ========== EXTRAS (EDITABLES) ==========
    let EXTRAS = [
      { id: 'cabina_inflable', nombre: 'Cabina de foto inflable', precio: 3200 },
      { id: '360_photobooth', nombre: '360 Photo Booth', precio: 3840 },
      { id: 'cabina_espejo', nombre: 'Cabina tipo espejo', precio: 5040 },
      { id: 'letras_gigantes', nombre: 'Letras gigantes 1.80m iluminadas', precio: 1020 },
      { id: 'iluminacion_vintage', nombre: 'IluminaciÃ³n vintage', precio: 2500 },
      { id: 'pista_iluminada', nombre: 'Pista de baile iluminada', precio: 3500 },
      { id: 'dj', nombre: 'DJ', precio: 5500 },
      { id: 'batucada', nombre: 'Personajes para animar / Batucada', precio: 5500 },
      { id: 'karaoke', nombre: 'Karaoke', precio: 4500 },
      { id: 'inflable_3x4', nombre: 'Inflable 3x4m', precio: 1500 },
      { id: 'inflable_6x3', nombre: 'Inflable 6x3m', precio: 2500 },
      { id: 'mesa_honor', nombre: 'Mesa de honor', precio: 850 },
      { id: 'hora_extra', nombre: 'Hora extra (renta + meseros)', precio: 2950 },
      { id: 'cerveza_corona', nombre: 'Cerveza Corona/Victoria (cartÃ³n)', precio: 320 },
      { id: 'cerveza_indio', nombre: 'Cerveza Indio/XX Lager (cartÃ³n)', precio: 260 },
      { id: 'barra_botanas', nombre: 'Barra de botanas', precioPP: 70 }
    ];

    // ========== ITEMS INDIVIDUALES PARA COTIZACIONES PERSONALIZADAS ==========
    let ITEMS_INDIVIDUALES = [
      { id: 'carpa_100m', nombre: 'Carpa 100mÂ² (3m altura)', categoria: 'Mobiliario', precio: 6000 },
      { id: 'carpa_64m', nombre: 'Carpa 64mÂ² (3m altura)', categoria: 'Mobiliario', precio: 3840 },
      { id: 'pista_30m', nombre: 'Pista de baile 30mÂ²', categoria: 'Mobiliario', precio: 3300 },
      { id: 'pista_25m', nombre: 'Pista de baile 25mÂ²', categoria: 'Mobiliario', precio: 2750 },
      { id: 'mesa_redonda', nombre: 'Mesa redonda 10 personas (con mantel y sillas acojinadas)', categoria: 'Mobiliario', precio: 350, porPersona: false },
      { id: 'mesa_cuadrada_tiffany', nombre: 'Mesa cuadrada con sillas Tiffany (10 personas)', categoria: 'Mobiliario', precio: 480, porPersona: false },
      { id: 'mesa_rectangular_avantgarde', nombre: 'Mesa rectangular con sillas Avant Garde (10 personas)', categoria: 'Mobiliario', precio: 550, porPersona: false },
      { id: 'tablon', nombre: 'TablÃ³n con mantel blanco', categoria: 'Mobiliario', precio: 150 },
      { id: 'barra_mezcladores', nombre: 'Barra de mezcladores (incluye mesero)', categoria: 'Servicio', precio: 50, porPersona: true },
      { id: 'arreglo_floral', nombre: 'Arreglo floral centro de mesa', categoria: 'DecoraciÃ³n', precio: 400 },
      { id: 'mesero', nombre: 'Mesero (5 horas)', categoria: 'Servicio', precio: 800 },
      { id: 'coordinador', nombre: 'Coordinador de evento', categoria: 'Servicio', precio: 1500 },
      { id: 'limpieza', nombre: 'Personal de limpieza', categoria: 'Servicio', precio: 500 },
      { id: 'vajilla_pp', nombre: 'Vajilla completa', categoria: 'Servicio', precio: 25, porPersona: true },
      { id: 'manteleria', nombre: 'MantelerÃ­a (mantel + cubremantel)', categoria: 'Mobiliario', precio: 80 },
      { id: 'silla_acojinada', nombre: 'Silla acojinada', categoria: 'Mobiliario', precio: 35 },
      { id: 'silla_tiffany', nombre: 'Silla Tiffany', categoria: 'Mobiliario', precio: 55 },
      { id: 'silla_avantgarde', nombre: 'Silla Avant Garde', categoria: 'Mobiliario', precio: 65 },
      { id: 'renta_jardin_chico', nombre: 'Renta de jardÃ­n (hasta 50 personas)', categoria: 'Renta', precio: 6000 },
      { id: 'renta_jardin_mediano', nombre: 'Renta de jardÃ­n (51-80 personas)', categoria: 'Renta', precio: 6500 },
      { id: 'renta_jardin_grande', nombre: 'Renta de jardÃ­n (81+ personas)', categoria: 'Renta', precio: 7500 }
    ];

    // ========== BARRA DE MEZCLADORES ==========
    const BARRA_MEZCLADORES = {
      descripcion: 'Incluye hielo, agua de sabor a elegir (horchata, jamaica, pepino con limÃ³n, tamarindo, limÃ³n con chÃ­a), refresco ilimitado durante las 5 horas del evento, cafÃ© y un mesero.',
      opciones: ['Horchata', 'Jamaica', 'Pepino con limÃ³n', 'Tamarindo', 'LimÃ³n con chÃ­a']
    };

    // ========== ROLES DE USUARIO ==========
    const ROLES_SISTEMA = [
      { id: 'admin', nombre: 'Administrador', descripcion: 'Acceso total al sistema', color: 'bg-purple-100 text-purple-800', icono: 'ğŸ‘‘' },
      { id: 'mesero', nombre: 'Mesero', descripcion: 'App de meseros, crear Ã³rdenes', color: 'bg-amber-100 text-amber-800', icono: 'ğŸ½ï¸' },
      { id: 'cocina', nombre: 'Cocina', descripcion: 'Pantalla de cocina, preparar Ã³rdenes', color: 'bg-blue-100 text-blue-800', icono: 'ğŸ‘¨â€ğŸ³' },
      { id: 'cajero', nombre: 'Cajero', descripcion: 'Cobrar y cortes de caja', color: 'bg-green-100 text-green-800', icono: 'ğŸ’µ' },
      { id: 'viewer', nombre: 'Solo lectura', descripcion: 'Ver informaciÃ³n sin modificar', color: 'bg-gray-100 text-gray-800', icono: 'ğŸ‘ï¸' }
    ];

    // ========== ESTADO GLOBAL ==========
    let usuario = null;
    let moduloActivo = 'jardin';
    let seccionActiva = 'dashboard';
    let filtroMes = new Date().toISOString().slice(0, 7);
    let sidebarAbierto = true;
    let modalAbierto = null;
    let itemEditando = null;
    let busqueda = '';
    let modoLogin = 'login';

    // Datos
    let cotizaciones = [];
    let cotizacionesCatering = [];
    let visitas = [];
    let clientesJardin = [];
    let proveedores = [];
    let gastos = [];
    let productos = [];
    let ordenesRestaurante = [];
    let usuariosSistema = []; // Usuarios para administraciÃ³n
    let empleados = [];
    let insumos = [];
    let recetas = [];
    let listaCompras = [];
    let checadas = []; // Registros de entrada/salida

    // Constantes de Personal
    const TIPOS_CONTRATO = [
      { id: 'tiempo-completo', nombre: 'Tiempo Completo', horasSemana: 48, descripcion: 'Jornada completa con prestaciones de ley' },
      { id: 'medio-tiempo', nombre: 'Medio Tiempo', horasSemana: 24, descripcion: 'Media jornada' },
      { id: 'eventual', nombre: 'Eventual', horasSemana: 0, descripcion: 'Por evento o temporada' },
      { id: 'honorarios', nombre: 'Por Honorarios', horasSemana: 0, descripcion: 'Sin relaciÃ³n laboral, factura' }
    ];

    const PUESTOS_DISPONIBLES = [
      { id: 'gerente', nombre: 'Gerente', area: 'admin' },
      { id: 'admin', nombre: 'Administrativo', area: 'admin' },
      { id: 'chef', nombre: 'Chef', area: 'cocina' },
      { id: 'cocinero', nombre: 'Cocinero', area: 'cocina' },
      { id: 'ayudante-cocina', nombre: 'Ayudante de Cocina', area: 'cocina' },
      { id: 'mesero', nombre: 'Mesero', area: 'servicio' },
      { id: 'hostess', nombre: 'Hostess', area: 'servicio' },
      { id: 'cajero', nombre: 'Cajero', area: 'servicio' },
      { id: 'barman', nombre: 'Barman', area: 'servicio' },
      { id: 'limpieza', nombre: 'Limpieza', area: 'mantenimiento' },
      { id: 'mantenimiento', nombre: 'Mantenimiento', area: 'mantenimiento' },
      { id: 'vigilancia', nombre: 'Vigilancia', area: 'seguridad' }
    ];

    const DIAS_SEMANA = ['Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado', 'Domingo'];

    // Unidades disponibles
    const UNIDADES = [
      { id: 'kg', nombre: 'Kilogramo', abrev: 'kg', tipo: 'peso' },
      { id: 'g', nombre: 'Gramo', abrev: 'g', tipo: 'peso' },
      { id: 'lb', nombre: 'Libra', abrev: 'lb', tipo: 'peso' },
      { id: 'l', nombre: 'Litro', abrev: 'L', tipo: 'volumen' },
      { id: 'ml', nombre: 'Mililitro', abrev: 'ml', tipo: 'volumen' },
      { id: 'pza', nombre: 'Pieza', abrev: 'pza', tipo: 'unidad' },
      { id: 'paq', nombre: 'Paquete', abrev: 'paq', tipo: 'unidad' },
      { id: 'bolsa', nombre: 'Bolsa', abrev: 'bolsa', tipo: 'unidad' },
      { id: 'lata', nombre: 'Lata', abrev: 'lata', tipo: 'unidad' },
      { id: 'bote', nombre: 'Bote', abrev: 'bote', tipo: 'unidad' },
      { id: 'caja', nombre: 'Caja', abrev: 'caja', tipo: 'unidad' },
      { id: 'manojo', nombre: 'Manojo', abrev: 'manojo', tipo: 'unidad' },
      { id: 'rebanada', nombre: 'Rebanada', abrev: 'reb', tipo: 'unidad' },
      { id: 'cucharada', nombre: 'Cucharada', abrev: 'cda', tipo: 'volumen' },
      { id: 'cucharadita', nombre: 'Cucharadita', abrev: 'cdita', tipo: 'volumen' },
      { id: 'taza', nombre: 'Taza', abrev: 'taza', tipo: 'volumen' },
      { id: 'docena', nombre: 'Docena', abrev: 'doc', tipo: 'unidad' }
    ];

    // CategorÃ­as de insumos
    const CATEGORIAS_INSUMOS = [
      'Carnes', 'Aves', 'Mariscos', 'LÃ¡cteos', 'Verduras', 'Frutas', 
      'Abarrotes', 'Especias', 'Aceites', 'Bebidas', 'PanaderÃ­a', 'Otros'
    ];

    // CategorÃ­as de gastos por Ã¡rea
    const CATEGORIAS_GASTOS = {
      jardin: [
        { id: 'mobiliario', nombre: 'Mobiliario y DecoraciÃ³n', icono: 'ğŸª‘' },
        { id: 'mantenimiento', nombre: 'Mantenimiento JardÃ­n', icono: 'ğŸŒ¿' },
        { id: 'servicios', nombre: 'Servicios (Luz, Agua, Gas)', icono: 'ğŸ’¡' },
        { id: 'limpieza', nombre: 'Limpieza', icono: 'ğŸ§¹' },
        { id: 'proveedores_evento', nombre: 'Proveedores de Eventos', icono: 'ğŸª' },
        { id: 'varios_jardin', nombre: 'Varios JardÃ­n', icono: 'ğŸ“¦' }
      ],
      restaurante: [
        { id: 'insumos', nombre: 'Insumos y Materia Prima', icono: 'ğŸ¥¬' },
        { id: 'personal_rest', nombre: 'Personal Cocina', icono: 'ğŸ‘¨â€ğŸ³' },
        { id: 'equipo', nombre: 'Equipo de Cocina', icono: 'ğŸ³' },
        { id: 'empaques', nombre: 'Empaques y Desechables', icono: 'ğŸ“¦' },
        { id: 'gas', nombre: 'Gas y Combustibles', icono: 'ğŸ”¥' },
        { id: 'varios_rest', nombre: 'Varios Restaurante', icono: 'ğŸ›’' }
      ],
      compartido: [
        { id: 'nomina', nombre: 'NÃ³mina General', icono: 'ğŸ’µ' },
        { id: 'renta', nombre: 'Renta del Local', icono: 'ğŸ ' },
        { id: 'impuestos', nombre: 'Impuestos', icono: 'ğŸ“‹' },
        { id: 'seguros', nombre: 'Seguros', icono: 'ğŸ›¡ï¸' },
        { id: 'marketing', nombre: 'Marketing y Publicidad', icono: 'ğŸ“¢' },
        { id: 'software', nombre: 'Software y Sistemas', icono: 'ğŸ’»' },
        { id: 'papeleria', nombre: 'PapelerÃ­a y Oficina', icono: 'ğŸ“' },
        { id: 'varios', nombre: 'Gastos Varios', icono: 'ğŸ”§' }
      ]
    };

    // CotizaciÃ³n actual (para crear/editar)
    let cotizacionActual = {
      cliente: { nombre: '', telefono: '', email: '', fechaEvento: '', tipoEvento: '' },
      personas: 70,
      paquete: 'basico',
      tipoAlimento: 'taquiza',
      extras: [],
      descuento: 0,
      notas: '',
      // Modo personalizado
      modoPersonalizado: false,
      itemsPersonalizados: [], // { itemId, nombre, cantidad, precioUnitario, subtotal }
      alimentoPersonalizado: { nombre: '', precioPP: 0 }
    };

    // ========== ESTRUCTURA DE MÃ“DULOS ==========
    const MODULOS = {
      jardin: {
        nombre: 'ğŸŒ¿ JardÃ­n Escondido',
        color: 'emerald',
        secciones: [
          { id: 'dashboard', nombre: 'ğŸ“Š Dashboard', icono: 'ğŸ“Š' },
          { id: 'cotizaciones', nombre: 'ğŸ“ Cotizaciones', icono: 'ğŸ“' },
          { id: 'nueva-cotizacion', nombre: 'â• Nueva CotizaciÃ³n', icono: 'â•' },
          { id: 'calendario', nombre: 'ğŸ“… Calendario', icono: 'ğŸ“…' },
          { id: 'visitas', nombre: 'ğŸ—“ï¸ Agenda Visitas', icono: 'ğŸ—“ï¸' },
          { id: 'clientes', nombre: 'ğŸ‘¥ Clientes', icono: 'ğŸ‘¥' },
          { id: 'proveedores', nombre: 'ğŸ“ Proveedores', icono: 'ğŸ“' },
          { id: 'gastos', nombre: 'ğŸ§¾ Gastos', icono: 'ğŸ§¾' },
          { id: 'reportes', nombre: 'ğŸ“ˆ Reportes', icono: 'ğŸ“ˆ' },
          { id: 'config-paquetes', nombre: 'âš™ï¸ Config. Paquetes', icono: 'âš™ï¸' }
        ]
      },
      restaurante: {
        nombre: 'ğŸ½ï¸ Restaurante',
        color: 'amber',
        secciones: [
          { id: 'dashboard', nombre: 'ğŸ“Š Dashboard Ventas', icono: 'ğŸ“Š' },
          { id: 'ordenes', nombre: 'ğŸ”´ Ã“rdenes en Vivo', icono: 'ğŸ”´' },
          { id: 'menu', nombre: 'â˜• MenÃº/Productos', icono: 'â˜•' },
          { id: 'recetas', nombre: 'ğŸ“– Recetas y Costos', icono: 'ğŸ“–' },
          { id: 'insumos', nombre: 'ğŸ¥¬ Insumos/Ingredientes', icono: 'ğŸ¥¬' },
          { id: 'lista-compras', nombre: 'ğŸ›’ Lista de Compras', icono: 'ğŸ›’' },
          { id: 'inventario', nombre: 'ğŸ“¦ Inventario', icono: 'ğŸ“¦' },
          { id: 'catering', nombre: 'ğŸ± Catering/Eventos', icono: 'ğŸ±' },
          { id: 'corte', nombre: 'âœ‚ï¸ Corte de Caja', icono: 'âœ‚ï¸' }
        ]
      },
      contabilidad: {
        nombre: 'ğŸ’° Contabilidad',
        color: 'indigo',
        secciones: [
          { id: 'consolidado', nombre: 'ğŸ“Š Vista Consolidada', icono: 'ğŸ“Š' },
          { id: 'cont-restaurante', nombre: 'ğŸ½ï¸ Restaurante', icono: 'ğŸ½ï¸' },
          { id: 'cont-jardin', nombre: 'ğŸŒ¿ JardÃ­n', icono: 'ğŸŒ¿' },
          { id: 'cont-gastos', nombre: 'ğŸ§¾ Registrar Gastos', icono: 'ğŸ§¾' }
        ]
      },
      personal: {
        nombre: 'ğŸ‘· Personal',
        color: 'blue',
        secciones: [
          { id: 'directorio', nombre: 'ğŸ‘¤ Directorio', icono: 'ğŸ‘¤' },
          { id: 'nomina', nombre: 'ğŸ’µ NÃ³mina', icono: 'ğŸ’µ' },
          { id: 'horarios', nombre: 'ğŸ• Horarios', icono: 'ğŸ•' },
          { id: 'asistencia', nombre: 'ğŸ“‹ Asistencia', icono: 'ğŸ“‹' }
        ]
      },
      herramientas: {
        nombre: 'ğŸ”§ Herramientas',
        color: 'slate',
        secciones: [
          { id: 'calculadora', nombre: 'ğŸ§® Calculadora', icono: 'ğŸ§®' },
          { id: 'config', nombre: 'âš™ï¸ ConfiguraciÃ³n', icono: 'âš™ï¸' }
        ]
      },
      admin: {
        nombre: 'âš™ï¸ AdministraciÃ³n',
        color: 'purple',
        secciones: [
          { id: 'usuarios', nombre: 'ğŸ‘¥ Usuarios', icono: 'ğŸ‘¥' },
          { id: 'ordenes-admin', nombre: 'ğŸ“‹ Ã“rdenes', icono: 'ğŸ“‹' },
          { id: 'datos', nombre: 'ğŸ—„ï¸ GestiÃ³n Datos', icono: 'ğŸ—„ï¸' }
        ]
      }
    };

    const ESTADOS = [
      { id: 'pendiente', nombre: 'Pendiente', color: 'bg-yellow-100 text-yellow-800', icon: 'â³' },
      { id: 'confirmado', nombre: 'Confirmado', color: 'bg-blue-100 text-blue-800', icon: 'âœ…' },
      { id: 'anticipo', nombre: 'Con Anticipo', color: 'bg-purple-100 text-purple-800', icon: 'ğŸ’°' },
      { id: 'liquidado', nombre: 'Liquidado', color: 'bg-green-100 text-green-800', icon: 'ğŸ’µ' },
      { id: 'realizado', nombre: 'Realizado', color: 'bg-emerald-100 text-emerald-800', icon: 'ğŸ‰' },
      { id: 'cancelado', nombre: 'Cancelado', color: 'bg-red-100 text-red-800', icon: 'âŒ' },
      { id: 'no_concretado', nombre: 'No Concretado', color: 'bg-gray-100 text-gray-800', icon: 'ğŸš«' }
    ];

    const ESTADOS_ORDEN = {
      pendiente: { nombre: 'Pendiente', color: 'bg-yellow-100 text-yellow-800', icon: 'â³' },
      preparando: { nombre: 'Preparando', color: 'bg-blue-100 text-blue-800', icon: 'ğŸ‘¨â€ğŸ³' },
      listo: { nombre: 'Listo', color: 'bg-green-100 text-green-800', icon: 'âœ…' },
      entregado: { nombre: 'Entregado', color: 'bg-purple-100 text-purple-800', icon: 'ğŸ½ï¸' },
      pagado: { nombre: 'Pagado', color: 'bg-emerald-100 text-emerald-800', icon: 'ğŸ’µ' },
      cancelado: { nombre: 'Cancelado', color: 'bg-red-100 text-red-800', icon: 'âŒ' }
    };

    // ========== UTILIDADES ==========
    const fmt = (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n || 0);
    const fmtFecha = (f) => f ? new Date(f + 'T12:00').toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
    const fmtFechaLarga = (f) => f ? new Date(f + 'T12:00').toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : '-';
    const fmtFechaHora = (d) => {
      if (!d) return '-';
      const fecha = d instanceof Date ? d : new Date(d);
      return fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    };
    const getEstado = (id) => ESTADOS.find(e => e.id === id) || ESTADOS[0];
    const getEstadoOrden = (id) => ESTADOS_ORDEN[id] || ESTADOS_ORDEN.pendiente;
    const getColor = (mod) => MODULOS[mod]?.color || 'gray';
    const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const puedeEditar = () => usuario?.rol === 'admin';
    const tiempoTranscurrido = (fecha) => {
      if (!fecha) return '-';
      const ahora = new Date();
      const creacion = fecha.toDate ? fecha.toDate() : new Date(fecha);
      const mins = Math.floor((ahora - creacion) / 60000);
      if (mins < 1) return 'Ahora';
      if (mins < 60) return `${mins} min`;
      return `${Math.floor(mins / 60)}h ${mins % 60}m`;
    };

    // ========== FIREBASE FUNCTIONS ==========
    async function cargarDatos() {
      const colecciones = [
        { nombre: 'cotizaciones', setter: (d) => cotizaciones = d },
        { nombre: 'cotizacionesCatering', setter: (d) => cotizacionesCatering = d },
        { nombre: 'gastos', setter: (d) => gastos = d },
        { nombre: 'visitas', setter: (d) => visitas = d },
        { nombre: 'clientesJardin', setter: (d) => clientesJardin = d },
        { nombre: 'proveedores', setter: (d) => proveedores = d },
        { nombre: 'productos', setter: (d) => productos = d },
        { nombre: 'empleados', setter: (d) => empleados = d },
        { nombre: 'insumos', setter: (d) => insumos = d },
        { nombre: 'recetas', setter: (d) => recetas = d },
        { nombre: 'listaCompras', setter: (d) => listaCompras = d },
        { nombre: 'checadas', setter: (d) => checadas = d }
      ];

      for (const col of colecciones) {
        try {
          const snap = await getDocs(collection(db, col.nombre));
          col.setter(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        } catch (e) { console.log(`ColecciÃ³n ${col.nombre} vacÃ­a`); }
      }

      // Cargar configuraciones guardadas
      await cargarConfiguraciones();

      // Productos de ejemplo si no hay
      if (productos.length === 0) {
        productos = [
          { id: '1', nombre: 'Tacos al Pastor', categoria: 'Platillos', precio: 65, costo: 25, activo: true },
          { id: '2', nombre: 'Enchiladas Suizas', categoria: 'Platillos', precio: 85, costo: 35, activo: true },
          { id: '3', nombre: 'Quesadillas', categoria: 'Platillos', precio: 55, costo: 20, activo: true },
          { id: '4', nombre: 'Pozole', categoria: 'Platillos', precio: 95, costo: 40, activo: true },
          { id: '5', nombre: 'Agua de Horchata', categoria: 'Bebidas', precio: 25, costo: 8, activo: true },
          { id: '6', nombre: 'Agua de Jamaica', categoria: 'Bebidas', precio: 25, costo: 8, activo: true },
          { id: '7', nombre: 'Refresco', categoria: 'Bebidas', precio: 30, costo: 12, activo: true },
          { id: '8', nombre: 'Cerveza', categoria: 'Bebidas', precio: 45, costo: 22, activo: true },
          { id: '9', nombre: 'CafÃ© Americano', categoria: 'Bebidas', precio: 35, costo: 10, activo: true },
          { id: '10', nombre: 'Flan', categoria: 'Postres', precio: 45, costo: 15, activo: true },
          { id: '11', nombre: 'Guacamole', categoria: 'Entradas', precio: 75, costo: 30, activo: true },
          { id: '12', nombre: 'Nachos', categoria: 'Entradas', precio: 85, costo: 35, activo: true },
        ];
      }

      // Insumos de ejemplo si no hay
      if (insumos.length === 0) {
        insumos = [
          { id: 'ins1', nombre: 'Carne de res', categoria: 'Carnes', unidadCompra: 'kg', precioCompra: 180, unidadUso: 'g', equivalencia: 1000, stockActual: 5, stockMinimo: 2, proveedor: '' },
          { id: 'ins2', nombre: 'Pechuga de pollo', categoria: 'Aves', unidadCompra: 'kg', precioCompra: 95, unidadUso: 'g', equivalencia: 1000, stockActual: 3, stockMinimo: 2, proveedor: '' },
          { id: 'ins3', nombre: 'Carne de cerdo', categoria: 'Carnes', unidadCompra: 'kg', precioCompra: 120, unidadUso: 'g', equivalencia: 1000, stockActual: 4, stockMinimo: 2, proveedor: '' },
          { id: 'ins4', nombre: 'Tortilla de maÃ­z', categoria: 'PanaderÃ­a', unidadCompra: 'kg', precioCompra: 22, unidadUso: 'pza', equivalencia: 30, stockActual: 5, stockMinimo: 3, proveedor: '' },
          { id: 'ins5', nombre: 'Cebolla', categoria: 'Verduras', unidadCompra: 'kg', precioCompra: 25, unidadUso: 'g', equivalencia: 1000, stockActual: 3, stockMinimo: 2, proveedor: '' },
          { id: 'ins6', nombre: 'Tomate', categoria: 'Verduras', unidadCompra: 'kg', precioCompra: 35, unidadUso: 'g', equivalencia: 1000, stockActual: 4, stockMinimo: 2, proveedor: '' },
          { id: 'ins7', nombre: 'Cilantro', categoria: 'Verduras', unidadCompra: 'manojo', precioCompra: 10, unidadUso: 'g', equivalencia: 100, stockActual: 5, stockMinimo: 3, proveedor: '' },
          { id: 'ins8', nombre: 'LimÃ³n', categoria: 'Frutas', unidadCompra: 'kg', precioCompra: 40, unidadUso: 'pza', equivalencia: 10, stockActual: 3, stockMinimo: 2, proveedor: '' },
          { id: 'ins9', nombre: 'Aguacate', categoria: 'Frutas', unidadCompra: 'pza', precioCompra: 35, unidadUso: 'pza', equivalencia: 1, stockActual: 10, stockMinimo: 5, proveedor: '' },
          { id: 'ins10', nombre: 'Queso Oaxaca', categoria: 'LÃ¡cteos', unidadCompra: 'kg', precioCompra: 140, unidadUso: 'g', equivalencia: 1000, stockActual: 2, stockMinimo: 1, proveedor: '' },
          { id: 'ins11', nombre: 'Crema', categoria: 'LÃ¡cteos', unidadCompra: 'l', precioCompra: 55, unidadUso: 'ml', equivalencia: 1000, stockActual: 3, stockMinimo: 2, proveedor: '' },
          { id: 'ins12', nombre: 'Aceite vegetal', categoria: 'Aceites', unidadCompra: 'l', precioCompra: 45, unidadUso: 'ml', equivalencia: 1000, stockActual: 5, stockMinimo: 2, proveedor: '' },
          { id: 'ins13', nombre: 'Sal', categoria: 'Especias', unidadCompra: 'kg', precioCompra: 15, unidadUso: 'g', equivalencia: 1000, stockActual: 2, stockMinimo: 1, proveedor: '' },
          { id: 'ins14', nombre: 'Chile guajillo', categoria: 'Especias', unidadCompra: 'kg', precioCompra: 120, unidadUso: 'g', equivalencia: 1000, stockActual: 1, stockMinimo: 0.5, proveedor: '' },
          { id: 'ins15', nombre: 'Arroz', categoria: 'Abarrotes', unidadCompra: 'kg', precioCompra: 28, unidadUso: 'g', equivalencia: 1000, stockActual: 5, stockMinimo: 3, proveedor: '' },
          { id: 'ins16', nombre: 'Frijol negro', categoria: 'Abarrotes', unidadCompra: 'kg', precioCompra: 35, unidadUso: 'g', equivalencia: 1000, stockActual: 4, stockMinimo: 2, proveedor: '' },
        ];
      }
    }

    async function cargarConfiguraciones() {
      try {
        // Cargar paquetes de jardÃ­n
        const paqSnap = await getDoc(doc(db, 'configuracion', 'paquetes'));
        if (paqSnap.exists() && paqSnap.data().lista) {
          PAQUETES = paqSnap.data().lista;
        }

        // Cargar extras de jardÃ­n
        const extSnap = await getDoc(doc(db, 'configuracion', 'extras'));
        if (extSnap.exists() && extSnap.data().lista) {
          EXTRAS = extSnap.data().lista;
        }

        // Cargar items individuales
        const itemSnap = await getDoc(doc(db, 'configuracion', 'itemsIndividuales'));
        if (itemSnap.exists() && itemSnap.data().lista) {
          ITEMS_INDIVIDUALES = itemSnap.data().lista;
        }

        // Cargar tipos de alimento
        const alimSnap = await getDoc(doc(db, 'configuracion', 'tiposAlimento'));
        if (alimSnap.exists() && alimSnap.data().lista) {
          TIPOS_ALIMENTO = alimSnap.data().lista;
        }

        // Cargar paquetes de CATERING
        const catPaqSnap = await getDoc(doc(db, 'configuracion', 'paquetesCatering'));
        if (catPaqSnap.exists() && catPaqSnap.data().lista) {
          paquetesCatering = catPaqSnap.data().lista;
        }

        // Cargar extras de CATERING
        const catExtSnap = await getDoc(doc(db, 'configuracion', 'extrasCatering'));
        if (catExtSnap.exists() && catExtSnap.data().lista) {
          extrasCatering = catExtSnap.data().lista;
        }

        // Cargar configuraciÃ³n del negocio
        const negocioSnap = await getDoc(doc(db, 'configuracion', 'negocio'));
        if (negocioSnap.exists()) {
          window.configNegocio = negocioSnap.data();
        }

        // Cargar configuraciÃ³n de tickets
        const ticketsSnap = await getDoc(doc(db, 'configuracion', 'tickets'));
        if (ticketsSnap.exists()) {
          window.configTickets = ticketsSnap.data();
        }

        // Cargar configuraciÃ³n de mesas
        const mesasSnap = await getDoc(doc(db, 'configuracion', 'mesas'));
        if (mesasSnap.exists() && mesasSnap.data().lista) {
          window.configMesas = mesasSnap.data().lista;
        }

        // Cargar configuraciÃ³n de horarios
        const horariosSnap = await getDoc(doc(db, 'configuracion', 'horarios'));
        if (horariosSnap.exists()) {
          window.configHorarios = horariosSnap.data();
        }

        // Cargar configuraciÃ³n de impuestos
        const impuestosSnap = await getDoc(doc(db, 'configuracion', 'impuestos'));
        if (impuestosSnap.exists()) {
          window.configImpuestos = impuestosSnap.data();
        }
      } catch (e) {
        console.log('Usando configuraciÃ³n por defecto');
      }
    }

    async function guardarConfiguracion(tipo, datos) {
      try {
        await setDoc(doc(db, 'configuracion', tipo), { 
          lista: datos, 
          fechaActualizacion: serverTimestamp() 
        });
        await cargarConfiguraciones();
        render();
        return true;
      } catch (e) {
        console.error('Error guardando configuraciÃ³n:', e);
        alert('Error al guardar');
        return false;
      }
    }

    function escucharOrdenesRestaurante() {
      const q = query(collection(db, 'ordenesRestaurante'), orderBy('fechaCreacion', 'desc'));
      onSnapshot(q, (snap) => {
        ordenesRestaurante = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      }, (e) => console.log('Error:', e));
    }

    async function guardarDoc(coleccion, id, datos) {
      try {
        await setDoc(doc(db, coleccion, id), { ...datos, fechaActualizacion: serverTimestamp() });
        await cargarDatos();
        render();
        return true;
      } catch (e) {
        console.error('Error:', e);
        alert('Error al guardar');
        return false;
      }
    }

    async function eliminarDoc(coleccion, id) {
      if (!confirm('Â¿Eliminar este registro?')) return;
      try {
        await deleteDoc(doc(db, coleccion, id));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error al eliminar');
      }
    }

    // ========== CÃLCULO DE COTIZACIÃ“N ==========
    function calcularCotizacion(cot) {
      // Modo personalizado
      if (cot.modoPersonalizado) {
        const itemsTotal = (cot.itemsPersonalizados || []).reduce((sum, item) => sum + (item.subtotal || 0), 0);
        const alimentos = (cot.alimentoPersonalizado?.precioPP || 0) * (cot.personas || 0);
        
        let extras = 0;
        (cot.extras || []).forEach(extraId => {
          const extra = EXTRAS.find(e => e.id === extraId);
          if (extra) {
            extras += extra.precioPP ? extra.precioPP * cot.personas : extra.precio;
          }
        });

        const subtotal = itemsTotal + alimentos + extras;
        const descuento = (subtotal * (cot.descuento || 0)) / 100;
        const total = subtotal - descuento;
        const anticipo = total * (CONFIG_NEGOCIO.condiciones.anticipo / 100);

        return { 
          mobiliario: itemsTotal, 
          alimentos, 
          precioPP: cot.alimentoPersonalizado?.precioPP || 0, 
          extras, 
          subtotal, 
          descuento, 
          total, 
          anticipo 
        };
      }

      // Modo paquete
      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      const personas = cot.personas || 70;
      
      // Buscar precio mÃ¡s cercano
      const personasDisponibles = Object.keys(paquete.precios || {}).map(Number).sort((a, b) => a - b);
      let personasClave = personasDisponibles.find(p => p >= personas) || personasDisponibles[personasDisponibles.length - 1] || 70;
      
      const precios = paquete.precios?.[personasClave] || { mobiliario: 22500, taquiza: 520, parrillada: 500 };
      
      const mobiliario = precios.mobiliario || 0;
      const precioPP = cot.tipoAlimento === 'parrillada' || cot.tipoAlimento === 'parrillada_bistec' 
        ? (precios.parrillada || precios.taquiza || 0) 
        : (precios.taquiza || 0);
      const alimentos = precioPP * personas;
      
      let extras = 0;
      (cot.extras || []).forEach(extraId => {
        const extra = EXTRAS.find(e => e.id === extraId);
        if (extra) {
          extras += extra.precioPP ? extra.precioPP * personas : extra.precio;
        }
      });

      const subtotal = mobiliario + alimentos + extras;
      const descuento = (subtotal * (cot.descuento || 0)) / 100;
      const total = subtotal - descuento;
      const anticipo = total * (CONFIG_NEGOCIO.condiciones.anticipo / 100);

      return { mobiliario, alimentos, precioPP, extras, subtotal, descuento, total, anticipo };
    }

    // ========== NAVEGACIÃ“N ==========
    window.setModulo = (mod) => { moduloActivo = mod; seccionActiva = MODULOS[mod].secciones[0].id; render(); };
    window.setSeccion = (sec) => { seccionActiva = sec; render(); };
    window.setFiltroMes = (m) => { filtroMes = m; render(); };
    window.toggleSidebar = () => { sidebarAbierto = !sidebarAbierto; render(); };
    window.abrirModal = (tipo, item = null) => { 
      modalAbierto = tipo; 
      itemEditando = item; 
      // Inicializar ingredientes temporales para recetas
      if (tipo === 'receta') {
        window.tempIngredientes = item?.ingredientes ? [...item.ingredientes] : [];
      }
      render(); 
    };
    window.cerrarModal = () => { modalAbierto = null; itemEditando = null; render(); };
    window.setBusqueda = (t) => { busqueda = t; render(); };
    window.setModoLogin = (m) => { modoLogin = m; render(); };

    // Funciones de gastos de contabilidad
    window.actualizarCategoriasGasto = () => {
      const area = document.getElementById('gasto-area').value;
      const select = document.getElementById('gasto-categoria');
      select.innerHTML = CATEGORIAS_GASTOS[area].map(c => `<option value="${c.id}">${c.icono} ${c.nombre}</option>`).join('');
    };

    window.guardarGastoContabilidad = async () => {
      const gasto = {
        fecha: document.getElementById('gasto-fecha').value,
        area: document.getElementById('gasto-area').value,
        categoria: document.getElementById('gasto-categoria').value,
        descripcion: document.getElementById('gasto-descripcion').value,
        monto: parseFloat(document.getElementById('gasto-monto').value) || 0,
        proveedor: document.getElementById('gasto-proveedor').value,
        fechaCreacion: serverTimestamp()
      };
      
      if (!gasto.fecha || !gasto.monto) {
        alert('Completa fecha y monto');
        return;
      }
      
      const id = itemEditando?.id || genId();
      if (await guardarDoc('gastos', id, gasto)) {
        alert('âœ… Gasto guardado');
        cerrarModal();
      }
    };

    window.eliminarGasto = async (id) => {
      if (!confirm('Â¿Eliminar este gasto?')) return;
      if (await eliminarDoc('gastos', id)) {
        alert('âœ… Gasto eliminado');
        render();
      }
    };

    // ========== RENDER PRINCIPAL ==========
    // ========== VERIFICACIÃ“N DE ROLES ==========
    function tienePermiso(permisoRequerido) {
      if (!usuario) return false;
      const rol = usuario.rol || 'viewer';
      
      const permisos = {
        admin: ['todo', 'jardin', 'restaurante', 'personal', 'herramientas', 'gastos', 'cotizaciones', 'ordenes', 'productos', 'usuarios'],
        mesero: ['ordenes', 'restaurante_lectura'],
        cocina: ['ordenes_cocina', 'recetas', 'insumos'],
        cajero: ['ordenes', 'corte', 'restaurante_lectura'],
        viewer: ['lectura']
      };
      
      if (rol === 'admin') return true;
      return permisos[rol]?.includes(permisoRequerido) || false;
    }

    function render() {
      if (!usuario) {
        document.getElementById('app').innerHTML = renderLogin();
        return;
      }
      
      // Verificar si el usuario tiene acceso al sistema principal (solo admin)
      if (usuario.rol !== 'admin') {
        document.getElementById('app').innerHTML = renderAccesoDenegado();
        return;
      }
      
      document.getElementById('app').innerHTML = renderApp();
    }

    function renderAccesoDenegado() {
      const rol = usuario.rol || 'sin rol';
      const redireccion = {
        mesero: { url: 'meseros.html', nombre: 'App de Meseros', icono: 'ğŸ½ï¸' },
        cocina: { url: 'cocina.html', nombre: 'Pantalla de Cocina', icono: 'ğŸ‘¨â€ğŸ³' },
        cajero: { url: 'caja.html', nombre: 'Caja', icono: 'ğŸ’µ' }
      };
      
      const redirect = redireccion[rol];
      
      // Si no tiene perfil, mostrar opciÃ³n de crear perfil admin (solo primera vez)
      if (usuario.sinPerfil) {
        return `
          <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-800 to-emerald-900 p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
              <div class="text-6xl mb-4">ğŸ‘¤</div>
              <h1 class="text-2xl font-bold text-gray-800 mb-2">ConfiguraciÃ³n Inicial</h1>
              <p class="text-gray-500 mb-4">No tienes un perfil de usuario configurado.</p>
              
              <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 text-left">
                <p class="text-amber-800 font-medium text-sm">âš ï¸ Primera vez</p>
                <p class="text-amber-700 text-sm mt-1">Si eres el dueÃ±o del sistema, crea tu perfil de administrador.</p>
              </div>
              
              <div class="bg-gray-100 rounded-xl p-4 mb-6">
                <p class="text-sm text-gray-600">SesiÃ³n iniciada como:</p>
                <p class="font-bold text-gray-800">${usuario.email}</p>
              </div>
              
              <button onclick="crearPerfilAdmin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 rounded-xl mb-4">
                ğŸ‘‘ Crear mi perfil como Admin
              </button>
              
              <button onclick="cerrarSesion()" class="text-gray-500 hover:text-gray-700">
                Cerrar sesiÃ³n
              </button>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-800 to-emerald-900 p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <div class="text-6xl mb-4">ğŸ”</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Acceso Restringido</h1>
            <p class="text-gray-500 mb-4">El sistema principal es solo para administradores.</p>
            
            <div class="bg-gray-100 rounded-xl p-4 mb-6">
              <p class="text-sm text-gray-600">SesiÃ³n iniciada como:</p>
              <p class="font-bold text-gray-800">${usuario.nombre || usuario.email}</p>
              <p class="text-sm text-emerald-600">Rol: ${rol}</p>
            </div>
            
            ${redirect ? `
              <a href="${redirect.url}" class="block w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 rounded-xl mb-4 transition-colors">
                ${redirect.icono} Ir a ${redirect.nombre}
              </a>
            ` : ''}
            
            <button onclick="cerrarSesion()" class="text-gray-500 hover:text-gray-700">
              Cerrar sesiÃ³n
            </button>
          </div>
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-800 to-emerald-900 p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">ğŸŒ¿</div>
              <h1 class="text-2xl font-bold text-gray-800">Sistema Integral</h1>
              <p class="text-gray-500">JardÃ­n Escondido</p>
            </div>
            <div class="space-y-4">
              <input id="email" type="email" placeholder="Correo electrÃ³nico" class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" onkeypress="if(event.key==='Enter')document.getElementById('password').focus()" />
              <input id="password" type="password" placeholder="ContraseÃ±a" class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" onkeypress="if(event.key==='Enter')iniciarSesion()" />
              <button onclick="iniciarSesion()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 rounded-xl">Iniciar SesiÃ³n</button>
            </div>
            <p class="text-center text-sm text-gray-400 mt-6">Los usuarios son creados por el administrador</p>
          </div>
        </div>
      `;
    }

    function renderApp() {
      return `
        <div class="min-h-screen flex">
          ${renderSidebar()}
          <main class="flex-1 ${sidebarAbierto ? 'ml-72' : 'ml-20'} transition-all duration-300">
            ${renderHeader()}
            <div class="p-6">${renderContenido()}</div>
          </main>
          ${modalAbierto ? renderModal() : ''}
        </div>
      `;
    }

    function renderSidebar() {
      const colorActivo = getColor(moduloActivo);
      const ordenesActivas = ordenesRestaurante.filter(o => !['pagado', 'cancelado'].includes(o.estado)).length;

      return `
        <aside class="fixed left-0 top-0 h-full ${sidebarAbierto ? 'w-72' : 'w-20'} bg-white border-r shadow-sm transition-all duration-300 z-40 flex flex-col">
          <div class="p-4 border-b">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center text-2xl">ğŸŒ¿</div>
              ${sidebarAbierto ? `<div><h1 class="font-bold text-gray-800">Sistema Integral</h1><p class="text-xs text-gray-500">JardÃ­n Escondido</p></div>` : ''}
            </div>
          </div>
          <nav class="flex-1 p-3 space-y-1 overflow-y-auto sidebar-scroll">
            ${Object.entries(MODULOS).map(([key, mod]) => `
              <div>
                <button onclick="setModulo('${key}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${moduloActivo === key ? `bg-${mod.color}-600 text-white` : 'hover:bg-gray-100 text-gray-700'}">
                  <span class="text-xl">${mod.nombre.split(' ')[0]}</span>
                  ${sidebarAbierto ? `<span class="flex-1 text-left font-medium">${mod.nombre.split(' ').slice(1).join(' ')}</span>` : ''}
                </button>
                ${moduloActivo === key && sidebarAbierto ? `
                  <div class="ml-4 mt-1 space-y-1">
                    ${mod.secciones.map(sec => `
                      <button onclick="setSeccion('${sec.id}')" class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-all ${seccionActiva === sec.id ? `bg-${mod.color}-100 text-${mod.color}-700 font-medium` : 'text-gray-600 hover:bg-gray-50'}">
                        <span>${sec.icono}</span>
                        <span class="flex-1 text-left">${sec.nombre.split(' ').slice(1).join(' ')}</span>
                      </button>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </nav>
          <div class="p-3 border-t">
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
              <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">ğŸ‘¤</div>
              ${sidebarAbierto ? `
                <div class="flex-1">
                  <p class="font-medium text-sm text-gray-800">${usuario?.nombre || usuario?.email?.split('@')[0]}</p>
                  <p class="text-xs text-gray-500">${usuario?.rol || 'Usuario'}</p>
                </div>
                <button onclick="cerrarSesion()" class="p-2 hover:bg-gray-200 rounded-lg text-gray-500">ğŸšª</button>
              ` : ''}
            </div>
          </div>
          <button onclick="toggleSidebar()" class="absolute -right-3 top-20 w-6 h-6 bg-white border rounded-full shadow flex items-center justify-center text-gray-500 hover:bg-gray-100">${sidebarAbierto ? 'â—€' : 'â–¶'}</button>
        </aside>
      `;
    }

    function renderHeader() {
      const mod = MODULOS[moduloActivo];
      const sec = mod.secciones.find(s => s.id === seccionActiva);
      return `
        <header class="bg-white border-b px-6 py-4 flex items-center justify-between sticky top-0 z-30">
          <div>
            <h1 class="text-xl font-bold text-gray-800">${sec?.nombre || 'Dashboard'}</h1>
            <p class="text-sm text-gray-500">${mod.nombre}</p>
          </div>
          <div class="flex items-center gap-4">
            <input type="text" placeholder="Buscar..." value="${busqueda}" onchange="setBusqueda(this.value)" class="pl-4 pr-4 py-2 bg-gray-100 border-0 rounded-xl w-64 focus:ring-2 focus:ring-emerald-500 outline-none" />
            <div class="text-right">
              <p class="text-sm font-medium">${new Date().toLocaleDateString('es-MX')}</p>
            </div>
          </div>
        </header>
      `;
    }

    // ========== ROUTER DE CONTENIDO ==========
    function renderContenido() {
      const key = `${moduloActivo}-${seccionActiva}`;
      const renders = {
        'jardin-dashboard': renderJardinDashboard,
        'jardin-cotizaciones': renderCotizaciones,
        'jardin-nueva-cotizacion': renderNuevaCotizacion,
        'jardin-calendario': renderCalendario,
        'jardin-visitas': renderVisitas,
        'jardin-clientes': renderClientesJardin,
        'jardin-proveedores': renderProveedores,
        'jardin-gastos': renderGastos,
        'jardin-reportes': renderReportes,
        'jardin-config-paquetes': renderConfigPaquetes,
        'restaurante-dashboard': renderRestauranteDashboard,
        'restaurante-ordenes': renderOrdenesEnVivo,
        'restaurante-menu': renderMenu,
        'restaurante-recetas': renderRecetas,
        'restaurante-insumos': renderInsumos,
        'restaurante-lista-compras': renderListaCompras,
        'restaurante-inventario': renderInventario,
        'restaurante-catering': renderCatering,
        'restaurante-corte': renderCorte,
        'contabilidad-consolidado': renderContabilidadConsolidado,
        'contabilidad-cont-restaurante': renderContabilidadRestaurante,
        'contabilidad-cont-jardin': renderContabilidadJardin,
        'contabilidad-cont-gastos': renderContabilidadGastos,
        'personal-directorio': renderDirectorio,
        'personal-nomina': renderNomina,
        'personal-horarios': renderHorarios,
        'personal-asistencia': renderAsistencia,
        'herramientas-calculadora': renderCalculadora,
        'herramientas-config': renderConfig,
        'admin-usuarios': renderAdminUsuarios,
        'admin-ordenes-admin': renderAdminOrdenes,
        'admin-datos': renderAdminDatos
      };
      return renders[key] ? renders[key]() : '<p class="text-center text-gray-400 py-12">SecciÃ³n en desarrollo</p>';
    }

    // ========== JARDÃN - DASHBOARD ==========
    function renderJardinDashboard() {
      const eventosDelMes = cotizaciones.filter(c => c.cliente?.fechaEvento?.startsWith(filtroMes) && !['cancelado', 'no_concretado'].includes(c.estado));
      const ingresos = cotizaciones.filter(c => c.cliente?.fechaEvento?.startsWith(filtroMes) && ['liquidado', 'realizado'].includes(c.estado)).reduce((a, c) => a + (c.total || 0), 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">Dashboard - JardÃ­n Escondido</h2>
            <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-2 border rounded-lg" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-emerald-50 border border-emerald-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Eventos del mes</p>
              <p class="text-3xl font-bold text-emerald-700">${eventosDelMes.length}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Cotizaciones pendientes</p>
              <p class="text-3xl font-bold text-yellow-700">${cotizaciones.filter(c => c.estado === 'pendiente').length}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Ingresos del mes</p>
              <p class="text-3xl font-bold text-green-700">${fmt(ingresos)}</p>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Visitas programadas</p>
              <p class="text-3xl font-bold text-blue-700">${visitas.filter(v => v.estado === 'programada').length}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border p-5">
              <h3 class="font-semibold mb-4">ğŸ“… PrÃ³ximos Eventos</h3>
              <div class="space-y-2">
                ${cotizaciones.filter(c => c.cliente?.fechaEvento >= new Date().toISOString().slice(0, 10) && !['cancelado', 'no_concretado'].includes(c.estado)).slice(0, 5).map(c => `
                  <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-xl">
                    <div>
                      <p class="font-medium">${c.cliente?.nombre || 'Sin nombre'}</p>
                      <p class="text-sm text-gray-500">${fmtFecha(c.cliente?.fechaEvento)} â€¢ ${c.personas} personas</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${getEstado(c.estado).color}">${getEstado(c.estado).nombre}</span>
                  </div>
                `).join('') || '<p class="text-gray-400 text-center py-4">Sin eventos prÃ³ximos</p>'}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl border p-5">
              <h3 class="font-semibold mb-4">ğŸ“Š Resumen por Estado</h3>
              <div class="space-y-3">
                ${ESTADOS.slice(0, 5).map(e => {
                  const cantidad = cotizaciones.filter(c => c.estado === e.id).length;
                  return `
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <span>${e.icon}</span>
                        <span class="text-sm">${e.nombre}</span>
                      </div>
                      <span class="font-bold">${cantidad}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== JARDÃN - COTIZACIONES ==========
    function renderCotizaciones() {
      const filtradas = busqueda 
        ? cotizaciones.filter(c => c.cliente?.nombre?.toLowerCase().includes(busqueda.toLowerCase()) || c.folio?.includes(busqueda))
        : cotizaciones;

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold">Cotizaciones</h2>
            <button onclick="setSeccion('nueva-cotizacion')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">â• Nueva CotizaciÃ³n</button>
          </div>
          
          ${filtradas.length === 0 ? `
            <div class="bg-white rounded-2xl border p-12 text-center">
              <p class="text-4xl mb-4">ğŸ“</p>
              <p class="text-gray-600">No hay cotizaciones</p>
              <button onclick="setSeccion('nueva-cotizacion')" class="mt-4 bg-emerald-600 text-white px-6 py-2 rounded-xl">Crear primera cotizaciÃ³n</button>
            </div>
          ` : `
            <div class="bg-white rounded-2xl border overflow-hidden">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Folio</th>
                    <th class="px-4 py-3 text-left font-semibold">Cliente</th>
                    <th class="px-4 py-3 text-left font-semibold">Fecha Evento</th>
                    <th class="px-4 py-3 text-left font-semibold">Personas</th>
                    <th class="px-4 py-3 text-left font-semibold">Paquete</th>
                    <th class="px-4 py-3 text-left font-semibold">Total</th>
                    <th class="px-4 py-3 text-left font-semibold">Estado</th>
                    <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${filtradas.map(c => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3 font-medium">${c.folio || c.id.slice(-6).toUpperCase()}</td>
                      <td class="px-4 py-3">${c.cliente?.nombre || '-'}</td>
                      <td class="px-4 py-3">${fmtFecha(c.cliente?.fechaEvento)}</td>
                      <td class="px-4 py-3">${c.personas}</td>
                      <td class="px-4 py-3">${PAQUETES.find(p => p.id === c.paquete)?.nombre || c.paquete}</td>
                      <td class="px-4 py-3 font-semibold text-emerald-700">${fmt(c.total)}</td>
                      <td class="px-4 py-3"><span class="px-3 py-1 rounded-full text-xs font-medium ${getEstado(c.estado).color}">${getEstado(c.estado).nombre}</span></td>
                      <td class="px-4 py-3 text-right">
                        <button onclick="verCotizacion('${c.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg" title="Ver">ğŸ‘ï¸</button>
                        <button onclick="editarCotizacion('${c.id}')" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded-lg" title="Editar">âœï¸</button>
                        <button onclick="generarPDFCotizacion('${c.id}')" class="p-1.5 text-emerald-600 hover:bg-emerald-50 rounded-lg" title="PDF">ğŸ“„</button>
                        <button onclick="eliminarDoc('cotizaciones', '${c.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg" title="Eliminar">ğŸ—‘ï¸</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `}
        </div>
      `;
    }

    // ========== JARDÃN - NUEVA COTIZACIÃ“N ==========
    function renderNuevaCotizacion() {
      const calculos = calcularCotizacion(cotizacionActual);
      const paqueteSeleccionado = PAQUETES.find(p => p.id === cotizacionActual.paquete) || PAQUETES[0];

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">Nueva CotizaciÃ³n</h2>
              <p class="text-gray-500">Configura los detalles del evento</p>
            </div>
            <button onclick="setSeccion('cotizaciones')" class="text-gray-500 hover:text-gray-700">âœ• Cancelar</button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Formulario -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Datos del cliente -->
              <div class="bg-white rounded-2xl border p-6">
                <h3 class="font-semibold mb-4">ğŸ‘¤ Datos del Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <input type="text" placeholder="Nombre completo *" value="${cotizacionActual.cliente.nombre}" onchange="actualizarCotizacion('cliente.nombre', this.value)" class="p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
                  <input type="tel" placeholder="TelÃ©fono *" value="${cotizacionActual.cliente.telefono}" onchange="actualizarCotizacion('cliente.telefono', this.value)" class="p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
                  <input type="email" placeholder="Email" value="${cotizacionActual.cliente.email}" onchange="actualizarCotizacion('cliente.email', this.value)" class="p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
                  <input type="text" placeholder="Tipo de evento (XV aÃ±os, Boda, etc.)" value="${cotizacionActual.cliente.tipoEvento}" onchange="actualizarCotizacion('cliente.tipoEvento', this.value)" class="p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
                  <input type="date" value="${cotizacionActual.cliente.fechaEvento}" onchange="actualizarCotizacion('cliente.fechaEvento', this.value)" class="p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
                  <div class="flex items-center gap-3">
                    <label class="text-gray-600">Personas:</label>
                    <input type="number" min="25" max="300" value="${cotizacionActual.personas}" onchange="actualizarCotizacion('personas', parseInt(this.value))" class="p-3 border rounded-xl w-24 focus:ring-2 focus:ring-emerald-500 outline-none" />
                  </div>
                </div>
              </div>

              <!-- Modo de cotizaciÃ³n -->
              <div class="bg-white rounded-2xl border p-6">
                <h3 class="font-semibold mb-4">ğŸ“‹ Tipo de CotizaciÃ³n</h3>
                <div class="flex gap-4">
                  <button onclick="actualizarCotizacion('modoPersonalizado', false)" class="flex-1 p-4 border-2 rounded-xl transition-all ${!cotizacionActual.modoPersonalizado ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'}">
                    <p class="font-semibold">ğŸ“¦ Por Paquete</p>
                    <p class="text-sm text-gray-500">Usar paquetes predefinidos</p>
                  </button>
                  <button onclick="actualizarCotizacion('modoPersonalizado', true)" class="flex-1 p-4 border-2 rounded-xl transition-all ${cotizacionActual.modoPersonalizado ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'}">
                    <p class="font-semibold">âœï¸ Personalizada</p>
                    <p class="text-sm text-gray-500">Armar cotizaciÃ³n a la medida</p>
                  </button>
                </div>
              </div>

              ${cotizacionActual.modoPersonalizado ? renderCotizacionPersonalizada() : renderCotizacionPaquete()}

              <!-- Extras (comÃºn a ambos modos) -->
              <div class="bg-white rounded-2xl border p-6">
                <h3 class="font-semibold mb-4">âœ¨ Servicios Adicionales</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  ${EXTRAS.map(e => `
                    <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-gray-50">
                      <input type="checkbox" ${cotizacionActual.extras.includes(e.id) ? 'checked' : ''} onchange="toggleExtra('${e.id}')" class="w-4 h-4 text-emerald-600" />
                      <div class="flex-1">
                        <p class="text-sm font-medium">${e.nombre}</p>
                        <p class="text-xs text-emerald-600">${e.precioPP ? `${fmt(e.precioPP)}/persona` : fmt(e.precio)}</p>
                      </div>
                    </label>
                  `).join('')}
                </div>
              </div>

              <!-- Notas -->
              <div class="bg-white rounded-2xl border p-6">
                <h3 class="font-semibold mb-4">ğŸ“ Notas adicionales</h3>
                <textarea placeholder="Observaciones o requerimientos especiales..." rows="3" onchange="actualizarCotizacion('notas', this.value)" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">${cotizacionActual.notas}</textarea>
              </div>
            </div>

            <!-- Resumen -->
            <div class="lg:col-span-1">
              <div class="bg-white rounded-2xl border p-6 sticky top-24">
                <h3 class="font-semibold mb-4">ğŸ’° Resumen</h3>
                
                <div class="space-y-3 text-sm">
                  ${cotizacionActual.modoPersonalizado ? `
                    <div class="flex justify-between">
                      <span class="text-gray-600">Items/Mobiliario</span>
                      <span class="font-medium">${fmt(calculos.mobiliario)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Alimentos (${cotizacionActual.personas} Ã— ${fmt(calculos.precioPP)})</span>
                      <span class="font-medium">${fmt(calculos.alimentos)}</span>
                    </div>
                  ` : `
                    <div class="flex justify-between">
                      <span class="text-gray-600">Paquete (${paqueteSeleccionado?.nombre || 'BÃ¡sico'})</span>
                      <span class="font-medium">${fmt(calculos.mobiliario)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Alimentos (${cotizacionActual.personas} Ã— ${fmt(calculos.precioPP)})</span>
                      <span class="font-medium">${fmt(calculos.alimentos)}</span>
                    </div>
                  `}
                  ${calculos.extras > 0 ? `
                    <div class="flex justify-between">
                      <span class="text-gray-600">Extras</span>
                      <span class="font-medium">${fmt(calculos.extras)}</span>
                    </div>
                  ` : ''}
                  
                  <div class="border-t pt-3 flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span class="font-medium">${fmt(calculos.subtotal)}</span>
                  </div>

                  <div class="flex items-center gap-2">
                    <span class="text-gray-600">Descuento</span>
                    <input type="number" min="0" max="50" value="${cotizacionActual.descuento}" onchange="actualizarCotizacion('descuento', parseInt(this.value) || 0)" class="w-16 p-1 border rounded text-center" />
                    <span class="text-gray-600">%</span>
                    <span class="ml-auto text-red-600">-${fmt(calculos.descuento)}</span>
                  </div>

                  <div class="border-t pt-3 flex justify-between text-lg">
                    <span class="font-bold">TOTAL</span>
                    <span class="font-bold text-emerald-700">${fmt(calculos.total)}</span>
                  </div>

                  <div class="bg-emerald-50 rounded-xl p-3 mt-4">
                    <div class="flex justify-between text-sm">
                      <span class="text-emerald-700">Anticipo (${CONFIG_NEGOCIO.condiciones.anticipo}%)</span>
                      <span class="font-bold text-emerald-700">${fmt(calculos.anticipo)}</span>
                    </div>
                    <p class="text-xs text-emerald-600 mt-1">Resto: ${fmt(calculos.total - calculos.anticipo)} (8 dÃ­as antes)</p>
                  </div>
                </div>

                <div class="mt-6 space-y-3">
                  <button onclick="guardarCotizacion()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl">
                    ğŸ’¾ Guardar CotizaciÃ³n
                  </button>
                  <button onclick="guardarYGenerarPDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl">
                    ğŸ“„ Guardar y Generar PDF
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCotizacionPaquete() {
      return `
        <!-- SelecciÃ³n de paquete -->
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-semibold mb-4">ğŸ“¦ Seleccionar Paquete</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${PAQUETES.map(p => `
              <div onclick="actualizarCotizacion('paquete', '${p.id}')" class="p-4 border-2 rounded-xl cursor-pointer transition-all ${cotizacionActual.paquete === p.id ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'}">
                <h4 class="font-semibold">${p.nombre}</h4>
                <p class="text-sm text-gray-500 mb-2">${p.descripcion}</p>
                <ul class="text-xs text-gray-600 space-y-1">
                  ${(p.incluye || []).slice(0, 3).map(i => `<li>â€¢ ${i}</li>`).join('')}
                </ul>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Tipo de alimento -->
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-semibold mb-4">ğŸ½ï¸ Tipo de Alimento</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            ${TIPOS_ALIMENTO.slice(0, 4).map(t => `
              <div onclick="actualizarCotizacion('tipoAlimento', '${t.id}')" class="p-3 border-2 rounded-xl cursor-pointer transition-all ${cotizacionActual.tipoAlimento === t.id ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'}">
                <p class="font-medium text-sm">${t.nombre}</p>
                <p class="text-xs text-gray-500">${t.descripcion}</p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderCotizacionPersonalizada() {
      const categorias = [...new Set(ITEMS_INDIVIDUALES.map(i => i.categoria))];
      
      return `
        <!-- Items individuales -->
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-semibold mb-4">ğŸ› ï¸ Agregar Items</h3>
          
          ${categorias.map(cat => `
            <div class="mb-4">
              <p class="text-sm font-medium text-gray-500 mb-2">${cat}</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                ${ITEMS_INDIVIDUALES.filter(i => i.categoria === cat).map(item => `
                  <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                    <div class="flex-1">
                      <p class="text-sm font-medium">${item.nombre}</p>
                      <p class="text-xs text-emerald-600">${item.porPersona ? fmt(item.precio) + '/persona' : fmt(item.precio)}</p>
                    </div>
                    <button onclick="agregarItemPersonalizado('${item.id}')" class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-sm hover:bg-emerald-200">+ Agregar</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}

          <!-- Item personalizado manual -->
          <div class="border-t pt-4 mt-4">
            <p class="text-sm font-medium text-gray-500 mb-2">Agregar item personalizado</p>
            <div class="flex gap-2">
              <input type="text" id="item-custom-nombre" placeholder="DescripciÃ³n" class="flex-1 p-2 border rounded-lg text-sm" />
              <input type="number" id="item-custom-cantidad" placeholder="Cant." class="w-20 p-2 border rounded-lg text-sm" value="1" />
              <input type="number" id="item-custom-precio" placeholder="Precio" class="w-28 p-2 border rounded-lg text-sm" />
              <button onclick="agregarItemManual()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">+</button>
            </div>
          </div>
        </div>

        <!-- Items agregados -->
        ${(cotizacionActual.itemsPersonalizados || []).length > 0 ? `
          <div class="bg-white rounded-2xl border p-6">
            <h3 class="font-semibold mb-4">ğŸ“‹ Items Seleccionados</h3>
            <div class="space-y-2">
              ${cotizacionActual.itemsPersonalizados.map((item, idx) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div class="flex-1">
                    <p class="font-medium text-sm">${item.nombre}</p>
                    <p class="text-xs text-gray-500">${item.cantidad} Ã— ${fmt(item.precioUnitario)}</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <span class="font-semibold text-emerald-700">${fmt(item.subtotal)}</span>
                    <button onclick="quitarItemPersonalizado(${idx})" class="p-1 text-red-500 hover:bg-red-100 rounded">âœ•</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <!-- Alimentos personalizados -->
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-semibold mb-4">ğŸ½ï¸ Alimentos</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">DescripciÃ³n del servicio de alimentos</label>
              <input type="text" placeholder="Ej: Taquiza 5 guisados" value="${cotizacionActual.alimentoPersonalizado?.nombre || ''}" onchange="actualizarCotizacion('alimentoPersonalizado.nombre', this.value)" class="w-full p-3 border rounded-xl mt-1" />
            </div>
            <div>
              <label class="text-sm text-gray-600">Precio por persona</label>
              <input type="number" placeholder="0" value="${cotizacionActual.alimentoPersonalizado?.precioPP || ''}" onchange="actualizarCotizacion('alimentoPersonalizado.precioPP', parseFloat(this.value) || 0)" class="w-full p-3 border rounded-xl mt-1" />
            </div>
          </div>
          <p class="text-sm text-gray-500 mt-2">Total alimentos: ${cotizacionActual.personas} personas Ã— ${fmt(cotizacionActual.alimentoPersonalizado?.precioPP || 0)} = <strong>${fmt((cotizacionActual.alimentoPersonalizado?.precioPP || 0) * cotizacionActual.personas)}</strong></p>
        </div>
      `;
    }

    // ========== RESTAURANTE - DASHBOARD ==========
    function renderRestauranteDashboard() {
      const hoy = new Date().toISOString().slice(0, 10);
      const ordenesHoy = ordenesRestaurante.filter(o => {
        const fecha = o.fechaCreacion?.toDate ? o.fechaCreacion.toDate().toISOString().slice(0, 10) : '';
        return fecha === hoy;
      });
      const ventasHoy = ordenesHoy.filter(o => ['entregado', 'pagado'].includes(o.estado)).reduce((a, o) => a + (o.total || 0), 0);
      const ordenesActivas = ordenesRestaurante.filter(o => !['pagado', 'cancelado', 'entregado'].includes(o.estado));

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">ğŸ“Š Dashboard de Ventas</h2>
              <p class="text-gray-500">Monitoreo en tiempo real</p>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
              <span class="text-sm text-gray-500">En vivo</span>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Ventas de Hoy</p>
              <p class="text-3xl font-bold text-green-700">${fmt(ventasHoy)}</p>
            </div>
            <div class="bg-amber-50 border border-amber-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Tickets Hoy</p>
              <p class="text-3xl font-bold text-amber-700">${ordenesHoy.filter(o => ['entregado', 'pagado'].includes(o.estado)).length}</p>
            </div>
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5 ${ordenesActivas.length > 0 ? 'pulse-green' : ''}">
              <p class="text-sm text-gray-500">Ã“rdenes Activas</p>
              <p class="text-3xl font-bold text-red-700">${ordenesActivas.length}</p>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Productos Activos</p>
              <p class="text-3xl font-bold text-blue-700">${productos.filter(p => p.activo).length}</p>
            </div>
          </div>

          <div class="bg-white rounded-2xl border p-5">
            <h3 class="font-semibold mb-4">ğŸ• Ãšltimas Ã“rdenes</h3>
            <div class="space-y-2">
              ${ordenesRestaurante.slice(0, 8).map(o => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <div class="flex items-center gap-3">
                    <span class="font-bold">#${o.numero}</span>
                    <span class="text-gray-600">${o.mesa?.nombre}</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <span class="font-semibold">${fmt(o.total)}</span>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${getEstadoOrden(o.estado).color}">${getEstadoOrden(o.estado).nombre}</span>
                  </div>
                </div>
              `).join('') || '<p class="text-gray-400 text-center py-8">Sin Ã³rdenes recientes</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // ========== RESTAURANTE - Ã“RDENES EN VIVO ==========
    function renderOrdenesEnVivo() {
      const activas = ordenesRestaurante.filter(o => !['pagado', 'cancelado'].includes(o.estado));
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold">ğŸ”´ Ã“rdenes en Vivo</h2>
            <span class="text-sm text-gray-500">${activas.length} activas</span>
          </div>

          ${activas.length === 0 ? `
            <div class="bg-white rounded-2xl border p-12 text-center">
              <p class="text-6xl mb-4">ğŸ½ï¸</p>
              <p class="text-gray-600">Sin Ã³rdenes activas</p>
            </div>
          ` : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${activas.map(o => `
                <div class="bg-white rounded-2xl border-l-4 ${o.estado === 'listo' ? 'border-green-500 ring-2 ring-green-500' : o.estado === 'preparando' ? 'border-blue-500' : 'border-yellow-500'} p-5">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <p class="text-2xl font-bold">#${o.numero}</p>
                      <p class="text-amber-600 font-medium">${o.mesa?.nombre}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${getEstadoOrden(o.estado).color}">${getEstadoOrden(o.estado).nombre}</span>
                  </div>
                  <div class="space-y-1 text-sm mb-3">
                    ${o.items?.slice(0, 4).map(i => `<div>${i.cantidad}x ${i.nombre}</div>`).join('')}
                  </div>
                  <div class="flex justify-between items-center pt-3 border-t">
                    <span class="text-sm text-gray-500">${tiempoTranscurrido(o.fechaCreacion)}</span>
                    <span class="font-bold text-amber-700">${fmt(o.total)}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    // ========== RESTAURANTE - MENÃš/PRODUCTOS ==========
    function renderMenu() {
      const categorias = [...new Set(productos.map(p => p.categoria))];

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold">â˜• MenÃº / Productos</h2>
            <button onclick="abrirModal('producto')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">â• Nuevo Producto</button>
          </div>

          ${categorias.map(cat => `
            <div class="bg-white rounded-2xl border p-5">
              <h3 class="font-semibold mb-4">${cat}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${productos.filter(p => p.categoria === cat).map(p => {
                  const receta = recetas.find(r => r.productoId === p.id);
                  const costoReceta = receta ? calcularCostoReceta(receta) : p.costo;
                  const margen = p.precio > 0 ? ((p.precio - costoReceta) / p.precio * 100).toFixed(1) : 0;
                  return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                      <div>
                        <p class="font-medium">${p.nombre}</p>
                        <p class="text-sm text-gray-500">Costo: ${fmt(costoReceta)} â€¢ Precio: ${fmt(p.precio)}</p>
                        <p class="text-xs ${margen >= 50 ? 'text-green-600' : margen >= 30 ? 'text-amber-600' : 'text-red-600'}">Margen: ${margen}%</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded text-xs ${p.activo ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${p.activo ? 'Activo' : 'Inactivo'}</span>
                        <button onclick="abrirModal('producto', ${JSON.stringify(p).replace(/"/g, '&quot;')})" class="p-1 text-amber-600 hover:bg-amber-100 rounded">âœï¸</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ========== RESTAURANTE - INSUMOS/INGREDIENTES ==========
    function renderInsumos() {
      const categoriaFiltro = window.categoriaInsumoFiltro || 'Todos';
      const insumosFiltrados = categoriaFiltro === 'Todos' 
        ? insumos 
        : insumos.filter(i => i.categoria === categoriaFiltro);

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">ğŸ¥¬ Insumos / Ingredientes</h2>
              <p class="text-gray-500">Gestiona tus ingredientes y sus costos</p>
            </div>
            <button onclick="abrirModal('insumo')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">â• Nuevo Insumo</button>
          </div>

          <!-- Filtro por categorÃ­a -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="filtrarInsumos('Todos')" class="px-4 py-2 rounded-xl text-sm font-medium ${categoriaFiltro === 'Todos' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">Todos</button>
            ${CATEGORIAS_INSUMOS.map(cat => `
              <button onclick="filtrarInsumos('${cat}')" class="px-4 py-2 rounded-xl text-sm font-medium ${categoriaFiltro === cat ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">${cat}</button>
            `).join('')}
          </div>

          <!-- Tabla de insumos -->
          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Insumo</th>
                  <th class="px-4 py-3 text-left font-semibold">CategorÃ­a</th>
                  <th class="px-4 py-3 text-left font-semibold">Unidad Compra</th>
                  <th class="px-4 py-3 text-left font-semibold">Precio</th>
                  <th class="px-4 py-3 text-left font-semibold">Unidad Uso</th>
                  <th class="px-4 py-3 text-left font-semibold">Costo/Unidad</th>
                  <th class="px-4 py-3 text-left font-semibold">Stock</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${insumosFiltrados.map(ins => {
                  const costoUnidad = ins.equivalencia > 0 ? (ins.precioCompra / ins.equivalencia) : 0;
                  const stockBajo = ins.stockActual <= ins.stockMinimo;
                  return `
                    <tr class="${stockBajo ? 'bg-red-50' : ''}">
                      <td class="px-4 py-3 font-medium">${ins.nombre}</td>
                      <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${ins.categoria}</span></td>
                      <td class="px-4 py-3">${ins.unidadCompra}</td>
                      <td class="px-4 py-3 font-semibold text-amber-700">${fmt(ins.precioCompra)}</td>
                      <td class="px-4 py-3">${ins.unidadUso}</td>
                      <td class="px-4 py-3 text-green-700">${fmt(costoUnidad)}/${ins.unidadUso}</td>
                      <td class="px-4 py-3">
                        <span class="${stockBajo ? 'text-red-600 font-bold' : ''}">${ins.stockActual} ${ins.unidadCompra}</span>
                        ${stockBajo ? '<span class="ml-1 text-red-500">âš ï¸</span>' : ''}
                      </td>
                      <td class="px-4 py-3 text-right">
                        <button onclick="abrirModal('insumo', ${JSON.stringify(ins).replace(/"/g, '&quot;')})" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded-lg">âœï¸</button>
                        <button onclick="eliminarDoc('insumos', '${ins.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <!-- Resumen -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-amber-50 border border-amber-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Total Insumos</p>
              <p class="text-3xl font-bold text-amber-700">${insumos.length}</p>
            </div>
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Stock Bajo</p>
              <p class="text-3xl font-bold text-red-700">${insumos.filter(i => i.stockActual <= i.stockMinimo).length}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Valor en Inventario</p>
              <p class="text-3xl font-bold text-green-700">${fmt(insumos.reduce((sum, i) => sum + (i.stockActual * i.precioCompra), 0))}</p>
            </div>
          </div>
        </div>
      `;
    }

    // ========== RESTAURANTE - RECETAS Y COSTOS ==========
    function renderRecetas() {
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">ğŸ“– Recetas y Costos</h2>
              <p class="text-gray-500">Calcula el costo real de cada platillo</p>
            </div>
            <button onclick="abrirModal('receta')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">â• Nueva Receta</button>
          </div>

          <!-- Lista de Recetas -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            ${recetas.length === 0 ? `
              <div class="col-span-2 bg-white rounded-2xl border p-12 text-center">
                <p class="text-4xl mb-4">ğŸ“–</p>
                <p class="text-gray-600 mb-4">No hay recetas registradas</p>
                <button onclick="abrirModal('receta')" class="bg-amber-600 text-white px-6 py-2 rounded-xl">Crear primera receta</button>
              </div>
            ` : recetas.map(receta => {
              const producto = productos.find(p => p.id === receta.productoId);
              const costoTotal = calcularCostoReceta(receta);
              const precioVenta = producto?.precio || 0;
              const margen = precioVenta > 0 ? ((precioVenta - costoTotal) / precioVenta * 100).toFixed(1) : 0;
              const utilidad = precioVenta - costoTotal;
              
              return `
                <div class="bg-white rounded-2xl border overflow-hidden">
                  <div class="p-5 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                    <div class="flex justify-between items-start">
                      <div>
                        <h3 class="text-lg font-bold">${receta.nombre}</h3>
                        <p class="text-amber-100 text-sm">${producto?.nombre || 'Sin producto vinculado'}</p>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="abrirModal('receta', ${JSON.stringify(receta).replace(/"/g, '&quot;')})" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg">âœï¸</button>
                        <button onclick="eliminarDoc('recetas', '${receta.id}')" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg">ğŸ—‘ï¸</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="p-5">
                    <p class="text-sm font-medium text-gray-500 mb-3">Ingredientes (${receta.porciones || 1} porciÃ³n${receta.porciones > 1 ? 'es' : ''}):</p>
                    <div class="space-y-2 mb-4 max-h-48 overflow-y-auto">
                      ${(receta.ingredientes || []).map(ing => {
                        const insumo = insumos.find(i => i.id === ing.insumoId);
                        const costoIng = insumo ? (insumo.precioCompra / insumo.equivalencia) * ing.cantidad : 0;
                        return `
                          <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                            <span>${insumo?.nombre || 'Insumo no encontrado'}</span>
                            <div class="text-right">
                              <span class="text-gray-500">${ing.cantidad} ${insumo?.unidadUso || ''}</span>
                              <span class="ml-2 font-medium text-amber-700">${fmt(costoIng)}</span>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                    
                    <div class="border-t pt-4 space-y-2">
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Costo ingredientes:</span>
                        <span class="font-semibold text-red-600">${fmt(costoTotal)}</span>
                      </div>
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Precio venta:</span>
                        <span class="font-semibold">${fmt(precioVenta)}</span>
                      </div>
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Utilidad:</span>
                        <span class="font-semibold text-green-600">${fmt(utilidad)}</span>
                      </div>
                      <div class="flex justify-between items-center pt-2 border-t">
                        <span class="font-medium">Margen:</span>
                        <span class="px-3 py-1 rounded-full font-bold ${margen >= 50 ? 'bg-green-100 text-green-700' : margen >= 30 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${margen}%</span>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- Productos sin receta -->
          ${productos.filter(p => p.activo && !recetas.find(r => r.productoId === p.id)).length > 0 ? `
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-5">
              <h4 class="font-semibold text-amber-800 mb-3">âš ï¸ Productos sin receta</h4>
              <div class="flex flex-wrap gap-2">
                ${productos.filter(p => p.activo && !recetas.find(r => r.productoId === p.id)).map(p => `
                  <span class="px-3 py-1 bg-white rounded-lg text-sm">${p.nombre}</span>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // FunciÃ³n para calcular costo de una receta
    function calcularCostoReceta(receta) {
      let total = 0;
      (receta.ingredientes || []).forEach(ing => {
        const insumo = insumos.find(i => i.id === ing.insumoId);
        if (insumo && insumo.equivalencia > 0) {
          total += (insumo.precioCompra / insumo.equivalencia) * ing.cantidad;
        }
      });
      return total / (receta.porciones || 1);
    }

    // ========== RESTAURANTE - LISTA DE COMPRAS ==========
    function renderListaCompras() {
      // Calcular items con stock bajo
      const itemsStockBajo = insumos.filter(i => i.stockActual <= i.stockMinimo).map(ins => ({
        ...ins,
        cantidadSugerida: Math.max(ins.stockMinimo * 2 - ins.stockActual, 1),
        costoEstimado: (Math.max(ins.stockMinimo * 2 - ins.stockActual, 1)) * ins.precioCompra
      }));

      const totalEstimado = itemsStockBajo.reduce((sum, i) => sum + i.costoEstimado, 0);

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">ğŸ›’ Lista de Compras</h2>
              <p class="text-gray-500">Basada en stock mÃ­nimo de insumos</p>
            </div>
            <div class="flex gap-2">
              <button onclick="generarListaComprasPDF()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">ğŸ“„ Exportar PDF</button>
              <button onclick="agregarItemListaCompras()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 font-medium">â• Agregar Item</button>
            </div>
          </div>

          <!-- Resumen -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Items por comprar</p>
              <p class="text-3xl font-bold text-red-700">${itemsStockBajo.length}</p>
            </div>
            <div class="bg-amber-50 border border-amber-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Costo Estimado</p>
              <p class="text-3xl font-bold text-amber-700">${fmt(totalEstimado)}</p>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Proveedores</p>
              <p class="text-3xl font-bold text-blue-700">${new Set(itemsStockBajo.map(i => i.proveedor).filter(Boolean)).size || '-'}</p>
            </div>
          </div>

          ${itemsStockBajo.length === 0 ? `
            <div class="bg-green-50 border border-green-200 rounded-2xl p-8 text-center">
              <p class="text-4xl mb-4">âœ…</p>
              <p class="text-green-700 font-medium">Â¡Todos los insumos tienen stock suficiente!</p>
            </div>
          ` : `
            <!-- Lista automÃ¡tica por stock bajo -->
            <div class="bg-white rounded-2xl border overflow-hidden">
              <div class="p-4 bg-red-50 border-b">
                <h3 class="font-semibold text-red-800">âš ï¸ Insumos con stock bajo (automÃ¡tico)</h3>
              </div>
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left">
                      <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" class="w-4 h-4" />
                    </th>
                    <th class="px-4 py-3 text-left font-semibold">Insumo</th>
                    <th class="px-4 py-3 text-left font-semibold">CategorÃ­a</th>
                    <th class="px-4 py-3 text-left font-semibold">Stock Actual</th>
                    <th class="px-4 py-3 text-left font-semibold">Stock MÃ­nimo</th>
                    <th class="px-4 py-3 text-left font-semibold">Cantidad a Comprar</th>
                    <th class="px-4 py-3 text-left font-semibold">Precio Unit.</th>
                    <th class="px-4 py-3 text-left font-semibold">Subtotal</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${itemsStockBajo.map((ins, idx) => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3">
                        <input type="checkbox" class="item-compra w-4 h-4" data-id="${ins.id}" checked />
                      </td>
                      <td class="px-4 py-3 font-medium">${ins.nombre}</td>
                      <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${ins.categoria}</span></td>
                      <td class="px-4 py-3 text-red-600 font-bold">${ins.stockActual} ${ins.unidadCompra}</td>
                      <td class="px-4 py-3">${ins.stockMinimo} ${ins.unidadCompra}</td>
                      <td class="px-4 py-3">
                        <input type="number" value="${ins.cantidadSugerida}" min="1" 
                          onchange="actualizarCantidadCompra('${ins.id}', this.value)"
                          class="w-20 p-1 border rounded text-center" /> ${ins.unidadCompra}
                      </td>
                      <td class="px-4 py-3">${fmt(ins.precioCompra)}</td>
                      <td class="px-4 py-3 font-semibold text-amber-700">${fmt(ins.costoEstimado)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot class="bg-amber-50">
                  <tr>
                    <td colspan="7" class="px-4 py-3 text-right font-bold">TOTAL ESTIMADO:</td>
                    <td class="px-4 py-3 font-bold text-xl text-amber-700">${fmt(totalEstimado)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `}

          <!-- Lista manual adicional -->
          <div class="bg-white rounded-2xl border p-5">
            <h3 class="font-semibold mb-4">ğŸ“ Items adicionales (manual)</h3>
            <div class="flex gap-2 mb-4">
              <input type="text" id="item-manual-nombre" placeholder="Nombre del item" class="flex-1 p-2 border rounded-lg" />
              <input type="number" id="item-manual-cantidad" placeholder="Cantidad" class="w-24 p-2 border rounded-lg" />
              <select id="item-manual-unidad" class="p-2 border rounded-lg">
                ${UNIDADES.map(u => `<option value="${u.id}">${u.nombre} (${u.abrev})</option>`).join('')}
              </select>
              <button onclick="agregarItemManualLista()" class="px-4 py-2 bg-amber-600 text-white rounded-lg">+</button>
            </div>
            <div id="items-manuales" class="space-y-2">
              ${(listaCompras || []).map((item, idx) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <span>${item.nombre}</span>
                  <div class="flex items-center gap-2">
                    <span>${item.cantidad} ${item.unidad}</span>
                    <button onclick="quitarItemManualLista(${idx})" class="text-red-500">âœ•</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ========== CALENDARIO DE EVENTOS ==========
    function renderCalendario() {
      const hoy = new Date();
      const mesCalendario = window.mesCalendario || filtroMes;
      const [anio, mes] = mesCalendario.split('-').map(Number);
      
      const primerDia = new Date(anio, mes - 1, 1);
      const ultimoDia = new Date(anio, mes, 0);
      const diasEnMes = ultimoDia.getDate();
      const primerDiaSemana = primerDia.getDay();
      
      const eventosDelMes = cotizaciones.filter(c => 
        c.cliente?.fechaEvento?.startsWith(mesCalendario) && 
        !['cancelado', 'no_concretado'].includes(c.estado)
      );
      
      const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      let dias = [];
      for (let i = 0; i < primerDiaSemana; i++) dias.push(null);
      for (let d = 1; d <= diasEnMes; d++) dias.push(d);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“… Calendario de Eventos</h2>
            <div class="flex items-center gap-3">
              <button onclick="cambiarMesCalendario(-1)" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg">â—€</button>
              <span class="font-semibold text-lg min-w-[150px] text-center">${nombresMeses[mes - 1]} ${anio}</span>
              <button onclick="cambiarMesCalendario(1)" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg">â–¶</button>
            </div>
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <div class="grid grid-cols-7 bg-emerald-600 text-white">
              ${['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'].map(d => `<div class="p-3 text-center font-semibold text-sm">${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7">
              ${dias.map((dia, idx) => {
                if (!dia) return `<div class="p-2 bg-gray-50 min-h-[100px]"></div>`;
                const fechaStr = `${anio}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const eventosDelDia = eventosDelMes.filter(c => c.cliente?.fechaEvento === fechaStr);
                const esHoy = fechaStr === hoy.toISOString().slice(0, 10);
                return `
                  <div class="p-2 border-t border-l min-h-[100px] ${esHoy ? 'bg-emerald-50' : ''}">
                    <div class="font-semibold text-sm ${esHoy ? 'text-emerald-600' : 'text-gray-700'}">${dia}</div>
                    <div class="space-y-1 mt-1">
                      ${eventosDelDia.map(e => `
                        <div onclick="verCotizacion('${e.id}')" class="text-xs p-1 rounded cursor-pointer truncate ${
                          e.estado === 'confirmado' ? 'bg-blue-100 text-blue-800' :
                          e.estado === 'anticipo' ? 'bg-purple-100 text-purple-800' :
                          e.estado === 'liquidado' || e.estado === 'realizado' ? 'bg-green-100 text-green-800' :
                          'bg-yellow-100 text-yellow-800'
                        }">
                          ${e.cliente?.nombre?.split(' ')[0] || 'Evento'} (${e.personas}p)
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border p-5">
              <h3 class="font-semibold mb-4">ğŸ“‹ Eventos del Mes (${eventosDelMes.length})</h3>
              <div class="space-y-2 max-h-[300px] overflow-y-auto">
                ${eventosDelMes.length > 0 ? eventosDelMes.sort((a, b) => a.cliente?.fechaEvento?.localeCompare(b.cliente?.fechaEvento)).map(e => `
                  <div onclick="verCotizacion('${e.id}')" class="flex justify-between items-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                    <div>
                      <p class="font-medium">${e.cliente?.nombre || 'Sin nombre'}</p>
                      <p class="text-sm text-gray-500">${fmtFecha(e.cliente?.fechaEvento)} â€¢ ${e.personas} personas</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getEstado(e.estado).color}">${getEstado(e.estado).nombre}</span>
                  </div>
                `).join('') : '<p class="text-gray-400 text-center py-4">Sin eventos este mes</p>'}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl border p-5">
              <h3 class="font-semibold mb-4">ğŸ¨ Leyenda de Estados</h3>
              <div class="grid grid-cols-2 gap-3">
                ${ESTADOS.slice(0, 6).map(e => `
                  <div class="flex items-center gap-2">
                    <span class="w-4 h-4 rounded ${e.color.replace('text-', 'bg-').split(' ')[0]}"></span>
                    <span class="text-sm">${e.nombre}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.cambiarMesCalendario = (delta) => {
      const [anio, mes] = (window.mesCalendario || filtroMes).split('-').map(Number);
      const nuevaFecha = new Date(anio, mes - 1 + delta, 1);
      window.mesCalendario = nuevaFecha.toISOString().slice(0, 7);
      render();
    };

    // ========== AGENDA DE VISITAS ==========
    function renderVisitas() {
      const visitasFiltradas = visitas.filter(v => {
        if (!window.filtroVisitas || window.filtroVisitas === 'todas') return true;
        return v.estado === window.filtroVisitas;
      }).sort((a, b) => (a.fecha || '').localeCompare(b.fecha || ''));
      
      const hoy = new Date().toISOString().slice(0, 10);
      const visitasHoy = visitas.filter(v => v.fecha === hoy && v.estado !== 'completada');
      const visitasPendientes = visitas.filter(v => v.estado === 'programada' && v.fecha >= hoy);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ—“ï¸ Agenda de Visitas</h2>
              <p class="text-gray-500">Programa visitas al jardÃ­n para clientes interesados</p>
            </div>
            <button onclick="abrirModal('visita')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl font-medium">
              â• Nueva Visita
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Visitas Hoy</p>
              <p class="text-3xl font-bold text-blue-700">${visitasHoy.length}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Pendientes</p>
              <p class="text-3xl font-bold text-yellow-700">${visitasPendientes.length}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Completadas (mes)</p>
              <p class="text-3xl font-bold text-green-700">${visitas.filter(v => v.estado === 'completada' && v.fecha?.startsWith(filtroMes)).length}</p>
            </div>
          </div>

          <div class="flex gap-2 flex-wrap">
            ${[{id: 'todas', nombre: 'Todas'}, {id: 'programada', nombre: 'ğŸ“… Programadas'}, {id: 'completada', nombre: 'âœ… Completadas'}, {id: 'cancelada', nombre: 'âŒ Canceladas'}].map(f => `
              <button onclick="window.filtroVisitas = '${f.id}'; render()" class="px-4 py-2 rounded-xl font-medium ${(!window.filtroVisitas && f.id === 'todas') || window.filtroVisitas === f.id ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">${f.nombre}</button>
            `).join('')}
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Fecha y Hora</th>
                  <th class="px-4 py-3 text-left font-semibold">Cliente</th>
                  <th class="px-4 py-3 text-left font-semibold">TelÃ©fono</th>
                  <th class="px-4 py-3 text-left font-semibold">Tipo de Evento</th>
                  <th class="px-4 py-3 text-left font-semibold">Estado</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${visitasFiltradas.length === 0 ? `
                  <tr><td colspan="6" class="px-4 py-12 text-center text-gray-400">No hay visitas registradas</td></tr>
                ` : visitasFiltradas.map(v => `
                  <tr class="hover:bg-gray-50 ${v.fecha === hoy ? 'bg-blue-50' : ''}">
                    <td class="px-4 py-3">
                      <p class="font-medium">${fmtFecha(v.fecha)}</p>
                      <p class="text-sm text-gray-500">${v.hora || '--:--'}</p>
                    </td>
                    <td class="px-4 py-3 font-medium">${v.cliente || '-'}</td>
                    <td class="px-4 py-3">${v.telefono || '-'}</td>
                    <td class="px-4 py-3">${v.tipoEvento || '-'}</td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded-full text-xs font-medium ${
                        v.estado === 'programada' ? 'bg-blue-100 text-blue-800' :
                        v.estado === 'completada' ? 'bg-green-100 text-green-800' :
                        'bg-red-100 text-red-800'
                      }">${v.estado || 'programada'}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <div class="flex justify-end gap-1">
                        ${v.estado === 'programada' ? `
                          <button onclick="completarVisita('${v.id}')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg" title="Completar">âœ…</button>
                          <button onclick="cancelarVisita('${v.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Cancelar">âŒ</button>
                        ` : ''}
                        <button onclick="editarVisita('${v.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Editar">âœï¸</button>
                        <button onclick="eliminarVisita('${v.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Eliminar">ğŸ—‘ï¸</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== BASE DE CLIENTES ==========
    function renderClientesJardin() {
      const clientesFiltrados = clientesJardin.filter(c => 
        !busqueda || 
        c.nombre?.toLowerCase().includes(busqueda.toLowerCase()) ||
        c.email?.toLowerCase().includes(busqueda.toLowerCase()) ||
        c.telefono?.includes(busqueda)
      ).sort((a, b) => (b.fechaCreacion || '').localeCompare(a.fechaCreacion || ''));
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¥ Base de Clientes</h2>
              <p class="text-gray-500">Gestiona tu cartera de clientes del jardÃ­n</p>
            </div>
            <button onclick="abrirModal('cliente')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl font-medium">
              â• Nuevo Cliente
            </button>
          </div>

          <div class="flex gap-4 items-center">
            <div class="flex-1 relative">
              <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
              <input type="text" placeholder="Buscar por nombre, email o telÃ©fono..." value="${busqueda}" 
                onkeyup="setBusqueda(this.value)" class="w-full pl-10 p-3 border rounded-xl" />
            </div>
            <div class="text-gray-500">${clientesFiltrados.length} clientes</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${clientesFiltrados.length === 0 ? `
              <div class="col-span-full bg-white rounded-2xl border p-12 text-center">
                <p class="text-4xl mb-4">ğŸ‘¥</p>
                <p class="text-gray-500">No hay clientes registrados</p>
              </div>
            ` : clientesFiltrados.map(c => `
              <div class="bg-white rounded-2xl border p-5 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="font-bold text-lg">${c.nombre || 'Sin nombre'}</h3>
                    <p class="text-sm text-gray-500">${c.tipoEvento || 'Sin tipo'}</p>
                  </div>
                  <div class="flex gap-1">
                    <button onclick="editarCliente('${c.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                    <button onclick="eliminarCliente('${c.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                  </div>
                </div>
                <div class="space-y-2 text-sm">
                  ${c.telefono ? `<p class="flex items-center gap-2"><span>ğŸ“±</span>${c.telefono}</p>` : ''}
                  ${c.email ? `<p class="flex items-center gap-2"><span>ğŸ“§</span>${c.email}</p>` : ''}
                  ${c.fechaEvento ? `<p class="flex items-center gap-2"><span>ğŸ“…</span>${fmtFecha(c.fechaEvento)}</p>` : ''}
                  ${c.personas ? `<p class="flex items-center gap-2"><span>ğŸ‘¥</span>${c.personas} personas</p>` : ''}
                </div>
                ${c.notas ? `<p class="mt-3 text-xs text-gray-500 bg-gray-50 p-2 rounded-lg">${c.notas}</p>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // ========== BASE DE PROVEEDORES ==========
    function renderProveedores() {
      const categorias = ['Mobiliario', 'Carpas', 'Catering', 'DecoraciÃ³n', 'Audio/IluminaciÃ³n', 'FotografÃ­a', 'Flores', 'Transporte', 'Otros'];
      const categoriaFiltro = window.categoriaProveedores || 'todas';
      
      const proveedoresFiltrados = proveedores.filter(p => 
        (categoriaFiltro === 'todas' || p.categoria === categoriaFiltro) &&
        (!busqueda || p.nombre?.toLowerCase().includes(busqueda.toLowerCase()))
      );
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“ Proveedores</h2>
              <p class="text-gray-500">Directorio de proveedores para eventos</p>
            </div>
            <button onclick="abrirModal('proveedor')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl font-medium">
              â• Nuevo Proveedor
            </button>
          </div>

          <div class="flex flex-wrap gap-2">
            <button onclick="window.categoriaProveedores = 'todas'; render()" class="px-4 py-2 rounded-xl font-medium ${categoriaFiltro === 'todas' ? 'bg-emerald-600 text-white' : 'bg-gray-100'}">Todos</button>
            ${categorias.map(cat => `
              <button onclick="window.categoriaProveedores = '${cat}'; render()" class="px-4 py-2 rounded-xl font-medium ${categoriaFiltro === cat ? 'bg-emerald-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}">${cat}</button>
            `).join('')}
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Proveedor</th>
                  <th class="px-4 py-3 text-left font-semibold">CategorÃ­a</th>
                  <th class="px-4 py-3 text-left font-semibold">Contacto</th>
                  <th class="px-4 py-3 text-left font-semibold">TelÃ©fono</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${proveedoresFiltrados.length === 0 ? `
                  <tr><td colspan="5" class="px-4 py-12 text-center text-gray-400">No hay proveedores registrados</td></tr>
                ` : proveedoresFiltrados.map(p => `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <p class="font-medium">${p.nombre || '-'}</p>
                      ${p.email ? `<p class="text-sm text-gray-500">${p.email}</p>` : ''}
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-medium">${p.categoria || '-'}</span></td>
                    <td class="px-4 py-3">${p.contacto || '-'}</td>
                    <td class="px-4 py-3">${p.telefono || '-'}</td>
                    <td class="px-4 py-3 text-right">
                      <button onclick="editarProveedor('${p.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                      <button onclick="eliminarProveedor('${p.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== GASTOS (REDIRIGE A CONTABILIDAD) ==========
    function renderGastos() {
      return renderContabilidadGastos();
    }

    // ========== REPORTES Y KPIs ==========
    function renderReportes() {
      const kpisRest = calcularKPIsRestaurante();
      const kpisJardin = calcularKPIsJardin();
      
      // Datos histÃ³ricos (Ãºltimos 6 meses)
      const ultimosMeses = [];
      for (let i = 5; i >= 0; i--) {
        const fecha = new Date();
        fecha.setMonth(fecha.getMonth() - i);
        ultimosMeses.push(fecha.toISOString().slice(0, 7));
      }
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“ˆ Reportes y KPIs</h2>
              <p class="text-gray-500">AnÃ¡lisis de rendimiento del negocio</p>
            </div>
            <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-3 border rounded-xl" />
          </div>

          <!-- KPIs Principales -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-5 text-white">
              <p class="text-emerald-100 text-sm">Ingresos Totales</p>
              <p class="text-3xl font-bold mt-2">${fmt(kpisRest.ventasBrutas + kpisJardin.ingresosBrutos)}</p>
              <p class="text-emerald-200 text-xs mt-1">Restaurante + JardÃ­n</p>
            </div>
            <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white">
              <p class="text-amber-100 text-sm">Ventas Restaurante</p>
              <p class="text-3xl font-bold mt-2">${fmt(kpisRest.ventasBrutas)}</p>
              <p class="text-amber-200 text-xs mt-1">${kpisRest.totalOrdenes} Ã³rdenes</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
              <p class="text-green-100 text-sm">Ingresos JardÃ­n</p>
              <p class="text-3xl font-bold mt-2">${fmt(kpisJardin.ingresosBrutos)}</p>
              <p class="text-green-200 text-xs mt-1">${kpisJardin.eventosRealizados} eventos</p>
            </div>
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white">
              <p class="text-indigo-100 text-sm">Utilidad Total</p>
              <p class="text-3xl font-bold mt-2">${fmt(kpisRest.utilidadNeta + kpisJardin.utilidadNeta)}</p>
              <p class="text-indigo-200 text-xs mt-1">DespuÃ©s de gastos</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- KPIs Restaurante -->
            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ½ï¸ KPIs Restaurante</h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-amber-50 rounded-xl">
                  <span class="text-gray-700">Ticket Promedio</span>
                  <span class="font-bold text-amber-700">${fmt(kpisRest.ticketPromedio)}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-xl">
                  <span class="text-gray-700">Margen Bruto</span>
                  <span class="font-bold text-green-700">${kpisRest.margenBruto.toFixed(1)}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                  <span class="text-gray-700">Margen Neto</span>
                  <span class="font-bold ${kpisRest.margenNeto >= 0 ? 'text-blue-700' : 'text-red-700'}">${kpisRest.margenNeto.toFixed(1)}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-xl">
                  <span class="text-gray-700">Costo de Ventas</span>
                  <span class="font-bold text-purple-700">${fmt(kpisRest.costoVentas)}</span>
                </div>
              </div>
            </div>

            <!-- KPIs JardÃ­n -->
            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸŒ¿ KPIs JardÃ­n</h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-xl">
                  <span class="text-gray-700">Ingreso Promedio/Evento</span>
                  <span class="font-bold text-emerald-700">${fmt(kpisJardin.ingresoPromedio)}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                  <span class="text-gray-700">Tasa de ConversiÃ³n</span>
                  <span class="font-bold text-blue-700">${kpisJardin.tasaConversion.toFixed(1)}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-xl">
                  <span class="text-gray-700">Margen Neto</span>
                  <span class="font-bold ${kpisJardin.margenNeto >= 0 ? 'text-green-700' : 'text-red-700'}">${kpisJardin.margenNeto.toFixed(1)}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-xl">
                  <span class="text-gray-700">Cotizaciones del Mes</span>
                  <span class="font-bold text-yellow-700">${kpisJardin.cotizacionesMes}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Productos mÃ¡s vendidos -->
          <div class="bg-white rounded-2xl border p-6">
            <h3 class="font-semibold text-lg mb-4">ğŸ† Productos MÃ¡s Vendidos del Mes</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
              ${kpisRest.topProductos.length > 0 ? kpisRest.topProductos.map((p, i) => `
                <div class="text-center p-4 bg-gray-50 rounded-xl">
                  <span class="text-3xl">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…'}</span>
                  <p class="font-medium mt-2">${p.producto?.nombre || 'Producto'}</p>
                  <p class="text-amber-600 font-bold">${p.cantidad} vendidos</p>
                </div>
              `).join('') : '<p class="col-span-full text-center text-gray-400 py-4">Sin datos de ventas</p>'}
            </div>
          </div>
        </div>
      `;
    }
    function renderConfigPaquetes() { 
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">âš™ï¸ ConfiguraciÃ³n de Paquetes y Precios</h2>
              <p class="text-gray-500">Modifica los paquetes, precios y servicios</p>
            </div>
          </div>

          <!-- Tabs -->
          <div class="flex gap-2 border-b">
            <button onclick="setConfigTab('paquetes')" class="px-4 py-2 font-medium ${!window.configTab || window.configTab === 'paquetes' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}">ğŸ“¦ Paquetes</button>
            <button onclick="setConfigTab('extras')" class="px-4 py-2 font-medium ${window.configTab === 'extras' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}">âœ¨ Extras</button>
            <button onclick="setConfigTab('items')" class="px-4 py-2 font-medium ${window.configTab === 'items' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}">ğŸ› ï¸ Items Individuales</button>
            <button onclick="setConfigTab('alimentos')" class="px-4 py-2 font-medium ${window.configTab === 'alimentos' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}">ğŸ½ï¸ Alimentos</button>
          </div>

          ${!window.configTab || window.configTab === 'paquetes' ? renderConfigPaquetesTab() : ''}
          ${window.configTab === 'extras' ? renderConfigExtrasTab() : ''}
          ${window.configTab === 'items' ? renderConfigItemsTab() : ''}
          ${window.configTab === 'alimentos' ? renderConfigAlimentosTab() : ''}
        </div>
      `;
    }

    window.setConfigTab = (tab) => { window.configTab = tab; render(); };

    function renderConfigPaquetesTab() {
      return `
        <div class="space-y-4">
          ${PAQUETES.map((p, idx) => `
            <div class="bg-white rounded-2xl border p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <input type="text" value="${p.nombre}" onchange="actualizarPaquete(${idx}, 'nombre', this.value)" class="text-lg font-bold border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none" />
                  <input type="text" value="${p.descripcion}" onchange="actualizarPaquete(${idx}, 'descripcion', this.value)" class="block text-sm text-gray-500 border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none w-full mt-1" />
                </div>
                <button onclick="eliminarPaquete(${idx})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg">ğŸ—‘ï¸</button>
              </div>
              
              <div class="mb-4">
                <p class="text-sm font-medium text-gray-600 mb-2">Incluye:</p>
                <div class="space-y-1">
                  ${(p.incluye || []).map((item, iIdx) => `
                    <div class="flex items-center gap-2">
                      <span class="text-gray-400">â€¢</span>
                      <input type="text" value="${item}" onchange="actualizarPaqueteIncluye(${idx}, ${iIdx}, this.value)" class="flex-1 text-sm border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none" />
                      <button onclick="quitarPaqueteIncluye(${idx}, ${iIdx})" class="text-red-400 hover:text-red-600">âœ•</button>
                    </div>
                  `).join('')}
                  <button onclick="agregarPaqueteIncluye(${idx})" class="text-sm text-emerald-600 hover:text-emerald-700">+ Agregar item</button>
                </div>
              </div>

              <div>
                <p class="text-sm font-medium text-gray-600 mb-2">Precios por nÃºmero de personas:</p>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                  ${Object.entries(p.precios || {}).map(([personas, precios]) => `
                    <div class="bg-gray-50 rounded-lg p-2 text-xs">
                      <p class="font-bold text-center mb-1">${personas} pers.</p>
                      <div class="space-y-1">
                        <div class="flex justify-between">
                          <span>Mob:</span>
                          <input type="number" value="${precios.mobiliario}" onchange="actualizarPaquetePrecio(${idx}, '${personas}', 'mobiliario', this.value)" class="w-16 text-right border rounded px-1" />
                        </div>
                        <div class="flex justify-between">
                          <span>Taq:</span>
                          <input type="number" value="${precios.taquiza}" onchange="actualizarPaquetePrecio(${idx}, '${personas}', 'taquiza', this.value)" class="w-16 text-right border rounded px-1" />
                        </div>
                        <div class="flex justify-between">
                          <span>Par:</span>
                          <input type="number" value="${precios.parrillada}" onchange="actualizarPaquetePrecio(${idx}, '${personas}', 'parrillada', this.value)" class="w-16 text-right border rounded px-1" />
                        </div>
                      </div>
                    </div>
                  `).join('')}
                  <button onclick="agregarRangoPersonas(${idx})" class="bg-emerald-50 hover:bg-emerald-100 rounded-lg p-2 text-emerald-600 flex items-center justify-center">+ Rango</button>
                </div>
              </div>
            </div>
          `).join('')}

          <button onclick="agregarNuevoPaquete()" class="w-full bg-emerald-100 hover:bg-emerald-200 text-emerald-700 py-4 rounded-2xl font-medium">â• Agregar Nuevo Paquete</button>
          
          <button onclick="guardarConfiguracionPaquetes()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-semibold">ğŸ’¾ Guardar Cambios en Paquetes</button>
        </div>
      `;
    }

    function renderConfigExtrasTab() {
      return `
        <div class="space-y-4">
          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">Nombre</th>
                  <th class="px-4 py-3 text-left">Precio</th>
                  <th class="px-4 py-3 text-left">Por Persona</th>
                  <th class="px-4 py-3 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${EXTRAS.map((e, idx) => `
                  <tr>
                    <td class="px-4 py-3">
                      <input type="text" value="${e.nombre}" onchange="actualizarExtra(${idx}, 'nombre', this.value)" class="w-full border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none" />
                    </td>
                    <td class="px-4 py-3">
                      <input type="number" value="${e.precio || e.precioPP || 0}" onchange="actualizarExtra(${idx}, '${e.precioPP ? 'precioPP' : 'precio'}', parseFloat(this.value))" class="w-24 border rounded px-2 py-1" />
                    </td>
                    <td class="px-4 py-3">
                      <input type="checkbox" ${e.precioPP ? 'checked' : ''} onchange="toggleExtraPorPersona(${idx})" class="w-4 h-4" />
                    </td>
                    <td class="px-4 py-3 text-right">
                      <button onclick="eliminarExtra(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="bg-white rounded-2xl border p-4">
            <p class="font-medium mb-3">Agregar nuevo extra</p>
            <div class="flex gap-2">
              <input type="text" id="nuevo-extra-nombre" placeholder="Nombre" class="flex-1 p-2 border rounded-lg" />
              <input type="number" id="nuevo-extra-precio" placeholder="Precio" class="w-28 p-2 border rounded-lg" />
              <label class="flex items-center gap-1 px-3">
                <input type="checkbox" id="nuevo-extra-pp" class="w-4 h-4" />
                <span class="text-sm">Por persona</span>
              </label>
              <button onclick="agregarNuevoExtra()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">+</button>
            </div>
          </div>

          <button onclick="guardarConfiguracionExtras()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-semibold">ğŸ’¾ Guardar Cambios en Extras</button>
        </div>
      `;
    }

    function renderConfigItemsTab() {
      const categorias = [...new Set(ITEMS_INDIVIDUALES.map(i => i.categoria))];
      
      return `
        <div class="space-y-4">
          ${categorias.map(cat => `
            <div class="bg-white rounded-2xl border p-4">
              <h4 class="font-semibold mb-3">${cat}</h4>
              <div class="space-y-2">
                ${ITEMS_INDIVIDUALES.filter(i => i.categoria === cat).map((item, idx) => {
                  const globalIdx = ITEMS_INDIVIDUALES.indexOf(item);
                  return `
                    <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                      <input type="text" value="${item.nombre}" onchange="actualizarItem(${globalIdx}, 'nombre', this.value)" class="flex-1 text-sm border-b border-transparent hover:border-gray-300 outline-none bg-transparent" />
                      <input type="number" value="${item.precio}" onchange="actualizarItem(${globalIdx}, 'precio', parseFloat(this.value))" class="w-24 text-sm border rounded px-2 py-1" />
                      <label class="flex items-center gap-1 text-xs">
                        <input type="checkbox" ${item.porPersona ? 'checked' : ''} onchange="actualizarItem(${globalIdx}, 'porPersona', this.checked)" class="w-3 h-3" />
                        pp
                      </label>
                      <button onclick="eliminarItem(${globalIdx})" class="text-red-400 hover:text-red-600">âœ•</button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('')}

          <div class="bg-white rounded-2xl border p-4">
            <p class="font-medium mb-3">Agregar nuevo item</p>
            <div class="flex gap-2 flex-wrap">
              <input type="text" id="nuevo-item-nombre" placeholder="Nombre" class="flex-1 min-w-48 p-2 border rounded-lg" />
              <select id="nuevo-item-categoria" class="p-2 border rounded-lg">
                ${categorias.map(c => `<option value="${c}">${c}</option>`).join('')}
                <option value="__nueva__">+ Nueva categorÃ­a</option>
              </select>
              <input type="number" id="nuevo-item-precio" placeholder="Precio" class="w-24 p-2 border rounded-lg" />
              <label class="flex items-center gap-1 px-3">
                <input type="checkbox" id="nuevo-item-pp" class="w-4 h-4" />
                <span class="text-sm">Por persona</span>
              </label>
              <button onclick="agregarNuevoItem()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">+</button>
            </div>
          </div>

          <button onclick="guardarConfiguracionItems()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-semibold">ğŸ’¾ Guardar Cambios en Items</button>
        </div>
      `;
    }

    function renderConfigAlimentosTab() {
      return `
        <div class="space-y-4">
          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">Nombre</th>
                  <th class="px-4 py-3 text-left">DescripciÃ³n</th>
                  <th class="px-4 py-3 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${TIPOS_ALIMENTO.map((t, idx) => `
                  <tr>
                    <td class="px-4 py-3">
                      <input type="text" value="${t.nombre}" onchange="actualizarTipoAlimento(${idx}, 'nombre', this.value)" class="w-full border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none" />
                    </td>
                    <td class="px-4 py-3">
                      <input type="text" value="${t.descripcion}" onchange="actualizarTipoAlimento(${idx}, 'descripcion', this.value)" class="w-full border-b border-transparent hover:border-gray-300 focus:border-emerald-500 outline-none" />
                    </td>
                    <td class="px-4 py-3 text-right">
                      <button onclick="eliminarTipoAlimento(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="bg-white rounded-2xl border p-4">
            <p class="font-medium mb-3">Agregar nuevo tipo de alimento</p>
            <div class="flex gap-2">
              <input type="text" id="nuevo-alimento-nombre" placeholder="Nombre" class="flex-1 p-2 border rounded-lg" />
              <input type="text" id="nuevo-alimento-desc" placeholder="DescripciÃ³n" class="flex-1 p-2 border rounded-lg" />
              <button onclick="agregarNuevoTipoAlimento()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">+</button>
            </div>
          </div>

          <button onclick="guardarConfiguracionAlimentos()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-semibold">ğŸ’¾ Guardar Cambios en Alimentos</button>
        </div>
      `;
    }
    // ========== INVENTARIO DEL RESTAURANTE ==========
    function renderInventario() { 
      const inventarioFiltrado = insumos.filter(i => 
        !busqueda || i.nombre?.toLowerCase().includes(busqueda.toLowerCase())
      ).sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
      
      const itemsBajoStock = insumos.filter(i => (i.cantidad || 0) <= (i.minimo || 0));
      const totalValorInventario = insumos.reduce((sum, i) => sum + ((i.cantidad || 0) * (i.precioUnitario || 0)), 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“¦ Inventario</h2>
              <p class="text-gray-500">Control de existencias e insumos</p>
            </div>
            <div class="flex gap-3">
              <button onclick="abrirModal('ajusteInventario')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-xl font-medium">
                ğŸ“ Ajuste Masivo
              </button>
              <button onclick="abrirModal('insumo')" class="bg-amber-600 hover:bg-amber-700 text-white px-5 py-3 rounded-xl font-medium">
                â• Nuevo Insumo
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl border p-5">
              <p class="text-sm text-gray-500">Total Insumos</p>
              <p class="text-3xl font-bold text-gray-800">${insumos.length}</p>
            </div>
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Stock Bajo</p>
              <p class="text-3xl font-bold text-red-600">${itemsBajoStock.length}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Stock Normal</p>
              <p class="text-3xl font-bold text-green-600">${insumos.length - itemsBajoStock.length}</p>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Valor Inventario</p>
              <p class="text-3xl font-bold text-blue-600">${fmt(totalValorInventario)}</p>
            </div>
          </div>

          ${itemsBajoStock.length > 0 ? `
            <div class="bg-red-50 border border-red-200 rounded-2xl p-5">
              <h3 class="font-semibold text-red-800 mb-3">âš ï¸ Insumos con Stock Bajo</h3>
              <div class="flex flex-wrap gap-2">
                ${itemsBajoStock.map(i => `
                  <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">${i.nombre}: ${i.cantidad || 0} ${i.unidad || 'uds'}</span>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="flex gap-4 items-center">
            <div class="flex-1 relative">
              <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
              <input type="text" placeholder="Buscar insumo..." value="${busqueda}" 
                onkeyup="setBusqueda(this.value)" class="w-full pl-10 p-3 border rounded-xl" />
            </div>
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Insumo</th>
                  <th class="px-4 py-3 text-left font-semibold">CategorÃ­a</th>
                  <th class="px-4 py-3 text-center font-semibold">Cantidad</th>
                  <th class="px-4 py-3 text-center font-semibold">MÃ­nimo</th>
                  <th class="px-4 py-3 text-center font-semibold">Precio Unit.</th>
                  <th class="px-4 py-3 text-center font-semibold">Estado</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${inventarioFiltrado.length === 0 ? `
                  <tr><td colspan="7" class="px-4 py-12 text-center text-gray-400">No hay insumos registrados</td></tr>
                ` : inventarioFiltrado.map(i => {
                  const stockBajo = (i.cantidad || 0) <= (i.minimo || 0);
                  return `
                    <tr class="hover:bg-gray-50 ${stockBajo ? 'bg-red-50' : ''}">
                      <td class="px-4 py-3">
                        <p class="font-medium">${i.nombre || '-'}</p>
                        <p class="text-xs text-gray-500">${i.unidad || ''}</p>
                      </td>
                      <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${i.categoria || '-'}</span></td>
                      <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-2">
                          <button onclick="ajustarInventario('${i.id}', -1)" class="w-8 h-8 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">-</button>
                          <span class="font-bold min-w-[40px]">${i.cantidad || 0}</span>
                          <button onclick="ajustarInventario('${i.id}', 1)" class="w-8 h-8 bg-green-100 text-green-600 rounded-lg hover:bg-green-200">+</button>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-center text-gray-500">${i.minimo || 0}</td>
                      <td class="px-4 py-3 text-center">${fmt(i.precioUnitario || 0)}</td>
                      <td class="px-4 py-3 text-center">
                        ${stockBajo ? 
                          '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">âš ï¸ Bajo</span>' : 
                          '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">âœ“ OK</span>'
                        }
                      </td>
                      <td class="px-4 py-3 text-right">
                        <button onclick="editarInsumo('${i.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                        <button onclick="eliminarInsumo('${i.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== CORTE DE CAJA ==========
    function renderCorte() { 
      const fechaCorte = window.fechaCorte || new Date().toISOString().slice(0, 10);
      const hoy = new Date().toISOString().slice(0, 10);
      
      // Ã“rdenes del dÃ­a seleccionado
      const ordenesDelDia = ordenesRestaurante.filter(o => {
        const fechaOrden = o.fechaCreacion?.toDate?.()?.toISOString().slice(0, 10) || o.fecha?.slice(0, 10);
        return fechaOrden === fechaCorte;
      });
      
      const ordenesPagadas = ordenesDelDia.filter(o => o.estado === 'pagado');
      const ordenesPendientes = ordenesDelDia.filter(o => o.estado !== 'pagado' && o.estado !== 'cancelado');
      
      // Calcular totales
      const totalVentas = ordenesDelDia.reduce((sum, o) => sum + (o.total || 0), 0);
      const totalCobrado = ordenesPagadas.reduce((sum, o) => sum + (o.total || 0), 0);
      const totalPendiente = ordenesPendientes.reduce((sum, o) => sum + (o.total || 0), 0);
      
      // Por mÃ©todo de pago
      const ventasEfectivo = ordenesPagadas.filter(o => o.metodoPago === 'efectivo').reduce((sum, o) => sum + (o.total || 0), 0);
      const ventasTarjeta = ordenesPagadas.filter(o => o.metodoPago === 'tarjeta').reduce((sum, o) => sum + (o.total || 0), 0);
      const ventasTransferencia = ordenesPagadas.filter(o => o.metodoPago === 'transferencia').reduce((sum, o) => sum + (o.total || 0), 0);
      const ventasOtros = totalCobrado - ventasEfectivo - ventasTarjeta - ventasTransferencia;
      
      // Gastos del dÃ­a
      const gastosDelDia = gastos.filter(g => g.fecha === fechaCorte);
      const totalGastos = gastosDelDia.reduce((sum, g) => sum + (g.monto || 0), 0);
      
      const efectivoEnCaja = ventasEfectivo - gastosDelDia.filter(g => g.metodoPago === 'efectivo').reduce((sum, g) => sum + (g.monto || 0), 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">âœ‚ï¸ Corte de Caja</h2>
              <p class="text-gray-500">Resumen de ventas y cierre del dÃ­a</p>
            </div>
            <div class="flex items-center gap-3">
              <input type="date" value="${fechaCorte}" max="${hoy}" onchange="window.fechaCorte = this.value; render()" class="p-3 border rounded-xl" />
              <button onclick="imprimirCorte()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-xl font-medium">ğŸ–¨ï¸ Imprimir</button>
              ${fechaCorte === hoy ? `
                <button onclick="cerrarCorte()" class="bg-amber-600 hover:bg-amber-700 text-white px-5 py-3 rounded-xl font-medium">âœ‚ï¸ Cerrar Caja</button>
              ` : ''}
            </div>
          </div>

          <!-- Resumen Principal -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white">
              <p class="text-amber-100 text-sm">Ventas del DÃ­a</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalVentas)}</p>
              <p class="text-amber-200 text-xs mt-1">${ordenesDelDia.length} Ã³rdenes</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
              <p class="text-green-100 text-sm">Total Cobrado</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalCobrado)}</p>
              <p class="text-green-200 text-xs mt-1">${ordenesPagadas.length} Ã³rdenes pagadas</p>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-amber-600 rounded-2xl p-5 text-white">
              <p class="text-yellow-100 text-sm">Pendiente de Cobro</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalPendiente)}</p>
              <p class="text-yellow-200 text-xs mt-1">${ordenesPendientes.length} Ã³rdenes</p>
            </div>
            <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl p-5 text-white">
              <p class="text-red-100 text-sm">Gastos del DÃ­a</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalGastos)}</p>
              <p class="text-red-200 text-xs mt-1">${gastosDelDia.length} gastos</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Desglose por MÃ©todo de Pago -->
            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ’³ Desglose por MÃ©todo de Pago</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center p-4 bg-green-50 rounded-xl">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ’µ</span>
                    <span class="font-medium">Efectivo</span>
                  </div>
                  <span class="font-bold text-green-700">${fmt(ventasEfectivo)}</span>
                </div>
                <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ’³</span>
                    <span class="font-medium">Tarjeta</span>
                  </div>
                  <span class="font-bold text-blue-700">${fmt(ventasTarjeta)}</span>
                </div>
                <div class="flex justify-between items-center p-4 bg-purple-50 rounded-xl">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ“²</span>
                    <span class="font-medium">Transferencia</span>
                  </div>
                  <span class="font-bold text-purple-700">${fmt(ventasTransferencia)}</span>
                </div>
                ${ventasOtros > 0 ? `
                  <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">ğŸ“</span>
                      <span class="font-medium">Otros</span>
                    </div>
                    <span class="font-bold text-gray-700">${fmt(ventasOtros)}</span>
                  </div>
                ` : ''}
              </div>
              
              <div class="mt-6 pt-4 border-t">
                <div class="flex justify-between items-center p-4 bg-amber-100 rounded-xl">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ¦</span>
                    <span class="font-bold">Efectivo en Caja</span>
                  </div>
                  <span class="text-2xl font-bold text-amber-800">${fmt(efectivoEnCaja)}</span>
                </div>
              </div>
            </div>

            <!-- Gastos del DÃ­a -->
            <div class="bg-white rounded-2xl border p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">ğŸ§¾ Gastos del DÃ­a</h3>
                <button onclick="abrirModal('gastoContabilidad')" class="text-sm text-amber-600 hover:text-amber-800">+ Agregar Gasto</button>
              </div>
              <div class="space-y-2 max-h-[300px] overflow-y-auto">
                ${gastosDelDia.length === 0 ? `
                  <p class="text-center text-gray-400 py-8">Sin gastos registrados</p>
                ` : gastosDelDia.map(g => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                    <div>
                      <p class="font-medium">${g.descripcion || g.categoria || 'Gasto'}</p>
                      <p class="text-xs text-gray-500">${g.categoria || '-'}</p>
                    </div>
                    <span class="font-bold text-red-600">-${fmt(g.monto)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- Ã“rdenes Pendientes de Cobro -->
          ${ordenesPendientes.length > 0 ? `
            <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-6">
              <h3 class="font-semibold text-lg mb-4 text-yellow-800">â³ Ã“rdenes Pendientes de Cobro</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                ${ordenesPendientes.map(o => `
                  <div class="bg-white rounded-xl p-4 border border-yellow-200">
                    <div class="flex justify-between items-start">
                      <div>
                        <p class="font-bold">Orden #${o.numero || o.id?.slice(-4)}</p>
                        <p class="text-sm text-gray-500">${o.mesa?.nombre || 'Sin mesa'}</p>
                      </div>
                      <span class="font-bold text-lg">${fmt(o.total)}</span>
                    </div>
                    <button onclick="cobrarOrden('${o.id}')" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium">
                      ğŸ’µ Cobrar
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Resumen Final -->
          <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl p-6 text-white">
            <h3 class="font-semibold text-lg mb-4">ğŸ“Š Resumen del DÃ­a - ${fmtFecha(fechaCorte)}</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center p-4 bg-white/10 rounded-xl">
                <p class="text-gray-300 text-sm">Total Ventas</p>
                <p class="text-2xl font-bold">${fmt(totalVentas)}</p>
              </div>
              <div class="text-center p-4 bg-white/10 rounded-xl">
                <p class="text-gray-300 text-sm">(-) Gastos</p>
                <p class="text-2xl font-bold text-red-400">${fmt(totalGastos)}</p>
              </div>
              <div class="text-center p-4 bg-white/10 rounded-xl">
                <p class="text-gray-300 text-sm">(-) Pendiente</p>
                <p class="text-2xl font-bold text-yellow-400">${fmt(totalPendiente)}</p>
              </div>
              <div class="text-center p-4 bg-green-500/30 rounded-xl">
                <p class="text-gray-300 text-sm">= Utilidad del DÃ­a</p>
                <p class="text-2xl font-bold text-green-400">${fmt(totalCobrado - totalGastos)}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.imprimirCorte = () => {
      window.print();
    };

    window.cerrarCorte = async () => {
      if (!confirm('Â¿Cerrar el corte de caja del dÃ­a?\n\nEsto guardarÃ¡ el resumen en el historial.')) return;
      // AquÃ­ se podrÃ­a guardar el corte en Firestore
      alert('âœ… Corte de caja cerrado correctamente');
    };

    window.cobrarOrden = (ordenId) => {
      const orden = ordenesRestaurante.find(o => o.id === ordenId);
      if (orden) {
        itemEditando = orden;
        modalAbierto = 'cobrarOrden';
        render();
      }
    };

    window.ajustarInventario = async (insumoId, cantidad) => {
      const insumo = insumos.find(i => i.id === insumoId);
      if (!insumo) return;
      
      const nuevaCantidad = Math.max(0, (insumo.cantidad || 0) + cantidad);
      try {
        await updateDoc(doc(db, 'insumos', insumoId), { cantidad: nuevaCantidad });
        insumo.cantidad = nuevaCantidad;
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== CATERING Y EVENTOS ==========
    // Tipos de servicio de catering
    // Paquetes de catering (editables desde configuraciÃ³n)
    const TIPOS_CATERING_DEFAULT = [
      { id: 'coffee-basico', nombre: 'Coffee Break BÃ¡sico', descripcion: 'CafÃ©, tÃ©, galletas', precioBase: 85, costo: 35 },
      { id: 'coffee-completo', nombre: 'Coffee Break Completo', descripcion: 'CafÃ©, tÃ©, jugos, pan dulce, fruta', precioBase: 150, costo: 60 },
      { id: 'coffee-premium', nombre: 'Coffee Break Premium', descripcion: 'Todo incluido + bocadillos salados', precioBase: 220, costo: 90 },
      { id: 'desayuno-continental', nombre: 'Desayuno Continental', descripcion: 'Pan, fruta, yogurt, cereales, cafÃ©', precioBase: 180, costo: 70 },
      { id: 'desayuno-ejecutivo', nombre: 'Desayuno Ejecutivo', descripcion: 'Huevos, chilaquiles o hot cakes, fruta, cafÃ©', precioBase: 250, costo: 100 },
      { id: 'comida-box', nombre: 'Box Lunch', descripcion: 'SÃ¡ndwich/torta, fruta, bebida, postre', precioBase: 150, costo: 60 },
      { id: 'comida-buffet', nombre: 'Buffet Comida', descripcion: 'Entradas, plato fuerte, guarniciones, postre, bebida', precioBase: 350, costo: 140 },
      { id: 'coctel', nombre: 'CÃ³ctel/Botanas', descripcion: 'CanapÃ©s, botanas variadas, bebidas', precioBase: 280, costo: 110 },
      { id: 'personalizado', nombre: 'MenÃº Personalizado', descripcion: 'DiseÃ±o de menÃº a la medida', precioBase: 0, costo: 0 }
    ];

    const EXTRAS_CATERING_DEFAULT = [
      { id: 'meseros', nombre: 'Servicio de Meseros', precioPP: 50, precio: 0, costo: 30, descripcion: 'Por persona' },
      { id: 'manteleria', nombre: 'MantelerÃ­a Premium', precioPP: 0, precio: 500, costo: 200, descripcion: 'Juego completo' },
      { id: 'vajilla', nombre: 'Vajilla de Porcelana', precioPP: 25, precio: 0, costo: 10, descripcion: 'Por persona' },
      { id: 'centro-mesa', nombre: 'Centros de Mesa', precioPP: 0, precio: 150, costo: 60, descripcion: 'Por mesa' },
      { id: 'transporte', nombre: 'Transporte', precioPP: 0, precio: 800, costo: 400, descripcion: 'Dentro de CDMX' },
      { id: 'montaje', nombre: 'Montaje y Desmontaje', precioPP: 0, precio: 1500, costo: 600, descripcion: 'Servicio completo' }
    ];

    // Variables que se cargan desde Firestore (o usan default)
    let paquetesCatering = [...TIPOS_CATERING_DEFAULT];
    let extrasCatering = [...EXTRAS_CATERING_DEFAULT];

    // Para compatibilidad con cÃ³digo existente
    const TIPOS_CATERING = paquetesCatering;
    const EXTRAS_CATERING = extrasCatering;

    // Estado temporal para cotizaciÃ³n de catering
    if (!window.cateringActual) {
      window.cateringActual = {
        cliente: '', telefono: '', email: '', empresa: '',
        fechaEvento: '', horaInicio: '09:00', horaFin: '14:00',
        tipoServicio: 'coffee-basico', personas: 20,
        ubicacion: '', notas: '',
        itemsPersonalizados: [],
        productosMenu: [], // Productos del restaurante para menÃº personalizado
        extras: [],
        descuento: 0,
        margenCatering: 30 // Margen de ganancia sobre costo de productos
      };
    }

    function renderCatering() {
      const filtro = window.filtroCatering || 'todas';
      const cotizacionesFiltradas = cotizacionesCatering.filter(c => {
        if (filtro === 'todas') return true;
        return c.estado === filtro;
      }).sort((a, b) => (b.fechaCreacion?.toDate?.() || new Date(0)) - (a.fechaCreacion?.toDate?.() || new Date(0)));
      
      const totalCotizaciones = cotizacionesCatering.length;
      const pendientes = cotizacionesCatering.filter(c => c.estado === 'pendiente').length;
      const confirmadas = cotizacionesCatering.filter(c => c.estado === 'confirmado').length;
      const ingresosMes = cotizacionesCatering.filter(c => c.fechaEvento?.startsWith(filtroMes) && ['realizado', 'pagado'].includes(c.estado))
        .reduce((sum, c) => sum + (c.total || 0), 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ± Catering y Eventos</h2>
              <p class="text-gray-500">Cotiza coffee breaks, desayunos y servicios de comida</p>
            </div>
            <div class="flex gap-2">
              <button onclick="abrirModal('configCatering')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-xl font-medium">
                âš™ï¸ Configurar Paquetes
              </button>
              <button onclick="abrirModal('nuevaCotizacionCatering')" class="bg-amber-600 hover:bg-amber-700 text-white px-5 py-3 rounded-xl font-medium">
                â• Nueva CotizaciÃ³n
              </button>
            </div>
          </div>

          <!-- KPIs -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl border p-5">
              <p class="text-sm text-gray-500">Total Cotizaciones</p>
              <p class="text-3xl font-bold text-gray-800">${totalCotizaciones}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Pendientes</p>
              <p class="text-3xl font-bold text-yellow-700">${pendientes}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Confirmadas</p>
              <p class="text-3xl font-bold text-green-700">${confirmadas}</p>
            </div>
            <div class="bg-amber-50 border border-amber-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Ingresos del Mes</p>
              <p class="text-3xl font-bold text-amber-700">${fmt(ingresosMes)}</p>
            </div>
          </div>

          <!-- Filtros -->
          <div class="flex flex-wrap gap-2">
            ${[
              {id: 'todas', nombre: 'Todas'},
              {id: 'pendiente', nombre: 'â³ Pendientes'},
              {id: 'confirmado', nombre: 'âœ… Confirmadas'},
              {id: 'realizado', nombre: 'ğŸ‰ Realizados'},
              {id: 'cancelado', nombre: 'âŒ Cancelados'}
            ].map(f => `
              <button onclick="window.filtroCatering = '${f.id}'; render()" class="px-4 py-2 rounded-xl font-medium ${filtro === f.id ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">${f.nombre}</button>
            `).join('')}
          </div>

          <!-- Tabla de cotizaciones -->
          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Folio</th>
                  <th class="px-4 py-3 text-left font-semibold">Cliente/Empresa</th>
                  <th class="px-4 py-3 text-left font-semibold">Servicio</th>
                  <th class="px-4 py-3 text-left font-semibold">Fecha</th>
                  <th class="px-4 py-3 text-center font-semibold">Personas</th>
                  <th class="px-4 py-3 text-right font-semibold">Total</th>
                  <th class="px-4 py-3 text-center font-semibold">Estado</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${cotizacionesFiltradas.length === 0 ? `
                  <tr>
                    <td colspan="8" class="px-4 py-12 text-center text-gray-400">
                      <p class="text-4xl mb-2">ğŸ±</p>
                      <p>No hay cotizaciones de catering</p>
                      <button onclick="abrirModal('nuevaCotizacionCatering')" class="mt-4 text-amber-600 hover:text-amber-800">Crear primera cotizaciÃ³n</button>
                    </td>
                  </tr>
                ` : cotizacionesFiltradas.map(c => {
                  const tipo = TIPOS_CATERING.find(t => t.id === c.tipoServicio) || { nombre: c.tipoServicio };
                  return `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3 font-bold text-amber-600">#CAT-${c.folio || c.id?.slice(-4)}</td>
                      <td class="px-4 py-3">
                        <p class="font-medium">${c.cliente || '-'}</p>
                        <p class="text-sm text-gray-500">${c.empresa || ''}</p>
                      </td>
                      <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs font-medium">${tipo.nombre}</span>
                      </td>
                      <td class="px-4 py-3">
                        <p class="font-medium">${fmtFecha(c.fechaEvento)}</p>
                        <p class="text-sm text-gray-500">${c.horaInicio || ''} - ${c.horaFin || ''}</p>
                      </td>
                      <td class="px-4 py-3 text-center font-semibold">${c.personas}</td>
                      <td class="px-4 py-3 text-right font-bold">${fmt(c.total)}</td>
                      <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                          c.estado === 'pendiente' ? 'bg-yellow-100 text-yellow-800' :
                          c.estado === 'confirmado' ? 'bg-blue-100 text-blue-800' :
                          c.estado === 'realizado' || c.estado === 'pagado' ? 'bg-green-100 text-green-800' :
                          'bg-red-100 text-red-800'
                        }">${c.estado || 'pendiente'}</span>
                      </td>
                      <td class="px-4 py-3 text-right">
                        <div class="flex justify-end gap-1">
                          <button onclick="verCotizacionCatering('${c.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Ver">ğŸ‘ï¸</button>
                          <button onclick="editarCotizacionCatering('${c.id}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg" title="Editar">âœï¸</button>
                          <button onclick="duplicarCotizacionCatering('${c.id}')" class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg" title="Duplicar">ğŸ“‹</button>
                          <button onclick="eliminarCotizacionCatering('${c.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Eliminar">ğŸ—‘ï¸</button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <!-- Paquetes disponibles -->
          <div class="bg-white rounded-2xl border p-6">
            <h3 class="font-semibold text-lg mb-4">ğŸ“¦ Paquetes de Catering Disponibles</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${TIPOS_CATERING.map(t => `
                <div class="border rounded-xl p-4 hover:shadow-md transition-shadow">
                  <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold">${t.nombre}</h4>
                    <span class="text-amber-600 font-bold">${t.precioBase > 0 ? fmt(t.precioBase) + '/pp' : 'A cotizar'}</span>
                  </div>
                  <p class="text-sm text-gray-600">${t.descripcion}</p>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Funciones de Catering
    window.verCotizacionCatering = (id) => {
      const cot = cotizacionesCatering.find(c => c.id === id);
      if (cot) {
        itemEditando = cot;
        modalAbierto = 'verCotizacionCatering';
        render();
      }
    };

    window.editarCotizacionCatering = (id) => {
      const cot = cotizacionesCatering.find(c => c.id === id);
      if (cot) {
        window.cateringActual = { ...cot };
        modalAbierto = 'nuevaCotizacionCatering';
        render();
      }
    };

    window.duplicarCotizacionCatering = (id) => {
      const cot = cotizacionesCatering.find(c => c.id === id);
      if (cot) {
        window.cateringActual = { ...cot, id: null, folio: null, estado: 'pendiente', fechaEvento: '' };
        modalAbierto = 'nuevaCotizacionCatering';
        render();
      }
    };

    window.eliminarCotizacionCatering = async (id) => {
      if (!confirm('Â¿Eliminar esta cotizaciÃ³n de catering?')) return;
      try {
        await deleteDoc(doc(db, 'cotizacionesCatering', id));
        cotizacionesCatering = cotizacionesCatering.filter(c => c.id !== id);
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.cambiarEstadoCatering = async (id, nuevoEstado) => {
      try {
        await updateDoc(doc(db, 'cotizacionesCatering', id), { estado: nuevoEstado });
        const cot = cotizacionesCatering.find(c => c.id === id);
        if (cot) cot.estado = nuevoEstado;
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.calcularTotalCatering = () => {
      const cat = window.cateringActual;
      const tipo = TIPOS_CATERING.find(t => t.id === cat.tipoServicio);
      
      let subtotal = 0;
      let costoTotal = 0;
      
      // Si es menÃº personalizado, usar productos del restaurante
      if (cat.tipoServicio === 'personalizado' && cat.productosMenu?.length > 0) {
        cat.productosMenu.forEach(pm => {
          const producto = productos.find(p => p.id === pm.productoId);
          if (producto) {
            const cantidad = pm.porPersona ? pm.cantidad * (cat.personas || 1) : pm.cantidad;
            const precioVenta = (producto.precio || 0) * cantidad;
            const costoProducto = (producto.costo || producto.precio * 0.35) * cantidad;
            subtotal += precioVenta;
            costoTotal += costoProducto;
          }
        });
        
        // Aplicar margen adicional de catering si se desea
        const margen = cat.margenCatering || 0;
        if (margen > 0) {
          subtotal = subtotal * (1 + margen / 100);
        }
      } else {
        // Costo base por persona (paquetes predefinidos)
        subtotal = (tipo?.precioBase || 0) * (cat.personas || 0);
        costoTotal = subtotal * 0.4; // Estimamos 40% de costo para paquetes
      }
      
      // Items personalizados adicionales
      if (cat.itemsPersonalizados?.length > 0) {
        subtotal += cat.itemsPersonalizados.reduce((sum, item) => {
          return sum + (item.precio || 0) * (item.porPersona ? cat.personas : 1);
        }, 0);
      }
      
      // Extras
      if (cat.extras?.length > 0) {
        cat.extras.forEach(extraId => {
          const extra = EXTRAS_CATERING.find(e => e.id === extraId);
          if (extra) {
            subtotal += extra.precioPP ? extra.precioPP * cat.personas : extra.precio;
          }
        });
      }
      
      // Descuento
      const descuentoMonto = subtotal * ((cat.descuento || 0) / 100);
      const subtotalConDescuento = subtotal - descuentoMonto;
      const iva = subtotalConDescuento * 0.16;
      const total = subtotalConDescuento + iva;
      
      // Calcular utilidad estimada
      const utilidadEstimada = subtotalConDescuento - costoTotal;
      const margenUtilidad = subtotalConDescuento > 0 ? (utilidadEstimada / subtotalConDescuento) * 100 : 0;
      
      return { subtotal, costoTotal, utilidadEstimada, margenUtilidad, descuentoMonto, subtotalConDescuento, iva, total };
    };

    // Funciones para manejar productos del menÃº en catering
    window.agregarProductoMenuCatering = (productoId) => {
      if (!window.cateringActual.productosMenu) {
        window.cateringActual.productosMenu = [];
      }
      
      const existe = window.cateringActual.productosMenu.find(p => p.productoId === productoId);
      if (existe) {
        existe.cantidad++;
      } else {
        window.cateringActual.productosMenu.push({
          productoId,
          cantidad: 1,
          porPersona: true
        });
      }
      render();
    };

    window.quitarProductoMenuCatering = (productoId) => {
      window.cateringActual.productosMenu = window.cateringActual.productosMenu.filter(p => p.productoId !== productoId);
      render();
    };

    window.actualizarProductoMenuCatering = (productoId, campo, valor) => {
      const item = window.cateringActual.productosMenu.find(p => p.productoId === productoId);
      if (item) {
        item[campo] = valor;
        render();
      }
    };

    window.guardarCotizacionCatering = async () => {
      const cat = window.cateringActual;
      
      if (!cat.cliente || !cat.fechaEvento || !cat.personas) {
        alert('Por favor completa: cliente, fecha y nÃºmero de personas');
        return;
      }
      
      const calculos = calcularTotalCatering();
      
      const datos = {
        ...cat,
        ...calculos,
        estado: cat.estado || 'pendiente',
        fechaActualizacion: serverTimestamp()
      };
      
      try {
        if (cat.id) {
          // Actualizar existente
          await updateDoc(doc(db, 'cotizacionesCatering', cat.id), datos);
          const idx = cotizacionesCatering.findIndex(c => c.id === cat.id);
          if (idx >= 0) cotizacionesCatering[idx] = { ...cotizacionesCatering[idx], ...datos };
        } else {
          // Crear nueva
          const folio = cotizacionesCatering.length + 1;
          datos.folio = folio;
          datos.fechaCreacion = serverTimestamp();
          const docRef = await addDoc(collection(db, 'cotizacionesCatering'), datos);
          cotizacionesCatering.unshift({ id: docRef.id, ...datos });
        }
        
        // Limpiar estado temporal
        window.cateringActual = {
          cliente: '', telefono: '', email: '', empresa: '',
          fechaEvento: '', horaInicio: '09:00', horaFin: '14:00',
          tipoServicio: 'coffee-basico', personas: 20,
          ubicacion: '', notas: '',
          itemsPersonalizados: [],
          productosMenu: [],
          extras: [],
          descuento: 0,
          margenCatering: 30
        };
        
        cerrarModal();
        render();
        alert('âœ… CotizaciÃ³n guardada correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.toggleExtraCatering = (extraId) => {
      const extras = window.cateringActual.extras || [];
      const idx = extras.indexOf(extraId);
      if (idx >= 0) {
        extras.splice(idx, 1);
      } else {
        extras.push(extraId);
      }
      window.cateringActual.extras = extras;
      render();
    };

    window.agregarItemPersonalizado = () => {
      if (!window.cateringActual.itemsPersonalizados) {
        window.cateringActual.itemsPersonalizados = [];
      }
      window.cateringActual.itemsPersonalizados.push({
        nombre: '',
        precio: 0,
        porPersona: true
      });
      render();
    };

    window.eliminarItemPersonalizado = (idx) => {
      window.cateringActual.itemsPersonalizados.splice(idx, 1);
      render();
    };

    window.actualizarItemPersonalizado = (idx, campo, valor) => {
      window.cateringActual.itemsPersonalizados[idx][campo] = valor;
      render();
    };

    // ========== PERSONAL - DIRECTORIO ==========
    function renderDirectorio() {
      const busqueda = window.busquedaEmpleado || '';
      const filtroArea = window.filtroAreaEmpleado || 'todas';
      
      const empleadosFiltrados = empleados.filter(e => {
        const coincideBusqueda = !busqueda || 
          e.nombre?.toLowerCase().includes(busqueda.toLowerCase()) ||
          e.puesto?.toLowerCase().includes(busqueda.toLowerCase());
        const coincideArea = filtroArea === 'todas' || 
          PUESTOS_DISPONIBLES.find(p => p.id === e.puesto)?.area === filtroArea;
        return coincideBusqueda && coincideArea && e.activo !== false;
      });
      
      const totalEmpleados = empleados.filter(e => e.activo !== false).length;
      const porArea = {
        cocina: empleados.filter(e => PUESTOS_DISPONIBLES.find(p => p.id === e.puesto)?.area === 'cocina' && e.activo !== false).length,
        servicio: empleados.filter(e => PUESTOS_DISPONIBLES.find(p => p.id === e.puesto)?.area === 'servicio' && e.activo !== false).length,
        admin: empleados.filter(e => PUESTOS_DISPONIBLES.find(p => p.id === e.puesto)?.area === 'admin' && e.activo !== false).length
      };
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¤ Directorio de Personal</h2>
              <p class="text-gray-500">GestiÃ³n de empleados y contratos</p>
            </div>
            <button onclick="abrirModal('nuevoEmpleado')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-medium">
              â• Nuevo Empleado
            </button>
          </div>

          <!-- KPIs -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Total Empleados</p>
              <p class="text-3xl font-bold text-blue-700">${totalEmpleados}</p>
            </div>
            <div class="bg-orange-50 border border-orange-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">ğŸ³ Cocina</p>
              <p class="text-3xl font-bold text-orange-700">${porArea.cocina}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">ğŸ½ï¸ Servicio</p>
              <p class="text-3xl font-bold text-green-700">${porArea.servicio}</p>
            </div>
            <div class="bg-purple-50 border border-purple-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">ğŸ“Š Admin</p>
              <p class="text-3xl font-bold text-purple-700">${porArea.admin}</p>
            </div>
          </div>

          <!-- Filtros -->
          <div class="flex flex-wrap gap-4 items-center">
            <input type="text" placeholder="ğŸ” Buscar empleado..." value="${busqueda}" 
              onkeyup="window.busquedaEmpleado = this.value; render()"
              class="flex-1 min-w-[200px] p-3 border rounded-xl" />
            <select onchange="window.filtroAreaEmpleado = this.value; render()" class="p-3 border rounded-xl">
              <option value="todas" ${filtroArea === 'todas' ? 'selected' : ''}>Todas las Ã¡reas</option>
              <option value="cocina" ${filtroArea === 'cocina' ? 'selected' : ''}>ğŸ³ Cocina</option>
              <option value="servicio" ${filtroArea === 'servicio' ? 'selected' : ''}>ğŸ½ï¸ Servicio</option>
              <option value="admin" ${filtroArea === 'admin' ? 'selected' : ''}>ğŸ“Š Admin</option>
              <option value="mantenimiento" ${filtroArea === 'mantenimiento' ? 'selected' : ''}>ğŸ§¹ Mantenimiento</option>
            </select>
          </div>

          <!-- Lista de Empleados -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${empleadosFiltrados.length === 0 ? `
              <div class="col-span-full bg-white rounded-2xl border p-12 text-center">
                <p class="text-4xl mb-4">ğŸ‘¥</p>
                <p class="text-gray-500">No hay empleados registrados</p>
                <button onclick="abrirModal('nuevoEmpleado')" class="mt-4 text-blue-600 hover:text-blue-800">Agregar primer empleado</button>
              </div>
            ` : empleadosFiltrados.map(e => {
              const puesto = PUESTOS_DISPONIBLES.find(p => p.id === e.puesto);
              const contrato = TIPOS_CONTRATO.find(c => c.id === e.tipoContrato);
              const areaColor = {
                cocina: 'bg-orange-100 text-orange-800',
                servicio: 'bg-green-100 text-green-800',
                admin: 'bg-purple-100 text-purple-800',
                mantenimiento: 'bg-gray-100 text-gray-800',
                seguridad: 'bg-red-100 text-red-800'
              }[puesto?.area] || 'bg-gray-100 text-gray-800';
              
              return `
                <div class="bg-white rounded-2xl border p-5 hover:shadow-lg transition-shadow">
                  <div class="flex items-start gap-4">
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl">
                      ${e.foto ? `<img src="${e.foto}" class="w-full h-full rounded-full object-cover" />` : e.nombre?.charAt(0)?.toUpperCase() || 'ğŸ‘¤'}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-bold text-lg">${e.nombre || 'Sin nombre'}</h3>
                      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${areaColor}">${puesto?.nombre || e.puesto || 'Sin puesto'}</span>
                    </div>
                  </div>
                  
                  <div class="mt-4 space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-500">Contrato:</span>
                      <span class="font-medium">${contrato?.nombre || e.tipoContrato || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-500">Salario:</span>
                      <span class="font-medium">${fmt(e.salario || 0)}/${e.periodoSalario || 'mes'}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-500">Ingreso:</span>
                      <span class="font-medium">${e.fechaIngreso ? fmtFecha(e.fechaIngreso) : '-'}</span>
                    </div>
                    ${e.telefono ? `
                      <div class="flex justify-between">
                        <span class="text-gray-500">Tel:</span>
                        <span class="font-medium">${e.telefono}</span>
                      </div>
                    ` : ''}
                  </div>
                  
                  <div class="mt-4 pt-4 border-t flex justify-between">
                    <button onclick="verEmpleado('${e.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Ver perfil</button>
                    <div class="flex gap-2">
                      <button onclick="editarEmpleado('${e.id}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg" title="Editar">âœï¸</button>
                      <button onclick="generarContrato('${e.id}')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg" title="Generar Contrato">ğŸ“„</button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    // ========== PERSONAL - NÃ“MINA ==========
    function renderNomina() {
      const periodoActual = window.periodoNomina || new Date().toISOString().slice(0, 7);
      const empleadosActivos = empleados.filter(e => e.activo !== false && e.tipoContrato !== 'honorarios');
      
      // Calcular nÃ³mina para cada empleado
      const nominaCalculada = empleadosActivos.map(e => {
        const salarioBase = e.salario || 0;
        const periodo = e.periodoSalario || 'mes';
        
        // Convertir a quincenal si es necesario
        let salarioQuincenal = salarioBase;
        if (periodo === 'mes') salarioQuincenal = salarioBase / 2;
        if (periodo === 'semana') salarioQuincenal = salarioBase * 2;
        if (periodo === 'dia') salarioQuincenal = salarioBase * 15;
        
        // Calcular deducciones (simplificado)
        const imss = e.tipoContrato === 'tiempo-completo' ? salarioQuincenal * 0.025 : 0;
        const isr = salarioQuincenal > 7000 ? (salarioQuincenal - 7000) * 0.09 : 0;
        const totalDeducciones = imss + isr + (e.otrasDeduciones || 0);
        
        // Percepciones extra
        const horasExtra = (e.horasExtraQuincena || 0) * (salarioBase / 240) * 2; // Doble
        const bonos = e.bonoQuincena || 0;
        const totalPercepciones = salarioQuincenal + horasExtra + bonos;
        
        const netoAPagar = totalPercepciones - totalDeducciones;
        
        return {
          ...e,
          salarioQuincenal,
          imss,
          isr,
          totalDeducciones,
          horasExtra,
          bonos,
          totalPercepciones,
          netoAPagar
        };
      });
      
      const totalNomina = nominaCalculada.reduce((sum, e) => sum + e.netoAPagar, 0);
      const totalDeducciones = nominaCalculada.reduce((sum, e) => sum + e.totalDeducciones, 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ’µ NÃ³mina</h2>
              <p class="text-gray-500">CÃ¡lculo y gestiÃ³n de pagos</p>
            </div>
            <div class="flex gap-2">
              <input type="month" value="${periodoActual}" onchange="window.periodoNomina = this.value; render()" class="p-3 border rounded-xl" />
              <button onclick="generarNominaCompleta()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-xl font-medium">
                ğŸ“„ Generar Recibos
              </button>
            </div>
          </div>

          <!-- Resumen -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Total a Pagar</p>
              <p class="text-3xl font-bold text-blue-700">${fmt(totalNomina)}</p>
            </div>
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Total Deducciones</p>
              <p class="text-3xl font-bold text-red-700">${fmt(totalDeducciones)}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Empleados en NÃ³mina</p>
              <p class="text-3xl font-bold text-green-700">${empleadosActivos.length}</p>
            </div>
          </div>

          <!-- Tabla de NÃ³mina -->
          <div class="bg-white rounded-2xl border overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Empleado</th>
                    <th class="px-4 py-3 text-left font-semibold">Puesto</th>
                    <th class="px-4 py-3 text-right font-semibold">Salario Base</th>
                    <th class="px-4 py-3 text-right font-semibold">Percepciones</th>
                    <th class="px-4 py-3 text-right font-semibold">Deducciones</th>
                    <th class="px-4 py-3 text-right font-semibold">Neto a Pagar</th>
                    <th class="px-4 py-3 text-center font-semibold">Acciones</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${nominaCalculada.length === 0 ? `
                    <tr>
                      <td colspan="7" class="px-4 py-12 text-center text-gray-400">
                        <p class="text-4xl mb-2">ğŸ’µ</p>
                        <p>No hay empleados en nÃ³mina</p>
                      </td>
                    </tr>
                  ` : nominaCalculada.map(e => {
                    const puesto = PUESTOS_DISPONIBLES.find(p => p.id === e.puesto);
                    return `
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                          <p class="font-medium">${e.nombre}</p>
                          <p class="text-xs text-gray-500">${TIPOS_CONTRATO.find(c => c.id === e.tipoContrato)?.nombre || ''}</p>
                        </td>
                        <td class="px-4 py-3">${puesto?.nombre || e.puesto || '-'}</td>
                        <td class="px-4 py-3 text-right">${fmt(e.salarioQuincenal)}</td>
                        <td class="px-4 py-3 text-right">
                          <p class="text-green-600">${fmt(e.totalPercepciones)}</p>
                          ${e.horasExtra > 0 ? `<p class="text-xs text-gray-500">+${fmt(e.horasExtra)} hrs extra</p>` : ''}
                        </td>
                        <td class="px-4 py-3 text-right">
                          <p class="text-red-600">-${fmt(e.totalDeducciones)}</p>
                          <p class="text-xs text-gray-500">IMSS: ${fmt(e.imss)}</p>
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-lg">${fmt(e.netoAPagar)}</td>
                        <td class="px-4 py-3 text-center">
                          <div class="flex justify-center gap-1">
                            <button onclick="editarNominaEmpleado('${e.id}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg" title="Editar">âœï¸</button>
                            <button onclick="generarRecibo('${e.id}')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg" title="Recibo">ğŸ“„</button>
                          </div>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
                <tfoot class="bg-gray-100 font-bold">
                  <tr>
                    <td colspan="3" class="px-4 py-3">TOTALES</td>
                    <td class="px-4 py-3 text-right text-green-600">${fmt(nominaCalculada.reduce((s, e) => s + e.totalPercepciones, 0))}</td>
                    <td class="px-4 py-3 text-right text-red-600">-${fmt(totalDeducciones)}</td>
                    <td class="px-4 py-3 text-right text-xl">${fmt(totalNomina)}</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // ========== PERSONAL - HORARIOS ==========
    function renderHorarios() {
      const empleadosActivos = empleados.filter(e => e.activo !== false);
      const empleadoSeleccionado = window.empleadoHorarioSeleccionado || null;
      const empleado = empleadoSeleccionado ? empleados.find(e => e.id === empleadoSeleccionado) : null;
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ• Horarios</h2>
              <p class="text-gray-500">AsignaciÃ³n de turnos y horarios</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Lista de Empleados -->
            <div class="bg-white rounded-2xl border p-4">
              <h3 class="font-semibold mb-4">Selecciona un empleado</h3>
              <div class="space-y-2 max-h-[500px] overflow-y-auto">
                ${empleadosActivos.map(e => {
                  const puesto = PUESTOS_DISPONIBLES.find(p => p.id === e.puesto);
                  const tieneHorario = e.horarios && Object.keys(e.horarios).length > 0;
                  return `
                    <div onclick="window.empleadoHorarioSeleccionado = '${e.id}'; render()" 
                      class="p-3 rounded-xl cursor-pointer transition-all flex items-center gap-3 ${empleadoSeleccionado === e.id ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'}">
                      <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center font-bold">
                        ${e.nombre?.charAt(0)?.toUpperCase() || '?'}
                      </div>
                      <div class="flex-1">
                        <p class="font-medium">${e.nombre}</p>
                        <p class="text-xs text-gray-500">${puesto?.nombre || ''}</p>
                      </div>
                      ${tieneHorario ? '<span class="text-green-500">âœ“</span>' : '<span class="text-gray-300">â—‹</span>'}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- Editor de Horario -->
            <div class="lg:col-span-2 bg-white rounded-2xl border p-6">
              ${empleado ? `
                <div class="flex justify-between items-center mb-6">
                  <div>
                    <h3 class="font-bold text-xl">${empleado.nombre}</h3>
                    <p class="text-gray-500">${PUESTOS_DISPONIBLES.find(p => p.id === empleado.puesto)?.nombre || ''}</p>
                  </div>
                  <button onclick="guardarHorarioEmpleado('${empleado.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl">
                    ğŸ’¾ Guardar Horario
                  </button>
                </div>

                <div class="space-y-3">
                  ${DIAS_SEMANA.map((dia, idx) => {
                    const horarioDia = empleado.horarios?.[dia.toLowerCase()] || { activo: false, entrada: '09:00', salida: '18:00' };
                    return `
                      <div class="flex items-center gap-4 p-3 rounded-xl ${horarioDia.activo ? 'bg-blue-50' : 'bg-gray-50'}">
                        <label class="flex items-center gap-2 w-32">
                          <input type="checkbox" id="dia-${idx}-activo" ${horarioDia.activo ? 'checked' : ''} 
                            onchange="toggleDiaHorario('${empleado.id}', '${dia.toLowerCase()}', this.checked)"
                            class="w-5 h-5 rounded" />
                          <span class="font-medium">${dia}</span>
                        </label>
                        <div class="flex items-center gap-2 ${horarioDia.activo ? '' : 'opacity-50'}">
                          <label class="text-sm text-gray-600">Entrada:</label>
                          <input type="time" id="dia-${idx}-entrada" value="${horarioDia.entrada}" 
                            ${horarioDia.activo ? '' : 'disabled'}
                            onchange="actualizarHorarioDia('${empleado.id}', '${dia.toLowerCase()}', 'entrada', this.value)"
                            class="p-2 border rounded-lg" />
                          <label class="text-sm text-gray-600 ml-4">Salida:</label>
                          <input type="time" id="dia-${idx}-salida" value="${horarioDia.salida}" 
                            ${horarioDia.activo ? '' : 'disabled'}
                            onchange="actualizarHorarioDia('${empleado.id}', '${dia.toLowerCase()}', 'salida', this.value)"
                            class="p-2 border rounded-lg" />
                          <span class="ml-4 text-sm text-gray-500">
                            ${horarioDia.activo ? calcularHorasTrabajo(horarioDia.entrada, horarioDia.salida) + ' hrs' : 'Descanso'}
                          </span>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                  <p class="text-sm text-gray-600">
                    Total horas semanales: 
                    <span class="font-bold text-lg">${calcularHorasSemanales(empleado.horarios)} hrs</span>
                  </p>
                </div>
              ` : `
                <div class="text-center py-12 text-gray-400">
                  <p class="text-4xl mb-4">ğŸ‘ˆ</p>
                  <p>Selecciona un empleado para editar su horario</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ========== PERSONAL - ASISTENCIA ==========
    function renderAsistencia() {
      const fechaFiltro = window.fechaAsistencia || new Date().toISOString().slice(0, 10);
      const empleadosActivos = empleados.filter(e => e.activo !== false);
      
      // Filtrar checadas del dÃ­a
      const checadasDia = checadas.filter(c => c.fecha === fechaFiltro);
      
      // Construir reporte de asistencia
      const reporteAsistencia = empleadosActivos.map(e => {
        const checadaEmpleado = checadasDia.find(c => c.empleadoId === e.id);
        const diaSemana = new Date(fechaFiltro + 'T12:00:00').toLocaleDateString('es-MX', { weekday: 'long' }).toLowerCase();
        const horarioEsperado = e.horarios?.[diaSemana];
        
        let estado = 'sin-registro';
        let minutosRetardo = 0;
        
        if (!horarioEsperado?.activo) {
          estado = 'descanso';
        } else if (checadaEmpleado) {
          if (checadaEmpleado.entrada) {
            const entradaEsperada = horarioEsperado.entrada;
            const entradaReal = checadaEmpleado.entrada;
            const diffMinutos = (new Date('2000-01-01T' + entradaReal) - new Date('2000-01-01T' + entradaEsperada)) / 60000;
            
            if (diffMinutos <= 10) {
              estado = 'puntual';
            } else {
              estado = 'retardo';
              minutosRetardo = Math.round(diffMinutos);
            }
          }
        } else if (horarioEsperado?.activo) {
          estado = 'falta';
        }
        
        return {
          ...e,
          checada: checadaEmpleado,
          horarioEsperado,
          estado,
          minutosRetardo
        };
      });
      
      const stats = {
        puntuales: reporteAsistencia.filter(r => r.estado === 'puntual').length,
        retardos: reporteAsistencia.filter(r => r.estado === 'retardo').length,
        faltas: reporteAsistencia.filter(r => r.estado === 'falta').length,
        descanso: reporteAsistencia.filter(r => r.estado === 'descanso').length
      };
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“‹ Control de Asistencia</h2>
              <p class="text-gray-500">Registro de entradas y salidas</p>
            </div>
            <div class="flex gap-2">
              <input type="date" value="${fechaFiltro}" onchange="window.fechaAsistencia = this.value; render()" class="p-3 border rounded-xl" />
              <button onclick="exportarAsistencia()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-medium">
                ğŸ“Š Exportar
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">âœ… Puntuales</p>
              <p class="text-3xl font-bold text-green-700">${stats.puntuales}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">â° Retardos</p>
              <p class="text-3xl font-bold text-yellow-700">${stats.retardos}</p>
            </div>
            <div class="bg-red-50 border border-red-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">âŒ Faltas</p>
              <p class="text-3xl font-bold text-red-700">${stats.faltas}</p>
            </div>
            <div class="bg-gray-50 border border-gray-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">ğŸ˜´ Descanso</p>
              <p class="text-3xl font-bold text-gray-700">${stats.descanso}</p>
            </div>
          </div>

          <!-- Tabla de Asistencia -->
          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Empleado</th>
                  <th class="px-4 py-3 text-center font-semibold">Horario Asignado</th>
                  <th class="px-4 py-3 text-center font-semibold">Entrada</th>
                  <th class="px-4 py-3 text-center font-semibold">Salida</th>
                  <th class="px-4 py-3 text-center font-semibold">Estado</th>
                  <th class="px-4 py-3 text-center font-semibold">Horas Trabajadas</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${reporteAsistencia.map(r => {
                  const puesto = PUESTOS_DISPONIBLES.find(p => p.id === r.puesto);
                  const estadoClases = {
                    'puntual': 'bg-green-100 text-green-800',
                    'retardo': 'bg-yellow-100 text-yellow-800',
                    'falta': 'bg-red-100 text-red-800',
                    'descanso': 'bg-gray-100 text-gray-600',
                    'sin-registro': 'bg-gray-100 text-gray-500'
                  };
                  const estadoTexto = {
                    'puntual': 'âœ… Puntual',
                    'retardo': `â° Retardo (${r.minutosRetardo} min)`,
                    'falta': 'âŒ Falta',
                    'descanso': 'ğŸ˜´ Descanso',
                    'sin-registro': 'â³ Sin registro'
                  };
                  
                  const horasTrabajadas = r.checada?.entrada && r.checada?.salida ? 
                    calcularHorasTrabajo(r.checada.entrada, r.checada.salida) : '-';
                  
                  return `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3">
                        <p class="font-medium">${r.nombre}</p>
                        <p class="text-xs text-gray-500">${puesto?.nombre || ''}</p>
                      </td>
                      <td class="px-4 py-3 text-center">
                        ${r.horarioEsperado?.activo ? 
                          `${r.horarioEsperado.entrada} - ${r.horarioEsperado.salida}` : 
                          '<span class="text-gray-400">Descanso</span>'}
                      </td>
                      <td class="px-4 py-3 text-center font-mono">
                        ${r.checada?.entrada || '-'}
                      </td>
                      <td class="px-4 py-3 text-center font-mono">
                        ${r.checada?.salida || '-'}
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${estadoClases[r.estado]}">${estadoTexto[r.estado]}</span>
                      </td>
                      <td class="px-4 py-3 text-center font-semibold">
                        ${horasTrabajadas !== '-' ? horasTrabajadas + ' hrs' : '-'}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Funciones auxiliares de horarios
    function calcularHorasTrabajo(entrada, salida) {
      if (!entrada || !salida) return 0;
      const [hE, mE] = entrada.split(':').map(Number);
      const [hS, mS] = salida.split(':').map(Number);
      const minutos = (hS * 60 + mS) - (hE * 60 + mE);
      return (minutos / 60).toFixed(1);
    }

    function calcularHorasSemanales(horarios) {
      if (!horarios) return 0;
      let total = 0;
      Object.values(horarios).forEach(h => {
        if (h.activo) {
          total += parseFloat(calcularHorasTrabajo(h.entrada, h.salida));
        }
      });
      return total.toFixed(1);
    }

    // Funciones de Personal
    window.verEmpleado = (id) => {
      itemEditando = empleados.find(e => e.id === id);
      modalAbierto = 'verEmpleado';
      render();
    };

    window.editarEmpleado = (id) => {
      itemEditando = empleados.find(e => e.id === id);
      modalAbierto = 'nuevoEmpleado';
      render();
    };

    window.toggleDiaHorario = (empleadoId, dia, activo) => {
      const emp = empleados.find(e => e.id === empleadoId);
      if (!emp.horarios) emp.horarios = {};
      if (!emp.horarios[dia]) emp.horarios[dia] = { entrada: '09:00', salida: '18:00' };
      emp.horarios[dia].activo = activo;
      render();
    };

    window.actualizarHorarioDia = (empleadoId, dia, campo, valor) => {
      const emp = empleados.find(e => e.id === empleadoId);
      if (!emp.horarios) emp.horarios = {};
      if (!emp.horarios[dia]) emp.horarios[dia] = { activo: true, entrada: '09:00', salida: '18:00' };
      emp.horarios[dia][campo] = valor;
      render();
    };

    window.guardarHorarioEmpleado = async (empleadoId) => {
      const emp = empleados.find(e => e.id === empleadoId);
      try {
        await updateDoc(doc(db, 'empleados', empleadoId), { horarios: emp.horarios });
        alert('âœ… Horario guardado correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.editarNominaEmpleado = (id) => {
      itemEditando = empleados.find(e => e.id === id);
      modalAbierto = 'editarNomina';
      render();
    };

    window.generarRecibo = async (empleadoId) => {
      const emp = empleados.find(e => e.id === empleadoId);
      if (!emp) return;
      itemEditando = emp;
      modalAbierto = 'generarRecibo';
      render();
    };

    window.generarContrato = (empleadoId) => {
      const emp = empleados.find(e => e.id === empleadoId);
      if (!emp) return;
      itemEditando = emp;
      modalAbierto = 'generarContrato';
      render();
    };

    window.generarNominaCompleta = () => {
      alert('Generando recibos de nÃ³mina para todos los empleados...\n\nEsta funciÃ³n generarÃ¡ un PDF con todos los recibos.');
    };

    window.exportarAsistencia = () => {
      alert('Exportando reporte de asistencia...');
    };
    function renderCalculadora() { 
      const subSeccion = window.calcSubSeccion || 'cotizador';
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ§® Calculadoras</h2>
              <p class="text-gray-500">Herramientas de cÃ¡lculo rÃ¡pido</p>
            </div>
          </div>

          <!-- Tabs -->
          <div class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl border">
            <button onclick="setCalcSubSeccion('cotizador')" class="px-4 py-2 rounded-xl font-medium transition-all ${subSeccion === 'cotizador' ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ğŸª Cotizador Eventos
            </button>
            <button onclick="setCalcSubSeccion('costos')" class="px-4 py-2 rounded-xl font-medium transition-all ${subSeccion === 'costos' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ğŸ½ï¸ Costos Platillos
            </button>
            <button onclick="setCalcSubSeccion('rentabilidad')" class="px-4 py-2 rounded-xl font-medium transition-all ${subSeccion === 'rentabilidad' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ğŸ’° Rentabilidad
            </button>
            <button onclick="setCalcSubSeccion('equilibrio')" class="px-4 py-2 rounded-xl font-medium transition-all ${subSeccion === 'equilibrio' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ğŸ“Š Punto de Equilibrio
            </button>
          </div>

          <!-- Contenido -->
          ${subSeccion === 'cotizador' ? renderCalcCotizador() : ''}
          ${subSeccion === 'costos' ? renderCalcCostos() : ''}
          ${subSeccion === 'rentabilidad' ? renderCalcRentabilidad() : ''}
          ${subSeccion === 'equilibrio' ? renderCalcEquilibrio() : ''}
        </div>
      `;
    }

    window.setCalcSubSeccion = (s) => { window.calcSubSeccion = s; render(); };

    // ========== COTIZADOR RÃPIDO DE EVENTOS ==========
    function renderCalcCotizador() {
      const calc = window.calcCotizador || { personas: 70, paquete: 'basico', alimento: 'taquiza', extras: [], horasExtra: 0 };
      
      const paquete = PAQUETES.find(p => p.id === calc.paquete) || PAQUETES[0];
      const preciosPersonas = paquete.precios[calc.personas] || paquete.precios[70] || { mobiliario: 22500, taquiza: 520, parrillada: 500 };
      
      const costoMobiliario = preciosPersonas.mobiliario || 0;
      const costoAlimentoPP = preciosPersonas[calc.alimento] || 0;
      const costoAlimento = costoAlimentoPP * calc.personas;
      const costoExtras = (calc.extras || []).reduce((sum, exId) => {
        const extra = EXTRAS.find(e => e.id === exId);
        return sum + (extra?.precio || 0);
      }, 0);
      const costoHorasExtra = (calc.horasExtra || 0) * 2950;
      const subtotal = costoMobiliario + costoAlimento + costoExtras + costoHorasExtra;
      const anticipo = subtotal * 0.2;
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl border p-6 space-y-5">
            <h3 class="font-bold text-lg text-emerald-700">ğŸª Datos del Evento</h3>
            
            <div>
              <label class="text-sm font-medium text-gray-700">NÃºmero de personas</label>
              <select onchange="updateCalcCotizador('personas', parseInt(this.value))" class="w-full mt-1 p-3 border rounded-xl">
                ${[25, 30, 50, 60, 70, 80, 100].map(n => `<option value="${n}" ${calc.personas === n ? 'selected' : ''}>${n} personas</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Paquete</label>
              <select onchange="updateCalcCotizador('paquete', this.value)" class="w-full mt-1 p-3 border rounded-xl">
                ${PAQUETES.map(p => `<option value="${p.id}" ${calc.paquete === p.id ? 'selected' : ''}>${p.nombre}</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Tipo de alimento</label>
              <select onchange="updateCalcCotizador('alimento', this.value)" class="w-full mt-1 p-3 border rounded-xl">
                ${TIPOS_ALIMENTO.map(t => `<option value="${t.id}" ${calc.alimento === t.id ? 'selected' : ''}>${t.nombre}</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Horas extra</label>
              <select onchange="updateCalcCotizador('horasExtra', parseInt(this.value))" class="w-full mt-1 p-3 border rounded-xl">
                ${[0, 1, 2, 3, 4, 5].map(n => `<option value="${n}" ${calc.horasExtra === n ? 'selected' : ''}>${n} hora${n !== 1 ? 's' : ''} extra ${n > 0 ? '($' + (n * 2950).toLocaleString() + ')' : ''}</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700 mb-2 block">Extras</label>
              <div class="grid grid-cols-2 gap-2">
                ${EXTRAS.filter(e => e.id !== 'hora_extra').map(e => `
                  <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                    <input type="checkbox" ${(calc.extras || []).includes(e.id) ? 'checked' : ''} onchange="toggleCalcExtra('${e.id}')" class="w-4 h-4 text-emerald-600" />
                    <span class="text-sm">${e.nombre}</span>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
            <h3 class="font-bold text-lg mb-6">ğŸ’° Resumen de CotizaciÃ³n</h3>
            
            <div class="space-y-4">
              <div class="flex justify-between py-2 border-b border-white/20">
                <span>Mobiliario y montaje</span>
                <span class="font-bold">${fmt(costoMobiliario)}</span>
              </div>
              <div class="flex justify-between py-2 border-b border-white/20">
                <span>Alimento (${calc.personas} personas x ${fmt(costoAlimentoPP)})</span>
                <span class="font-bold">${fmt(costoAlimento)}</span>
              </div>
              ${costoExtras > 0 ? `
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>Extras</span>
                  <span class="font-bold">${fmt(costoExtras)}</span>
                </div>
              ` : ''}
              ${costoHorasExtra > 0 ? `
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>Horas extra (${calc.horasExtra})</span>
                  <span class="font-bold">${fmt(costoHorasExtra)}</span>
                </div>
              ` : ''}
            </div>
            
            <div class="mt-6 pt-4 border-t-2 border-white/30">
              <div class="flex justify-between items-center">
                <span class="text-xl">TOTAL</span>
                <span class="text-4xl font-bold">${fmt(subtotal)}</span>
              </div>
              <div class="flex justify-between items-center mt-3 text-emerald-100">
                <span>Anticipo (20%)</span>
                <span class="font-bold text-lg">${fmt(anticipo)}</span>
              </div>
            </div>
            
            <div class="mt-6 p-4 bg-white/10 rounded-xl">
              <p class="text-sm text-emerald-100">
                <strong>Paquete:</strong> ${paquete.nombre}<br>
                <strong>Incluye:</strong> ${paquete.incluye?.slice(0, 3).join(', ')}...
              </p>
            </div>
          </div>
        </div>
      `;
    }

    window.updateCalcCotizador = (campo, valor) => {
      if (!window.calcCotizador) window.calcCotizador = { personas: 70, paquete: 'basico', alimento: 'taquiza', extras: [], horasExtra: 0 };
      window.calcCotizador[campo] = valor;
      render();
    };

    window.toggleCalcExtra = (id) => {
      if (!window.calcCotizador) window.calcCotizador = { personas: 70, paquete: 'basico', alimento: 'taquiza', extras: [], horasExtra: 0 };
      if (!window.calcCotizador.extras) window.calcCotizador.extras = [];
      if (window.calcCotizador.extras.includes(id)) {
        window.calcCotizador.extras = window.calcCotizador.extras.filter(e => e !== id);
      } else {
        window.calcCotizador.extras.push(id);
      }
      render();
    };

    // ========== CALCULADORA DE COSTOS DE PLATILLOS ==========
    function renderCalcCostos() {
      const calc = window.calcCostos || { precioVenta: 100, costoInsumos: 35, costoManoObra: 10, costosIndirectos: 5 };
      
      const costoTotal = calc.costoInsumos + calc.costoManoObra + calc.costosIndirectos;
      const utilidadBruta = calc.precioVenta - costoTotal;
      const margenBruto = calc.precioVenta > 0 ? (utilidadBruta / calc.precioVenta) * 100 : 0;
      const markup = costoTotal > 0 ? ((calc.precioVenta - costoTotal) / costoTotal) * 100 : 0;
      
      // Precio sugerido para diferentes mÃ¡rgenes
      const precioMargen50 = costoTotal / 0.5;
      const precioMargen60 = costoTotal / 0.4;
      const precioMargen70 = costoTotal / 0.3;
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl border p-6 space-y-5">
            <h3 class="font-bold text-lg text-amber-700">ğŸ½ï¸ Datos del Platillo</h3>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Precio de venta</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.precioVenta}" onchange="updateCalcCostos('precioVenta', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costo de insumos/ingredientes</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costoInsumos}" onchange="updateCalcCostos('costoInsumos', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costo de mano de obra (por platillo)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costoManoObra}" onchange="updateCalcCostos('costoManoObra', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costos indirectos (gas, luz, etc.)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costosIndirectos}" onchange="updateCalcCostos('costosIndirectos', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 text-white">
              <h3 class="font-bold text-lg mb-4">ğŸ“Š AnÃ¡lisis de Rentabilidad</h3>
              
              <div class="space-y-3">
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>Precio de venta</span>
                  <span class="font-bold">${fmt(calc.precioVenta)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>Costo total</span>
                  <span class="font-bold">-${fmt(costoTotal)}</span>
                </div>
                <div class="flex justify-between py-2 text-xl">
                  <span>Utilidad por platillo</span>
                  <span class="font-bold">${fmt(utilidadBruta)}</span>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-white/10 rounded-xl p-4 text-center">
                  <p class="text-amber-100 text-sm">Margen</p>
                  <p class="text-3xl font-bold">${margenBruto.toFixed(1)}%</p>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                  <p class="text-amber-100 text-sm">Markup</p>
                  <p class="text-3xl font-bold">${markup.toFixed(1)}%</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-2xl border p-5">
              <h4 class="font-semibold mb-3">ğŸ’¡ Precios sugeridos segÃºn margen</h4>
              <div class="space-y-2">
                <div class="flex justify-between p-3 bg-green-50 rounded-xl">
                  <span class="text-green-700">Margen 50%</span>
                  <span class="font-bold text-green-800">${fmt(precioMargen50)}</span>
                </div>
                <div class="flex justify-between p-3 bg-blue-50 rounded-xl">
                  <span class="text-blue-700">Margen 60%</span>
                  <span class="font-bold text-blue-800">${fmt(precioMargen60)}</span>
                </div>
                <div class="flex justify-between p-3 bg-purple-50 rounded-xl">
                  <span class="text-purple-700">Margen 70%</span>
                  <span class="font-bold text-purple-800">${fmt(precioMargen70)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.updateCalcCostos = (campo, valor) => {
      if (!window.calcCostos) window.calcCostos = { precioVenta: 100, costoInsumos: 35, costoManoObra: 10, costosIndirectos: 5 };
      window.calcCostos[campo] = valor || 0;
      render();
    };

    // ========== CALCULADORA DE RENTABILIDAD ==========
    function renderCalcRentabilidad() {
      const calc = window.calcRentabilidad || { tipo: 'restaurante', ingresos: 50000, costoVentas: 17500, gastosOperativos: 15000, gastosAdmin: 5000 };
      
      const utilidadBruta = calc.ingresos - calc.costoVentas;
      const margenBruto = calc.ingresos > 0 ? (utilidadBruta / calc.ingresos) * 100 : 0;
      const utilidadOperativa = utilidadBruta - calc.gastosOperativos;
      const margenOperativo = calc.ingresos > 0 ? (utilidadOperativa / calc.ingresos) * 100 : 0;
      const utilidadNeta = utilidadOperativa - calc.gastosAdmin;
      const margenNeto = calc.ingresos > 0 ? (utilidadNeta / calc.ingresos) * 100 : 0;
      
      // ROI si tuviÃ©ramos inversiÃ³n
      const inversionEstimada = calc.tipo === 'restaurante' ? 200000 : 500000;
      const roiAnual = inversionEstimada > 0 ? ((utilidadNeta * 12) / inversionEstimada) * 100 : 0;
      const mesesRecuperacion = utilidadNeta > 0 ? inversionEstimada / utilidadNeta : 0;
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl border p-6 space-y-5">
            <h3 class="font-bold text-lg text-indigo-700">ğŸ’° Datos Financieros (mensual)</h3>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Tipo de negocio</label>
              <select onchange="updateCalcRentabilidad('tipo', this.value)" class="w-full mt-1 p-3 border rounded-xl">
                <option value="restaurante" ${calc.tipo === 'restaurante' ? 'selected' : ''}>ğŸ½ï¸ Restaurante/AntojerÃ­a</option>
                <option value="jardin" ${calc.tipo === 'jardin' ? 'selected' : ''}>ğŸŒ¿ JardÃ­n de Eventos</option>
                <option value="combinado" ${calc.tipo === 'combinado' ? 'selected' : ''}>ğŸ¢ Negocio Combinado</option>
              </select>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Ingresos mensuales</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.ingresos}" onchange="updateCalcRentabilidad('ingresos', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costo de ventas (insumos, materia prima)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costoVentas}" onchange="updateCalcRentabilidad('costoVentas', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
              <p class="text-xs text-gray-400 mt-1">Recomendado: 30-35% de ingresos</p>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Gastos operativos (nÃ³mina, servicios, renta)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.gastosOperativos}" onchange="updateCalcRentabilidad('gastosOperativos', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Gastos administrativos (contabilidad, otros)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.gastosAdmin}" onchange="updateCalcRentabilidad('gastosAdmin', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white">
              <h3 class="font-bold text-lg mb-4">ğŸ“ˆ Estado de Resultados</h3>
              
              <div class="space-y-3">
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>Ingresos</span>
                  <span class="font-bold">${fmt(calc.ingresos)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20 text-indigo-200">
                  <span>(-) Costo de ventas</span>
                  <span>${fmt(calc.costoVentas)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>= Utilidad Bruta</span>
                  <span class="font-bold">${fmt(utilidadBruta)} <span class="text-sm">(${margenBruto.toFixed(1)}%)</span></span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20 text-indigo-200">
                  <span>(-) Gastos operativos</span>
                  <span>${fmt(calc.gastosOperativos)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20">
                  <span>= Utilidad Operativa</span>
                  <span class="font-bold">${fmt(utilidadOperativa)} <span class="text-sm">(${margenOperativo.toFixed(1)}%)</span></span>
                </div>
                <div class="flex justify-between py-2 border-b border-white/20 text-indigo-200">
                  <span>(-) Gastos administrativos</span>
                  <span>${fmt(calc.gastosAdmin)}</span>
                </div>
                <div class="flex justify-between py-3 text-xl">
                  <span>= UTILIDAD NETA</span>
                  <span class="font-bold ${utilidadNeta >= 0 ? '' : 'text-red-300'}">${fmt(utilidadNeta)}</span>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white rounded-2xl border p-5 text-center">
                <p class="text-sm text-gray-500">Margen Neto</p>
                <p class="text-3xl font-bold ${margenNeto >= 0 ? 'text-green-600' : 'text-red-600'}">${margenNeto.toFixed(1)}%</p>
                <p class="text-xs text-gray-400 mt-1">Ideal: 10-15%</p>
              </div>
              <div class="bg-white rounded-2xl border p-5 text-center">
                <p class="text-sm text-gray-500">Utilidad Anual Est.</p>
                <p class="text-3xl font-bold text-indigo-600">${fmt(utilidadNeta * 12)}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.updateCalcRentabilidad = (campo, valor) => {
      if (!window.calcRentabilidad) window.calcRentabilidad = { tipo: 'restaurante', ingresos: 50000, costoVentas: 17500, gastosOperativos: 15000, gastosAdmin: 5000 };
      window.calcRentabilidad[campo] = valor || 0;
      render();
    };

    // ========== PUNTO DE EQUILIBRIO ==========
    function renderCalcEquilibrio() {
      const calc = window.calcEquilibrio || { costosFijos: 25000, precioPromedio: 85, costoVariable: 30 };
      
      const margenContribucion = calc.precioPromedio - calc.costoVariable;
      const puntoEquilibrioUnidades = margenContribucion > 0 ? Math.ceil(calc.costosFijos / margenContribucion) : 0;
      const puntoEquilibrioPesos = puntoEquilibrioUnidades * calc.precioPromedio;
      
      // Por dÃ­a (asumiendo 26 dÃ­as de operaciÃ³n)
      const diasMes = 26;
      const ventasDiarias = Math.ceil(puntoEquilibrioUnidades / diasMes);
      const ingresosDiarios = ventasDiarias * calc.precioPromedio;
      
      // Escenarios
      const escenarios = [
        { nombre: 'MÃ­nimo', unidades: puntoEquilibrioUnidades, color: 'red' },
        { nombre: 'Meta +20%', unidades: Math.ceil(puntoEquilibrioUnidades * 1.2), color: 'yellow' },
        { nombre: 'Ã“ptimo +50%', unidades: Math.ceil(puntoEquilibrioUnidades * 1.5), color: 'green' }
      ];
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl border p-6 space-y-5">
            <h3 class="font-bold text-lg text-purple-700">ğŸ“Š Datos para Punto de Equilibrio</h3>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costos fijos mensuales</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costosFijos}" onchange="updateCalcEquilibrio('costosFijos', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
              <p class="text-xs text-gray-400 mt-1">Renta, nÃ³mina, servicios, etc. (no varÃ­an con las ventas)</p>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Precio de venta promedio por unidad</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.precioPromedio}" onchange="updateCalcEquilibrio('precioPromedio', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
              <p class="text-xs text-gray-400 mt-1">Ticket promedio o precio del platillo mÃ¡s vendido</p>
            </div>
            
            <div>
              <label class="text-sm font-medium text-gray-700">Costo variable por unidad</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-3 text-gray-500">$</span>
                <input type="number" value="${calc.costoVariable}" onchange="updateCalcEquilibrio('costoVariable', parseFloat(this.value))" class="w-full p-3 pl-8 border rounded-xl" />
              </div>
              <p class="text-xs text-gray-400 mt-1">Ingredientes, empaques, etc. (varÃ­an con cada venta)</p>
            </div>
            
            <div class="bg-purple-50 rounded-xl p-4">
              <p class="text-sm text-purple-700 font-medium">Margen de contribuciÃ³n por unidad:</p>
              <p class="text-2xl font-bold text-purple-800">${fmt(margenContribucion)}</p>
              <p class="text-xs text-purple-600">Precio (${fmt(calc.precioPromedio)}) - Costo Variable (${fmt(calc.costoVariable)})</p>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 text-white">
              <h3 class="font-bold text-lg mb-4">ğŸ¯ Punto de Equilibrio</h3>
              
              <div class="text-center py-4">
                <p class="text-purple-200 text-sm">Necesitas vender al mes:</p>
                <p class="text-5xl font-bold my-3">${puntoEquilibrioUnidades.toLocaleString()}</p>
                <p class="text-purple-200">unidades / platillos</p>
              </div>
              
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-white/10 rounded-xl p-4 text-center">
                  <p class="text-purple-200 text-sm">En pesos</p>
                  <p class="text-2xl font-bold">${fmt(puntoEquilibrioPesos)}</p>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                  <p class="text-purple-200 text-sm">Por dÃ­a (26 dÃ­as)</p>
                  <p class="text-2xl font-bold">${ventasDiarias} uds</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-2xl border p-5">
              <h4 class="font-semibold mb-3">ğŸ“ˆ Escenarios de Ventas</h4>
              <div class="space-y-3">
                ${escenarios.map(e => {
                  const ingresos = e.unidades * calc.precioPromedio;
                  const costosTotales = calc.costosFijos + (e.unidades * calc.costoVariable);
                  const utilidad = ingresos - costosTotales;
                  const bgColor = e.color === 'red' ? 'bg-red-50' : e.color === 'yellow' ? 'bg-yellow-50' : 'bg-green-50';
                  const textColor = e.color === 'red' ? 'text-red-700' : e.color === 'yellow' ? 'text-yellow-700' : 'text-green-700';
                  return `
                    <div class="p-4 ${bgColor} rounded-xl">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="font-medium ${textColor}">${e.nombre}</p>
                          <p class="text-sm text-gray-600">${e.unidades.toLocaleString()} unidades/mes</p>
                        </div>
                        <div class="text-right">
                          <p class="text-sm text-gray-500">Utilidad</p>
                          <p class="font-bold ${utilidad >= 0 ? 'text-green-600' : 'text-red-600'}">${fmt(utilidad)}</p>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.updateCalcEquilibrio = (campo, valor) => {
      if (!window.calcEquilibrio) window.calcEquilibrio = { costosFijos: 25000, precioPromedio: 85, costoVariable: 30 };
      window.calcEquilibrio[campo] = valor || 0;
      render();
    };
    function renderConfig() { 
      const tabConfig = window.tabConfigGeneral || 'negocio';
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ ConfiguraciÃ³n General</h2>
              <p class="text-gray-500">Personaliza tu sistema</p>
            </div>
          </div>

          <!-- Tabs -->
          <div class="flex flex-wrap gap-2 border-b pb-4">
            <button onclick="window.tabConfigGeneral = 'negocio'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'negocio' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸª Datos del Negocio
            </button>
            <button onclick="window.tabConfigGeneral = 'tickets'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'tickets' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸ§¾ Tickets
            </button>
            <button onclick="window.tabConfigGeneral = 'mesas'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'mesas' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸª‘ Mesas
            </button>
            <button onclick="window.tabConfigGeneral = 'horarios'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'horarios' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸ• Horarios
            </button>
            <button onclick="window.tabConfigGeneral = 'impuestos'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'impuestos' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸ’° Impuestos
            </button>
            <button onclick="window.tabConfigGeneral = 'respaldo'; render()" 
              class="px-4 py-2 rounded-xl font-medium ${tabConfig === 'respaldo' ? 'bg-slate-700 text-white' : 'bg-gray-100 hover:bg-gray-200'}">
              ğŸ’¾ Respaldo
            </button>
          </div>

          ${tabConfig === 'negocio' ? renderConfigNegocio() : ''}
          ${tabConfig === 'tickets' ? renderConfigTickets() : ''}
          ${tabConfig === 'mesas' ? renderConfigMesas() : ''}
          ${tabConfig === 'horarios' ? renderConfigHorarios() : ''}
          ${tabConfig === 'impuestos' ? renderConfigImpuestos() : ''}
          ${tabConfig === 'respaldo' ? renderConfigRespaldo() : ''}
        </div>
      `;
    }

    function renderConfigNegocio() {
      const config = window.configNegocio || {
        nombre: 'JardÃ­n Escondido',
        slogan: 'Restaurante & Eventos',
        direccion: '',
        telefono: '',
        email: '',
        rfc: '',
        regimenFiscal: '',
        redesSociales: { facebook: '', instagram: '', whatsapp: '' }
      };
      
      return `
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-bold text-lg mb-6">ğŸª Datos del Negocio</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Negocio</label>
              <input type="text" id="config-nombre" value="${config.nombre || ''}" placeholder="JardÃ­n Escondido" 
                class="w-full p-3 border rounded-xl" />
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Slogan / DescripciÃ³n</label>
              <input type="text" id="config-slogan" value="${config.slogan || ''}" placeholder="Restaurante & Eventos" 
                class="w-full p-3 border rounded-xl" />
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">DirecciÃ³n</label>
              <textarea id="config-direccion" rows="2" placeholder="Calle, nÃºmero, colonia, ciudad..." 
                class="w-full p-3 border rounded-xl">${config.direccion || ''}</textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">TelÃ©fono</label>
              <input type="tel" id="config-telefono" value="${config.telefono || ''}" placeholder="55 1234 5678" 
                class="w-full p-3 border rounded-xl" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="config-email" value="${config.email || ''}" placeholder="contacto@ejemplo.com" 
                class="w-full p-3 border rounded-xl" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">RFC</label>
              <input type="text" id="config-rfc" value="${config.rfc || ''}" placeholder="XXXX000000XXX" maxlength="13"
                class="w-full p-3 border rounded-xl uppercase" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">RÃ©gimen Fiscal</label>
              <select id="config-regimen" class="w-full p-3 border rounded-xl">
                <option value="">Seleccionar...</option>
                <option value="601" ${config.regimenFiscal === '601' ? 'selected' : ''}>601 - General de Ley Personas Morales</option>
                <option value="603" ${config.regimenFiscal === '603' ? 'selected' : ''}>603 - Personas Morales sin Fines de Lucro</option>
                <option value="605" ${config.regimenFiscal === '605' ? 'selected' : ''}>605 - Sueldos y Salarios</option>
                <option value="606" ${config.regimenFiscal === '606' ? 'selected' : ''}>606 - Arrendamiento</option>
                <option value="612" ${config.regimenFiscal === '612' ? 'selected' : ''}>612 - Personas FÃ­sicas con Actividades Empresariales</option>
                <option value="621" ${config.regimenFiscal === '621' ? 'selected' : ''}>621 - IncorporaciÃ³n Fiscal</option>
                <option value="626" ${config.regimenFiscal === '626' ? 'selected' : ''}>626 - RÃ©gimen Simplificado de Confianza</option>
              </select>
            </div>
          </div>
          
          <h4 class="font-semibold mt-6 mb-4">ğŸ“± Redes Sociales</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Facebook</label>
              <input type="text" id="config-facebook" value="${config.redesSociales?.facebook || ''}" placeholder="facebook.com/tunegocio" 
                class="w-full p-3 border rounded-xl" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Instagram</label>
              <input type="text" id="config-instagram" value="${config.redesSociales?.instagram || ''}" placeholder="@tunegocio" 
                class="w-full p-3 border rounded-xl" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp</label>
              <input type="text" id="config-whatsapp" value="${config.redesSociales?.whatsapp || ''}" placeholder="5512345678" 
                class="w-full p-3 border rounded-xl" />
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="guardarConfigNegocio()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium">
              ğŸ’¾ Guardar Datos del Negocio
            </button>
          </div>
        </div>
      `;
    }

    function renderConfigTickets() {
      const config = window.configTickets || {
        mostrarLogo: true,
        encabezado: 'Â¡Bienvenido!',
        piePagina: 'Â¡Gracias por su visita!',
        mostrarRedes: true,
        mostrarDireccion: true,
        anchoTicket: 80
      };
      
      return `
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-bold text-lg mb-6">ğŸ§¾ ConfiguraciÃ³n de Tickets</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-4">Contenido del Ticket</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje de Encabezado</label>
                  <input type="text" id="config-ticket-encabezado" value="${config.encabezado || ''}" 
                    placeholder="Â¡Bienvenido!" class="w-full p-3 border rounded-xl" />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje de Pie de PÃ¡gina</label>
                  <textarea id="config-ticket-pie" rows="2" placeholder="Â¡Gracias por su visita! Vuelva pronto." 
                    class="w-full p-3 border rounded-xl">${config.piePagina || ''}</textarea>
                </div>
                
                <div class="space-y-2">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="config-ticket-direccion" ${config.mostrarDireccion ? 'checked' : ''} class="w-5 h-5 rounded" />
                    <span>Mostrar direcciÃ³n en ticket</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="config-ticket-redes" ${config.mostrarRedes ? 'checked' : ''} class="w-5 h-5 rounded" />
                    <span>Mostrar redes sociales</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold mb-4">Vista Previa</h4>
              <div class="bg-gray-100 rounded-xl p-4 font-mono text-xs leading-relaxed">
                <div class="text-center border-b border-dashed border-gray-400 pb-2 mb-2">
                  <p class="font-bold text-sm">ğŸŒ¿ JARDÃN ESCONDIDO</p>
                  <p>Restaurante & Eventos</p>
                  <p class="text-gray-600 text-xs mt-1">${config.encabezado || 'Â¡Bienvenido!'}</p>
                </div>
                <div class="border-b border-dashed border-gray-400 pb-2 mb-2">
                  <p>Mesa 5 - #1234</p>
                  <p>Mesero: Juan</p>
                  <p>${new Date().toLocaleString('es-MX')}</p>
                </div>
                <div class="border-b border-dashed border-gray-400 pb-2 mb-2">
                  <p>2x Tacos Pastor.......$130.00</p>
                  <p>1x Agua Horchata.......$25.00</p>
                </div>
                <div class="border-b border-dashed border-gray-400 pb-2 mb-2">
                  <p class="font-bold">TOTAL: $155.00</p>
                </div>
                <div class="text-center text-gray-600">
                  <p>${config.piePagina || 'Â¡Gracias por su visita!'}</p>
                  ${config.mostrarRedes ? '<p class="mt-1">ğŸ“± @jardinescondido</p>' : ''}
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="guardarConfigTickets()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium">
              ğŸ’¾ Guardar ConfiguraciÃ³n de Tickets
            </button>
          </div>
        </div>
      `;
    }

    function renderConfigMesas() {
      const mesas = window.configMesas || [
        { id: 1, nombre: 'Mesa 1', capacidad: 2, zona: 'JardÃ­n', activa: true },
        { id: 2, nombre: 'Mesa 2', capacidad: 2, zona: 'JardÃ­n', activa: true },
        { id: 3, nombre: 'Mesa 3', capacidad: 4, zona: 'JardÃ­n', activa: true },
        { id: 4, nombre: 'Mesa 4', capacidad: 4, zona: 'JardÃ­n', activa: true },
        { id: 5, nombre: 'Mesa 5', capacidad: 6, zona: 'JardÃ­n', activa: true },
        { id: 6, nombre: 'Mesa 6', capacidad: 6, zona: 'JardÃ­n', activa: true },
        { id: 7, nombre: 'Mesa 7', capacidad: 8, zona: 'Terraza', activa: true },
        { id: 8, nombre: 'Mesa 8', capacidad: 8, zona: 'Terraza', activa: true },
        { id: 9, nombre: 'Mesa 9', capacidad: 10, zona: 'Terraza', activa: true },
        { id: 10, nombre: 'Mesa 10', capacidad: 10, zona: 'Terraza', activa: true },
        { id: 11, nombre: 'Mesa 11', capacidad: 15, zona: 'SalÃ³n', activa: true },
        { id: 12, nombre: 'Mesa 12', capacidad: 15, zona: 'SalÃ³n', activa: true }
      ];
      
      if (!window.configMesas) window.configMesas = mesas;
      
      const zonas = [...new Set(mesas.map(m => m.zona))];
      const capacidadTotal = mesas.filter(m => m.activa).reduce((sum, m) => sum + m.capacidad, 0);
      
      return `
        <div class="bg-white rounded-2xl border p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h3 class="font-bold text-lg">ğŸª‘ ConfiguraciÃ³n de Mesas</h3>
              <p class="text-sm text-gray-500">Total: ${mesas.filter(m => m.activa).length} mesas activas | Capacidad: ${capacidadTotal} personas</p>
            </div>
            <button onclick="agregarMesaConfig()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl">
              â• Agregar Mesa
            </button>
          </div>
          
          ${zonas.map(zona => `
            <div class="mb-6">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <span class="w-3 h-3 rounded-full ${zona === 'JardÃ­n' ? 'bg-green-500' : zona === 'Terraza' ? 'bg-blue-500' : 'bg-purple-500'}"></span>
                ${zona}
              </h4>
              <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                ${mesas.filter(m => m.zona === zona).map(mesa => `
                  <div class="relative p-4 rounded-xl border-2 ${mesa.activa ? 'bg-white border-gray-200' : 'bg-gray-100 border-gray-300 opacity-60'}">
                    <div class="text-center">
                      <p class="text-2xl mb-1">ğŸª‘</p>
                      <p class="font-bold">${mesa.nombre}</p>
                      <p class="text-sm text-gray-500">${mesa.capacidad} personas</p>
                    </div>
                    <div class="absolute top-2 right-2 flex gap-1">
                      <button onclick="editarMesaConfig(${mesa.id})" class="p-1 text-blue-600 hover:bg-blue-50 rounded">âœï¸</button>
                      <button onclick="toggleMesaConfig(${mesa.id})" class="p-1 ${mesa.activa ? 'text-red-600 hover:bg-red-50' : 'text-green-600 hover:bg-green-50'} rounded">
                        ${mesa.activa ? 'ğŸš«' : 'âœ…'}
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
          
          <div class="mt-6 p-4 bg-amber-50 rounded-xl">
            <p class="text-sm text-amber-800">
              <strong>ğŸ’¡ Nota:</strong> Los cambios en las mesas se reflejarÃ¡n en la app de meseros despuÃ©s de guardar y recargar.
            </p>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="guardarConfigMesas()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium">
              ğŸ’¾ Guardar ConfiguraciÃ³n de Mesas
            </button>
          </div>
        </div>
      `;
    }

    function renderConfigHorarios() {
      const config = window.configHorarios || {
        dias: {
          lunes: { abierto: true, apertura: '09:00', cierre: '22:00' },
          martes: { abierto: true, apertura: '09:00', cierre: '22:00' },
          miercoles: { abierto: true, apertura: '09:00', cierre: '22:00' },
          jueves: { abierto: true, apertura: '09:00', cierre: '22:00' },
          viernes: { abierto: true, apertura: '09:00', cierre: '23:00' },
          sabado: { abierto: true, apertura: '10:00', cierre: '23:00' },
          domingo: { abierto: true, apertura: '10:00', cierre: '20:00' }
        },
        horaCorte: '23:00',
        toleranciaEntrada: 10
      };
      
      if (!window.configHorarios) window.configHorarios = config;
      
      const diasNombres = {
        lunes: 'Lunes', martes: 'Martes', miercoles: 'MiÃ©rcoles', jueves: 'Jueves',
        viernes: 'Viernes', sabado: 'SÃ¡bado', domingo: 'Domingo'
      };
      
      return `
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-bold text-lg mb-6">ğŸ• Horarios de OperaciÃ³n</h3>
          
          <div class="space-y-3 mb-6">
            ${Object.entries(config.dias).map(([dia, horario]) => `
              <div class="flex items-center gap-4 p-3 rounded-xl ${horario.abierto ? 'bg-green-50' : 'bg-gray-100'}">
                <label class="flex items-center gap-2 w-32">
                  <input type="checkbox" id="horario-${dia}-abierto" ${horario.abierto ? 'checked' : ''} 
                    onchange="toggleDiaOperacion('${dia}', this.checked)"
                    class="w-5 h-5 rounded" />
                  <span class="font-medium">${diasNombres[dia]}</span>
                </label>
                <div class="flex items-center gap-2 ${horario.abierto ? '' : 'opacity-50'}">
                  <input type="time" id="horario-${dia}-apertura" value="${horario.apertura}" 
                    ${horario.abierto ? '' : 'disabled'}
                    onchange="actualizarHorarioOperacion('${dia}', 'apertura', this.value)"
                    class="p-2 border rounded-lg" />
                  <span>a</span>
                  <input type="time" id="horario-${dia}-cierre" value="${horario.cierre}" 
                    ${horario.abierto ? '' : 'disabled'}
                    onchange="actualizarHorarioOperacion('${dia}', 'cierre', this.value)"
                    class="p-2 border rounded-lg" />
                </div>
                <span class="text-sm text-gray-500 ml-auto">
                  ${horario.abierto ? calcularHorasOperacion(horario.apertura, horario.cierre) + ' hrs' : 'Cerrado'}
                </span>
              </div>
            `).join('')}
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 rounded-xl">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Hora de Corte de Caja</label>
              <input type="time" id="config-hora-corte" value="${config.horaCorte}" class="w-full p-3 border rounded-xl" />
              <p class="text-xs text-gray-500 mt-1">Hora lÃ­mite para cerrar la caja del dÃ­a</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tolerancia de Entrada (minutos)</label>
              <input type="number" id="config-tolerancia" value="${config.toleranciaEntrada}" min="0" max="30" class="w-full p-3 border rounded-xl" />
              <p class="text-xs text-gray-500 mt-1">Minutos de tolerancia antes de marcar retardo</p>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="guardarConfigHorarios()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium">
              ğŸ’¾ Guardar Horarios
            </button>
          </div>
        </div>
      `;
    }

    function renderConfigImpuestos() {
      const config = window.configImpuestos || {
        iva: 16,
        aplicarIvaAutomatico: false,
        propinaSugerida: [10, 15, 20],
        mostrarPropinaSugerida: true
      };
      
      if (!window.configImpuestos) window.configImpuestos = config;
      
      return `
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-bold text-lg mb-6">ğŸ’° Impuestos y Propinas</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 bg-blue-50 rounded-xl">
              <h4 class="font-semibold mb-4">ğŸ§¾ IVA</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Porcentaje de IVA</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="config-iva" value="${config.iva}" min="0" max="100" step="0.5" class="w-24 p-3 border rounded-xl text-center text-lg font-bold" />
                    <span class="text-lg">%</span>
                  </div>
                </div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="config-iva-auto" ${config.aplicarIvaAutomatico ? 'checked' : ''} class="w-5 h-5 rounded" />
                  <span>Aplicar IVA automÃ¡ticamente en Ã³rdenes</span>
                </label>
              </div>
            </div>
            
            <div class="p-4 bg-green-50 rounded-xl">
              <h4 class="font-semibold mb-4">ğŸ’µ Propinas</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Porcentajes Sugeridos</label>
                  <div class="flex gap-2">
                    <input type="number" id="config-propina-1" value="${config.propinaSugerida[0] || 10}" min="0" max="100" class="w-20 p-2 border rounded-lg text-center" />
                    <input type="number" id="config-propina-2" value="${config.propinaSugerida[1] || 15}" min="0" max="100" class="w-20 p-2 border rounded-lg text-center" />
                    <input type="number" id="config-propina-3" value="${config.propinaSugerida[2] || 20}" min="0" max="100" class="w-20 p-2 border rounded-lg text-center" />
                    <span class="self-center text-gray-500">%</span>
                  </div>
                </div>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="config-propina-mostrar" ${config.mostrarPropinaSugerida ? 'checked' : ''} class="w-5 h-5 rounded" />
                  <span>Mostrar propina sugerida al cobrar</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button onclick="guardarConfigImpuestos()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium">
              ğŸ’¾ Guardar ConfiguraciÃ³n
            </button>
          </div>
        </div>
      `;
    }

    function renderConfigRespaldo() {
      return `
        <div class="bg-white rounded-2xl border p-6">
          <h3 class="font-bold text-lg mb-6">ğŸ’¾ Respaldo de Datos</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-6 bg-blue-50 rounded-xl text-center">
              <div class="text-4xl mb-3">ğŸ“¤</div>
              <h4 class="font-semibold mb-2">Exportar Datos</h4>
              <p class="text-sm text-gray-600 mb-4">Descarga un respaldo de toda la configuraciÃ³n y datos del sistema.</p>
              <button onclick="exportarDatos()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium">
                Descargar Respaldo
              </button>
            </div>
            
            <div class="p-6 bg-amber-50 rounded-xl text-center">
              <div class="text-4xl mb-3">ğŸ“¥</div>
              <h4 class="font-semibold mb-2">Importar Datos</h4>
              <p class="text-sm text-gray-600 mb-4">Restaura datos desde un archivo de respaldo previo.</p>
              <label class="block">
                <input type="file" id="archivo-respaldo" accept=".json" class="hidden" onchange="importarDatos(this.files[0])" />
                <span class="block w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl font-medium cursor-pointer">
                  Seleccionar Archivo
                </span>
              </label>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-red-50 rounded-xl">
            <h4 class="font-semibold text-red-800 mb-2">âš ï¸ Zona de Peligro</h4>
            <p class="text-sm text-red-700 mb-4">Estas acciones son irreversibles. Ãšsalas con precauciÃ³n.</p>
            <div class="flex gap-3">
              <button onclick="limpiarDatosDemo()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl text-sm">
                Limpiar datos de ejemplo
              </button>
              <button onclick="reiniciarConfiguracion()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl text-sm">
                Reiniciar configuraciÃ³n
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function calcularHorasOperacion(apertura, cierre) {
      if (!apertura || !cierre) return 0;
      const [hA, mA] = apertura.split(':').map(Number);
      const [hC, mC] = cierre.split(':').map(Number);
      const minutos = (hC * 60 + mC) - (hA * 60 + mA);
      return (minutos / 60).toFixed(1);
    }

    // Funciones de configuraciÃ³n
    window.toggleDiaOperacion = (dia, abierto) => {
      if (!window.configHorarios) window.configHorarios = {};
      if (!window.configHorarios.dias) window.configHorarios.dias = {};
      if (!window.configHorarios.dias[dia]) window.configHorarios.dias[dia] = { apertura: '09:00', cierre: '22:00' };
      window.configHorarios.dias[dia].abierto = abierto;
      render();
    };

    window.actualizarHorarioOperacion = (dia, campo, valor) => {
      if (!window.configHorarios?.dias?.[dia]) return;
      window.configHorarios.dias[dia][campo] = valor;
      render();
    };

    window.agregarMesaConfig = () => {
      const nombre = prompt('Nombre de la mesa (ej: Mesa 13):');
      if (!nombre) return;
      const capacidad = parseInt(prompt('Capacidad (nÃºmero de personas):')) || 4;
      const zona = prompt('Zona (ej: JardÃ­n, Terraza, SalÃ³n):') || 'JardÃ­n';
      
      const nuevoId = Math.max(...window.configMesas.map(m => m.id), 0) + 1;
      window.configMesas.push({ id: nuevoId, nombre, capacidad, zona, activa: true });
      render();
    };

    window.editarMesaConfig = (id) => {
      const mesa = window.configMesas.find(m => m.id === id);
      if (!mesa) return;
      
      const nombre = prompt('Nombre de la mesa:', mesa.nombre);
      if (nombre === null) return;
      const capacidad = parseInt(prompt('Capacidad:', mesa.capacidad)) || mesa.capacidad;
      const zona = prompt('Zona:', mesa.zona) || mesa.zona;
      
      mesa.nombre = nombre;
      mesa.capacidad = capacidad;
      mesa.zona = zona;
      render();
    };

    window.toggleMesaConfig = (id) => {
      const mesa = window.configMesas.find(m => m.id === id);
      if (mesa) {
        mesa.activa = !mesa.activa;
        render();
      }
    };

    window.guardarConfigNegocio = async () => {
      const config = {
        nombre: document.getElementById('config-nombre').value.trim(),
        slogan: document.getElementById('config-slogan').value.trim(),
        direccion: document.getElementById('config-direccion').value.trim(),
        telefono: document.getElementById('config-telefono').value.trim(),
        email: document.getElementById('config-email').value.trim(),
        rfc: document.getElementById('config-rfc').value.trim().toUpperCase(),
        regimenFiscal: document.getElementById('config-regimen').value,
        redesSociales: {
          facebook: document.getElementById('config-facebook').value.trim(),
          instagram: document.getElementById('config-instagram').value.trim(),
          whatsapp: document.getElementById('config-whatsapp').value.trim()
        }
      };
      
      try {
        await setDoc(doc(db, 'configuracion', 'negocio'), { ...config, fechaActualizacion: serverTimestamp() });
        window.configNegocio = config;
        alert('âœ… Datos del negocio guardados');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarConfigTickets = async () => {
      const config = {
        encabezado: document.getElementById('config-ticket-encabezado').value.trim(),
        piePagina: document.getElementById('config-ticket-pie').value.trim(),
        mostrarDireccion: document.getElementById('config-ticket-direccion').checked,
        mostrarRedes: document.getElementById('config-ticket-redes').checked
      };
      
      try {
        await setDoc(doc(db, 'configuracion', 'tickets'), { ...config, fechaActualizacion: serverTimestamp() });
        window.configTickets = config;
        alert('âœ… ConfiguraciÃ³n de tickets guardada');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarConfigMesas = async () => {
      try {
        await setDoc(doc(db, 'configuracion', 'mesas'), { lista: window.configMesas, fechaActualizacion: serverTimestamp() });
        alert('âœ… ConfiguraciÃ³n de mesas guardada\n\nRecarga la app de meseros para ver los cambios.');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarConfigHorarios = async () => {
      const config = {
        ...window.configHorarios,
        horaCorte: document.getElementById('config-hora-corte').value,
        toleranciaEntrada: parseInt(document.getElementById('config-tolerancia').value) || 10
      };
      
      try {
        await setDoc(doc(db, 'configuracion', 'horarios'), { ...config, fechaActualizacion: serverTimestamp() });
        window.configHorarios = config;
        alert('âœ… Horarios guardados');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarConfigImpuestos = async () => {
      const config = {
        iva: parseFloat(document.getElementById('config-iva').value) || 16,
        aplicarIvaAutomatico: document.getElementById('config-iva-auto').checked,
        propinaSugerida: [
          parseInt(document.getElementById('config-propina-1').value) || 10,
          parseInt(document.getElementById('config-propina-2').value) || 15,
          parseInt(document.getElementById('config-propina-3').value) || 20
        ],
        mostrarPropinaSugerida: document.getElementById('config-propina-mostrar').checked
      };
      
      try {
        await setDoc(doc(db, 'configuracion', 'impuestos'), { ...config, fechaActualizacion: serverTimestamp() });
        window.configImpuestos = config;
        alert('âœ… ConfiguraciÃ³n de impuestos guardada');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.exportarDatos = async () => {
      try {
        const datos = {
          fecha: new Date().toISOString(),
          version: '1.0',
          negocio: window.configNegocio,
          tickets: window.configTickets,
          mesas: window.configMesas,
          horarios: window.configHorarios,
          impuestos: window.configImpuestos,
          productos: productos,
          empleados: empleados,
          proveedores: proveedores
        };
        
        const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `respaldo-jardin-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('âœ… Respaldo descargado');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.importarDatos = async (archivo) => {
      if (!archivo) return;
      
      if (!confirm('âš ï¸ Esto sobrescribirÃ¡ la configuraciÃ³n actual. Â¿Continuar?')) return;
      
      try {
        const texto = await archivo.text();
        const datos = JSON.parse(texto);
        
        if (datos.negocio) await setDoc(doc(db, 'configuracion', 'negocio'), datos.negocio);
        if (datos.tickets) await setDoc(doc(db, 'configuracion', 'tickets'), datos.tickets);
        if (datos.mesas) await setDoc(doc(db, 'configuracion', 'mesas'), { lista: datos.mesas });
        if (datos.horarios) await setDoc(doc(db, 'configuracion', 'horarios'), datos.horarios);
        if (datos.impuestos) await setDoc(doc(db, 'configuracion', 'impuestos'), datos.impuestos);
        
        alert('âœ… Datos importados. Recarga la pÃ¡gina para ver los cambios.');
        location.reload();
      } catch (e) {
        alert('Error al importar: ' + e.message);
      }
    };

    window.limpiarDatosDemo = () => {
      if (!confirm('âš ï¸ Â¿Eliminar todos los datos de ejemplo? Esta acciÃ³n no se puede deshacer.')) return;
      alert('FunciÃ³n disponible prÃ³ximamente');
    };

    window.reiniciarConfiguracion = () => {
      if (!confirm('âš ï¸ Â¿Reiniciar toda la configuraciÃ³n a valores por defecto? Esta acciÃ³n no se puede deshacer.')) return;
      alert('FunciÃ³n disponible prÃ³ximamente');
    };

    // ========== ADMINISTRACIÃ“N - USUARIOS ==========
    const getRolSistema = (id) => ROLES_SISTEMA.find(r => r.id === id) || ROLES_SISTEMA[4];

    async function cargarUsuariosSistema() {
      try {
        const snap = await getDocs(collection(db, 'usuarios'));
        usuariosSistema = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error('Error cargando usuarios:', e);
        usuariosSistema = [];
      }
    }

    function renderAdminUsuarios() {
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¥ GestiÃ³n de Usuarios</h2>
              <p class="text-gray-500">Administra los usuarios y sus permisos</p>
            </div>
            <div class="flex gap-3">
              <button onclick="cargarUsuariosSistemaBtn()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-xl font-medium">
                ğŸ”„ Actualizar
              </button>
              <button onclick="abrirModal('nuevoUsuario')" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-3 rounded-xl font-medium">
                â• Nuevo Usuario
              </button>
            </div>
          </div>

          <div class="bg-white rounded-2xl border p-6">
            <h3 class="font-semibold mb-4">ğŸ­ Roles Disponibles</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
              ${ROLES_SISTEMA.map(rol => `
                <div class="p-4 bg-gray-50 rounded-xl">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">${rol.icono}</span>
                    <span class="font-medium">${rol.nombre}</span>
                  </div>
                  <p class="text-xs text-gray-500">${rol.descripcion}</p>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-6 py-4 text-left font-semibold text-gray-700">Usuario</th>
                  <th class="px-6 py-4 text-left font-semibold text-gray-700">Rol</th>
                  <th class="px-6 py-4 text-left font-semibold text-gray-700">Fecha CreaciÃ³n</th>
                  <th class="px-6 py-4 text-left font-semibold text-gray-700">Estado</th>
                  <th class="px-6 py-4 text-right font-semibold text-gray-700">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${usuariosSistema.length === 0 ? `
                  <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                      <p class="text-4xl mb-2">ğŸ‘¥</p>
                      <p>No hay usuarios registrados</p>
                      <button onclick="cargarUsuariosSistemaBtn()" class="mt-4 text-purple-600 hover:text-purple-800">Cargar usuarios</button>
                    </td>
                  </tr>
                ` : usuariosSistema.map(u => {
                  const rol = getRolSistema(u.rol);
                  const fechaCreacion = u.fechaCreacion?.toDate?.() ? fmtFechaHora(u.fechaCreacion.toDate()) : (u.fechaCreacion || '-');
                  return `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4">
                        <div>
                          <p class="font-medium text-gray-800">${u.nombre || 'Sin nombre'}</p>
                          <p class="text-sm text-gray-500">${u.email}</p>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${rol.color}">
                          ${rol.icono} ${rol.nombre}
                        </span>
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-600">${fechaCreacion}</td>
                      <td class="px-6 py-4">
                        ${u.activo !== false ? `
                          <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">âœ“ Activo</span>
                        ` : `
                          <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">âœ• Inactivo</span>
                        `}
                      </td>
                      <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                          <button onclick="editarUsuarioSistema('${u.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Editar">âœï¸</button>
                          ${u.id !== usuario.uid ? `
                            <button onclick="toggleUsuarioActivo('${u.id}', ${u.activo === false})" 
                              class="p-2 ${u.activo !== false ? 'text-red-600 hover:bg-red-50' : 'text-green-600 hover:bg-green-50'} rounded-lg" 
                              title="${u.activo !== false ? 'Desactivar' : 'Activar'}">
                              ${u.activo !== false ? 'ğŸš«' : 'âœ…'}
                            </button>
                          ` : ''}
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-2xl p-5">
            <h4 class="font-semibold text-blue-800 mb-2">ğŸ“± URLs para tu equipo:</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div class="bg-white rounded-lg p-3">
                <span class="font-medium">Meseros:</span>
                <code class="ml-2 text-blue-600">jardin-escondido.netlify.app/meseros</code>
              </div>
              <div class="bg-white rounded-lg p-3">
                <span class="font-medium">Cocina:</span>
                <code class="ml-2 text-blue-600">jardin-escondido.netlify.app/cocina</code>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== ADMINISTRACIÃ“N - Ã“RDENES ==========
    function renderAdminOrdenes() {
      const ordenesFiltradas = ordenesRestaurante.slice(0, 100);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“‹ Ã“rdenes del Restaurante</h2>
              <p class="text-gray-500">Gestiona y limpia Ã³rdenes</p>
            </div>
            <div class="flex gap-3">
              <button onclick="cargarDatos()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-xl font-medium">ğŸ”„ Actualizar</button>
              <button onclick="eliminarTodasOrdenesAdmin()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium">ğŸ—‘ï¸ Eliminar Todas</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl border p-5">
              <p class="text-sm text-gray-500">Total Ã“rdenes</p>
              <p class="text-3xl font-bold text-gray-800">${ordenesRestaurante.length}</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Pendientes</p>
              <p class="text-3xl font-bold text-yellow-700">${ordenesRestaurante.filter(o => o.estado === 'pendiente').length}</p>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Preparando</p>
              <p class="text-3xl font-bold text-blue-700">${ordenesRestaurante.filter(o => o.estado === 'preparando').length}</p>
            </div>
            <div class="bg-green-50 border border-green-100 rounded-2xl p-5">
              <p class="text-sm text-gray-500">Completadas</p>
              <p class="text-3xl font-bold text-green-700">${ordenesRestaurante.filter(o => ['listo', 'entregado', 'pagado'].includes(o.estado)).length}</p>
            </div>
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Orden</th>
                  <th class="px-4 py-3 text-left font-semibold">Fecha</th>
                  <th class="px-4 py-3 text-left font-semibold">Mesa</th>
                  <th class="px-4 py-3 text-left font-semibold">Mesero</th>
                  <th class="px-4 py-3 text-left font-semibold">Total</th>
                  <th class="px-4 py-3 text-left font-semibold">Estado</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${ordenesFiltradas.length === 0 ? `
                  <tr>
                    <td colspan="7" class="px-4 py-12 text-center text-gray-400">
                      <p class="text-4xl mb-2">ğŸ“‹</p>
                      <p>No hay Ã³rdenes</p>
                    </td>
                  </tr>
                ` : ordenesFiltradas.map(o => {
                  const fechaOrden = o.fechaCreacion?.toDate?.() ? fmtFechaHora(o.fechaCreacion.toDate()) : (o.fecha ? fmtFecha(o.fecha) : '-');
                  return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold">#${o.numero || o.id?.slice(-4)}</td>
                    <td class="px-4 py-3 text-gray-600">${fechaOrden}</td>
                    <td class="px-4 py-3">${o.mesa?.nombre || '-'}</td>
                    <td class="px-4 py-3">${o.meseroNombre || '-'}</td>
                    <td class="px-4 py-3 font-semibold">${fmt(o.total)}</td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded-full text-xs font-medium ${
                        o.estado === 'pendiente' ? 'bg-yellow-100 text-yellow-800' :
                        o.estado === 'preparando' ? 'bg-blue-100 text-blue-800' :
                        o.estado === 'listo' ? 'bg-green-100 text-green-800' :
                        o.estado === 'entregado' ? 'bg-purple-100 text-purple-800' :
                        o.estado === 'pagado' ? 'bg-emerald-100 text-emerald-800' :
                        'bg-gray-100 text-gray-800'
                      }">${o.estado || 'sin estado'}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <button onclick="eliminarOrdenAdmin('${o.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== ADMINISTRACIÃ“N - DATOS ==========
    function renderAdminDatos() {
      const colecciones = [
        { id: 'ordenesRestaurante', nombre: 'Ã“rdenes Restaurante', icono: 'ğŸ“‹' },
        { id: 'productos', nombre: 'Productos', icono: 'ğŸ½ï¸' },
        { id: 'insumos', nombre: 'Insumos', icono: 'ğŸ¥¬' },
        { id: 'recetas', nombre: 'Recetas', icono: 'ğŸ“–' },
        { id: 'cotizaciones', nombre: 'Cotizaciones', icono: 'ğŸ“' },
        { id: 'gastos', nombre: 'Gastos', icono: 'ğŸ§¾' },
        { id: 'clientesJardin', nombre: 'Clientes JardÃ­n', icono: 'ğŸ‘¥' },
        { id: 'proveedores', nombre: 'Proveedores', icono: 'ğŸ“' },
        { id: 'visitas', nombre: 'Visitas', icono: 'ğŸ—“ï¸' },
        { id: 'empleados', nombre: 'Empleados', icono: 'ğŸ‘·' },
        { id: 'listaCompras', nombre: 'Lista de Compras', icono: 'ğŸ›’' },
      ];

      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ—„ï¸ GestiÃ³n de Datos</h2>
              <p class="text-gray-500">Limpia datos de prueba por colecciÃ³n</p>
            </div>
          </div>

          <div class="bg-red-50 border border-red-200 rounded-2xl p-6">
            <div class="flex items-start gap-4">
              <span class="text-3xl">âš ï¸</span>
              <div>
                <h3 class="font-bold text-red-800">Zona de Peligro</h3>
                <p class="text-red-700 text-sm mt-1">Estas acciones eliminan datos permanentemente. Ãšsalas solo para limpiar datos de prueba.</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${colecciones.map(col => `
              <div class="bg-white rounded-2xl border p-5">
                <div class="flex items-center gap-3 mb-4">
                  <span class="text-3xl">${col.icono}</span>
                  <div>
                    <h4 class="font-semibold">${col.nombre}</h4>
                    <p class="text-xs text-gray-500">${col.id}</p>
                  </div>
                </div>
                <button onclick="limpiarColeccionAdmin('${col.id}')" 
                  class="w-full bg-red-100 hover:bg-red-200 text-red-700 py-2 rounded-xl font-medium text-sm transition-colors">
                  ğŸ—‘ï¸ Limpiar ColecciÃ³n
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // ========== FUNCIONES DE ADMINISTRACIÃ“N ==========
    window.cargarUsuariosSistemaBtn = async () => {
      await cargarUsuariosSistema();
      render();
    };

    window.editarUsuarioSistema = (uid) => {
      itemEditando = usuariosSistema.find(u => u.id === uid);
      modalAbierto = 'editarUsuarioSistema';
      render();
    };

    window.toggleUsuarioActivo = async (uid, activar) => {
      try {
        await updateDoc(doc(db, 'usuarios', uid), {
          activo: activar,
          fechaActualizacion: serverTimestamp()
        });
        await cargarUsuariosSistema();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarNuevoUsuarioSistema = async () => {
      const nombre = document.getElementById('nuevo-nombre').value;
      const email = document.getElementById('nuevo-email').value;
      const password = document.getElementById('nuevo-password').value;
      const rol = document.getElementById('nuevo-rol').value;

      if (!nombre || !email || !password) {
        alert('Completa todos los campos');
        return;
      }

      try {
        const credencial = await createUserWithEmailAndPassword(auth, email, password);
        const uid = credencial.user.uid;
        
        await setDoc(doc(db, 'usuarios', uid), {
          email: email,
          nombre: nombre,
          rol: rol,
          activo: true,
          fechaCreacion: serverTimestamp(),
          creadoPor: usuario.uid
        });
        
        alert('âœ… Usuario creado correctamente');
        await cargarUsuariosSistema();
        cerrarModal();
        render();
      } catch (e) {
        if (e.code === 'auth/email-already-in-use') {
          alert('âŒ Este correo ya estÃ¡ registrado');
        } else if (e.code === 'auth/weak-password') {
          alert('âŒ La contraseÃ±a debe tener al menos 6 caracteres');
        } else {
          alert('âŒ Error: ' + e.message);
        }
      }
    };

    window.guardarEditarUsuarioSistema = async () => {
      if (!itemEditando) return;
      const nombre = document.getElementById('editar-nombre').value;
      const rol = document.getElementById('editar-rol').value;
      
      try {
        await updateDoc(doc(db, 'usuarios', itemEditando.id), {
          nombre: nombre,
          rol: rol,
          fechaActualizacion: serverTimestamp()
        });
        alert('âœ… Usuario actualizado');
        await cargarUsuariosSistema();
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.eliminarOrdenAdmin = async (ordenId) => {
      if (!confirm('Â¿Eliminar esta orden?')) return;
      try {
        await deleteDoc(doc(db, 'ordenesRestaurante', ordenId));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.eliminarTodasOrdenesAdmin = async () => {
      if (!confirm('âš ï¸ Â¿ELIMINAR TODAS LAS Ã“RDENES?\n\nEsta acciÃ³n no se puede deshacer.')) return;
      
      try {
        for (const orden of ordenesRestaurante) {
          await deleteDoc(doc(db, 'ordenesRestaurante', orden.id));
        }
        alert(`âœ… Se eliminaron ${ordenesRestaurante.length} Ã³rdenes`);
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.limpiarColeccionAdmin = async (nombreColeccion) => {
      if (!confirm(`âš ï¸ Â¿Eliminar TODOS los documentos de "${nombreColeccion}"?\n\nEsta acciÃ³n no se puede deshacer.`)) return;
      
      try {
        const snap = await getDocs(collection(db, nombreColeccion));
        let count = 0;
        for (const docSnap of snap.docs) {
          await deleteDoc(doc(db, nombreColeccion, docSnap.id));
          count++;
        }
        alert(`âœ… Se eliminaron ${count} documentos de ${nombreColeccion}`);
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES PARA VISITAS ==========
    window.guardarVisita = async () => {
      const datos = {
        fecha: document.getElementById('visita-fecha').value,
        hora: document.getElementById('visita-hora').value,
        cliente: document.getElementById('visita-cliente').value,
        telefono: document.getElementById('visita-telefono').value,
        email: document.getElementById('visita-email').value,
        tipoEvento: document.getElementById('visita-tipoEvento').value,
        personas: document.getElementById('visita-personas').value,
        notas: document.getElementById('visita-notas').value,
        estado: itemEditando?.estado || 'programada'
      };
      
      if (!datos.fecha || !datos.cliente) {
        alert('Por favor completa fecha y nombre del cliente');
        return;
      }
      
      try {
        if (itemEditando) {
          await updateDoc(doc(db, 'visitas', itemEditando.id), datos);
        } else {
          await addDoc(collection(db, 'visitas'), { ...datos, fechaCreacion: serverTimestamp() });
        }
        await cargarDatos();
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.editarVisita = (id) => {
      itemEditando = visitas.find(v => v.id === id);
      modalAbierto = 'visita';
      render();
    };

    window.eliminarVisita = async (id) => {
      if (!confirm('Â¿Eliminar esta visita?')) return;
      try {
        await deleteDoc(doc(db, 'visitas', id));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.completarVisita = async (id) => {
      try {
        await updateDoc(doc(db, 'visitas', id), { estado: 'completada' });
        const visita = visitas.find(v => v.id === id);
        if (visita) visita.estado = 'completada';
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.cancelarVisita = async (id) => {
      if (!confirm('Â¿Cancelar esta visita?')) return;
      try {
        await updateDoc(doc(db, 'visitas', id), { estado: 'cancelada' });
        const visita = visitas.find(v => v.id === id);
        if (visita) visita.estado = 'cancelada';
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES PARA CLIENTES ==========
    window.guardarCliente = async () => {
      const datos = {
        nombre: document.getElementById('cliente-nombre').value,
        telefono: document.getElementById('cliente-telefono').value,
        email: document.getElementById('cliente-email').value,
        tipoEvento: document.getElementById('cliente-tipoEvento').value,
        fechaEvento: document.getElementById('cliente-fechaEvento').value,
        personas: document.getElementById('cliente-personas').value,
        notas: document.getElementById('cliente-notas').value
      };
      
      if (!datos.nombre || !datos.telefono) {
        alert('Por favor completa nombre y telÃ©fono');
        return;
      }
      
      try {
        if (itemEditando) {
          await updateDoc(doc(db, 'clientesJardin', itemEditando.id), datos);
        } else {
          await addDoc(collection(db, 'clientesJardin'), { ...datos, fechaCreacion: serverTimestamp() });
        }
        await cargarDatos();
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.editarCliente = (id) => {
      itemEditando = clientesJardin.find(c => c.id === id);
      modalAbierto = 'cliente';
      render();
    };

    window.eliminarCliente = async (id) => {
      if (!confirm('Â¿Eliminar este cliente?')) return;
      try {
        await deleteDoc(doc(db, 'clientesJardin', id));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES PARA PROVEEDORES ==========
    window.guardarProveedor = async () => {
      const datos = {
        nombre: document.getElementById('proveedor-nombre').value,
        categoria: document.getElementById('proveedor-categoria').value,
        contacto: document.getElementById('proveedor-contacto').value,
        telefono: document.getElementById('proveedor-telefono').value,
        email: document.getElementById('proveedor-email').value,
        direccion: document.getElementById('proveedor-direccion').value,
        notas: document.getElementById('proveedor-notas').value
      };
      
      if (!datos.nombre || !datos.telefono) {
        alert('Por favor completa nombre y telÃ©fono');
        return;
      }
      
      try {
        if (itemEditando) {
          await updateDoc(doc(db, 'proveedores', itemEditando.id), datos);
        } else {
          await addDoc(collection(db, 'proveedores'), { ...datos, fechaCreacion: serverTimestamp() });
        }
        await cargarDatos();
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.editarProveedor = (id) => {
      itemEditando = proveedores.find(p => p.id === id);
      modalAbierto = 'proveedor';
      render();
    };

    window.eliminarProveedor = async (id) => {
      if (!confirm('Â¿Eliminar este proveedor?')) return;
      try {
        await deleteDoc(doc(db, 'proveedores', id));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES PARA INSUMOS ==========
    window.guardarInsumo = async () => {
      const datos = {
        nombre: document.getElementById('insumo-nombre').value,
        categoria: document.getElementById('insumo-categoria').value,
        unidad: document.getElementById('insumo-unidad').value,
        cantidad: parseFloat(document.getElementById('insumo-cantidad').value) || 0,
        minimo: parseFloat(document.getElementById('insumo-minimo').value) || 5,
        precioUnitario: parseFloat(document.getElementById('insumo-precio').value) || 0
      };
      
      if (!datos.nombre) {
        alert('Por favor ingresa el nombre del insumo');
        return;
      }
      
      try {
        if (itemEditando) {
          await updateDoc(doc(db, 'insumos', itemEditando.id), datos);
        } else {
          await addDoc(collection(db, 'insumos'), { ...datos, fechaCreacion: serverTimestamp() });
        }
        await cargarDatos();
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.editarInsumo = (id) => {
      itemEditando = insumos.find(i => i.id === id);
      modalAbierto = 'insumo';
      render();
    };

    window.eliminarInsumo = async (id) => {
      if (!confirm('Â¿Eliminar este insumo?')) return;
      try {
        await deleteDoc(doc(db, 'insumos', id));
        await cargarDatos();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES PARA COBRAR ==========
    window.calcularCambio = () => {
      if (!itemEditando) return;
      const recibido = parseFloat(document.getElementById('cobro-recibido').value) || 0;
      const cambio = recibido - (itemEditando.total || 0);
      const cambioEl = document.getElementById('cobro-cambio');
      if (cambioEl) cambioEl.textContent = fmt(Math.max(0, cambio));
    };

    window.procesarCobro = async (ordenId) => {
      const metodoPago = document.getElementById('cobro-metodo').value;
      
      try {
        await updateDoc(doc(db, 'ordenesRestaurante', ordenId), {
          estado: 'pagado',
          metodoPago: metodoPago,
          fechaPago: serverTimestamp()
        });
        const orden = ordenesRestaurante.find(o => o.id === ordenId);
        if (orden) {
          orden.estado = 'pagado';
          orden.metodoPago = metodoPago;
        }
        alert('âœ… Orden cobrada correctamente');
        cerrarModal();
        render();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== FUNCIONES DE CÃLCULO DE KPIs ==========
    function calcularKPIsRestaurante() {
      const ordenesFiltered = ordenesRestaurante.filter(o => {
        const fecha = o.fechaCreacion?.toDate?.() || (o.fecha ? new Date(o.fecha) : null);
        return fecha && fecha.toISOString().slice(0, 7) === filtroMes;
      });
      
      const ventasBrutas = ordenesFiltered.reduce((sum, o) => sum + (o.total || 0), 0);
      const totalOrdenes = ordenesFiltered.length;
      const ticketPromedio = totalOrdenes > 0 ? ventasBrutas / totalOrdenes : 0;
      
      let costoVentas = 0;
      ordenesFiltered.forEach(orden => {
        (orden.items || []).forEach(item => {
          const producto = productos.find(p => p.id === item.productoId || p.id === item.id);
          if (producto) {
            costoVentas += (producto.costo || producto.precio * 0.35) * (item.cantidad || 1);
          }
        });
      });

      const utilidadBruta = ventasBrutas - costoVentas;
      const margenBruto = ventasBrutas > 0 ? (utilidadBruta / ventasBrutas) * 100 : 0;
      
      const gastosRestDirectos = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'restaurante').reduce((sum, g) => sum + (g.monto || 0), 0);
      const gastosCompartidos = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'compartido').reduce((sum, g) => sum + (g.monto || 0), 0) * 0.5;
      
      const utilidadNeta = utilidadBruta - gastosRestDirectos - gastosCompartidos;
      const margenNeto = ventasBrutas > 0 ? (utilidadNeta / ventasBrutas) * 100 : 0;

      const productosVendidos = {};
      ordenesFiltered.forEach(orden => {
        (orden.items || []).forEach(item => {
          const prodId = item.productoId || item.id || item.nombre;
          if (!productosVendidos[prodId]) productosVendidos[prodId] = { cantidad: 0, nombre: item.nombre };
          productosVendidos[prodId].cantidad += item.cantidad || 1;
        });
      });
      
      const topProductos = Object.entries(productosVendidos)
        .map(([id, data]) => ({ 
          producto: productos.find(p => p.id === id) || { id, nombre: data.nombre, precio: 0 }, 
          cantidad: data.cantidad 
        }))
        .sort((a, b) => b.cantidad - a.cantidad)
        .slice(0, 5);

      return { ventasBrutas, totalOrdenes, ticketPromedio, costoVentas, utilidadBruta, margenBruto, gastosRestDirectos, gastosCompartidos, utilidadNeta, margenNeto, topProductos };
    }

    function calcularKPIsJardin() {
      const cotizacionesMes = cotizaciones.filter(c => c.cliente?.fechaEvento?.startsWith(filtroMes));
      const eventosRealizados = cotizacionesMes.filter(c => ['liquidado', 'realizado'].includes(c.estado));
      const eventosConfirmados = cotizacionesMes.filter(c => ['confirmado', 'anticipo', 'liquidado'].includes(c.estado));
      
      const ingresosBrutos = eventosRealizados.reduce((sum, c) => sum + (c.total || 0), 0);
      const anticiposRecibidos = cotizacionesMes.filter(c => c.estado === 'anticipo').reduce((sum, c) => sum + (c.anticipo || 0), 0);
      
      const gastosDirectos = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'jardin').reduce((sum, g) => sum + (g.monto || 0), 0);
      const gastosCompartidos = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'compartido').reduce((sum, g) => sum + (g.monto || 0), 0) * 0.5;
      
      const utilidadNeta = ingresosBrutos - gastosDirectos - gastosCompartidos;
      const margenNeto = ingresosBrutos > 0 ? (utilidadNeta / ingresosBrutos) * 100 : 0;
      
      const cotizacionesTotales = cotizacionesMes.length;
      const tasaConversion = cotizacionesTotales > 0 ? (eventosConfirmados.length / cotizacionesTotales) * 100 : 0;
      const ingresoPromedio = eventosRealizados.length > 0 ? ingresosBrutos / eventosRealizados.length : 0;
      
      const porPaquete = {};
      eventosRealizados.forEach(c => {
        const paq = c.paquete || 'otro';
        if (!porPaquete[paq]) porPaquete[paq] = { cantidad: 0, ingresos: 0 };
        porPaquete[paq].cantidad++;
        porPaquete[paq].ingresos += c.total || 0;
      });

      return { cotizacionesMes: cotizacionesMes.length, eventosRealizados: eventosRealizados.length, eventosConfirmados: eventosConfirmados.length, ingresosBrutos, anticiposRecibidos, gastosDirectos, gastosCompartidos, utilidadNeta, margenNeto, tasaConversion, ingresoPromedio, porPaquete };
    }

    function calcularKPIsConsolidado() {
      const kpisRest = calcularKPIsRestaurante();
      const kpisJardin = calcularKPIsJardin();
      
      const gastosCompartidosTotal = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'compartido').reduce((sum, g) => sum + (g.monto || 0), 0);
      const gastosTotales = gastos.filter(g => g.fecha?.startsWith(filtroMes)).reduce((sum, g) => sum + (g.monto || 0), 0);
      
      const ingresosTotales = kpisRest.ventasBrutas + kpisJardin.ingresosBrutos;
      const utilidadTotal = kpisRest.utilidadNeta + kpisJardin.utilidadNeta;
      const margenTotal = ingresosTotales > 0 ? (utilidadTotal / ingresosTotales) * 100 : 0;
      
      const pctRestaurante = ingresosTotales > 0 ? (kpisRest.ventasBrutas / ingresosTotales) * 100 : 0;
      const pctJardin = ingresosTotales > 0 ? (kpisJardin.ingresosBrutos / ingresosTotales) * 100 : 0;

      return { ingresosTotales, ingresosRestaurante: kpisRest.ventasBrutas, ingresosJardin: kpisJardin.ingresosBrutos, gastosTotales, gastosRestaurante: kpisRest.gastosRestDirectos, gastosJardin: kpisJardin.gastosDirectos, gastosCompartidos: gastosCompartidosTotal, utilidadTotal, margenTotal, pctRestaurante, pctJardin, kpisRest, kpisJardin };
    }

    // ========== CONTABILIDAD - CONSOLIDADO ==========
    function renderContabilidadConsolidado() {
      const kpis = calcularKPIsConsolidado();
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š Vista Consolidada</h2>
              <p class="text-gray-500">Resumen financiero general del negocio</p>
            </div>
            <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-3 border-2 rounded-xl focus:border-indigo-500 outline-none" />
          </div>

          <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-3xl p-8 text-white shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="text-center">
                <p class="text-indigo-200 text-sm font-medium">INGRESOS TOTALES</p>
                <p class="text-4xl font-bold mt-2">${fmt(kpis.ingresosTotales)}</p>
              </div>
              <div class="text-center border-x border-indigo-400/30">
                <p class="text-indigo-200 text-sm font-medium">GASTOS TOTALES</p>
                <p class="text-4xl font-bold mt-2">${fmt(kpis.gastosTotales)}</p>
              </div>
              <div class="text-center">
                <p class="text-indigo-200 text-sm font-medium">UTILIDAD TOTAL</p>
                <p class="text-4xl font-bold mt-2">${fmt(kpis.utilidadTotal)}</p>
                <p class="text-sm text-indigo-200 mt-1">Margen: ${kpis.margenTotal.toFixed(1)}%</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border overflow-hidden">
              <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-5 text-white">
                <h3 class="text-xl font-bold">ğŸ½ï¸ Restaurante</h3>
                <p class="text-amber-100 text-sm">${kpis.pctRestaurante.toFixed(1)}% de los ingresos</p>
              </div>
              <div class="p-5 space-y-3">
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Ventas</span><span class="font-bold">${fmt(kpis.ingresosRestaurante)}</span></div>
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Costo de Ventas</span><span class="font-bold text-red-600">-${fmt(kpis.kpisRest.costoVentas)}</span></div>
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Gastos Directos</span><span class="font-bold text-red-600">-${fmt(kpis.gastosRestaurante)}</span></div>
                <div class="flex justify-between py-2 bg-amber-50 -mx-5 px-5"><span class="font-semibold">Utilidad Neta</span><span class="font-bold text-xl ${kpis.kpisRest.utilidadNeta >= 0 ? 'text-green-600' : 'text-red-600'}">${fmt(kpis.kpisRest.utilidadNeta)}</span></div>
              </div>
            </div>

            <div class="bg-white rounded-2xl border overflow-hidden">
              <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-5 text-white">
                <h3 class="text-xl font-bold">ğŸŒ¿ JardÃ­n de Eventos</h3>
                <p class="text-emerald-100 text-sm">${kpis.pctJardin.toFixed(1)}% de los ingresos</p>
              </div>
              <div class="p-5 space-y-3">
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Ingresos Eventos</span><span class="font-bold">${fmt(kpis.ingresosJardin)}</span></div>
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Gastos Directos</span><span class="font-bold text-red-600">-${fmt(kpis.gastosJardin)}</span></div>
                <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Gastos Compartidos (50%)</span><span class="font-bold text-red-600">-${fmt(kpis.kpisJardin.gastosCompartidos)}</span></div>
                <div class="flex justify-between py-2 bg-emerald-50 -mx-5 px-5"><span class="font-semibold">Utilidad Neta</span><span class="font-bold text-xl ${kpis.kpisJardin.utilidadNeta >= 0 ? 'text-green-600' : 'text-red-600'}">${fmt(kpis.kpisJardin.utilidadNeta)}</span></div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl border p-6">
            <h3 class="font-semibold text-lg mb-4">ğŸ”— Gastos Compartidos (Ambas Ãreas)</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              ${CATEGORIAS_GASTOS.compartido.map(cat => {
                const total = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.categoria === cat.id).reduce((sum, g) => sum + (g.monto || 0), 0);
                return `<div class="p-4 bg-indigo-50 rounded-xl"><span class="text-2xl">${cat.icono}</span><p class="text-sm text-gray-600 mt-2">${cat.nombre}</p><p class="text-lg font-bold text-indigo-800">${fmt(total)}</p></div>`;
              }).join('')}
            </div>
            <p class="text-sm text-gray-500 mt-4 text-center">* Los gastos compartidos se dividen 50% para cada Ã¡rea</p>
          </div>
        </div>
      `;
    }

    // ========== CONTABILIDAD - RESTAURANTE ==========
    function renderContabilidadRestaurante() {
      const kpis = calcularKPIsRestaurante();
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ½ï¸ Contabilidad Restaurante</h2>
              <p class="text-gray-500">AnÃ¡lisis financiero del Ã¡rea de restaurante</p>
            </div>
            <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-3 border-2 rounded-xl focus:border-amber-500 outline-none" />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl p-5 border-l-4 border-amber-500 shadow-sm">
              <p class="text-sm text-gray-500">Ventas Brutas</p>
              <p class="text-2xl font-bold text-gray-800 mt-1">${fmt(kpis.ventasBrutas)}</p>
              <p class="text-xs text-gray-400 mt-2">${kpis.totalOrdenes} Ã³rdenes</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-green-500 shadow-sm">
              <p class="text-sm text-gray-500">Utilidad Bruta</p>
              <p class="text-2xl font-bold text-green-600 mt-1">${fmt(kpis.utilidadBruta)}</p>
              <p class="text-xs text-green-600 mt-2">Margen: ${kpis.margenBruto.toFixed(1)}%</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-red-500 shadow-sm">
              <p class="text-sm text-gray-500">Gastos Operativos</p>
              <p class="text-2xl font-bold text-red-600 mt-1">${fmt(kpis.gastosRestDirectos)}</p>
              <p class="text-xs text-gray-400 mt-2">Gastos directos</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-indigo-500 shadow-sm">
              <p class="text-sm text-gray-500">Utilidad Neta</p>
              <p class="text-2xl font-bold ${kpis.utilidadNeta >= 0 ? 'text-indigo-600' : 'text-red-600'} mt-1">${fmt(kpis.utilidadNeta)}</p>
              <p class="text-xs ${kpis.margenNeto >= 0 ? 'text-indigo-600' : 'text-red-600'} mt-2">Margen: ${kpis.margenNeto.toFixed(1)}%</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-amber-50 rounded-2xl p-5 border border-amber-100">
              <p class="text-sm text-amber-700">ğŸ« Ticket Promedio</p>
              <p class="text-3xl font-bold text-amber-800 mt-2">${fmt(kpis.ticketPromedio)}</p>
            </div>
            <div class="bg-blue-50 rounded-2xl p-5 border border-blue-100">
              <p class="text-sm text-blue-700">ğŸ“Š Costo de Ventas</p>
              <p class="text-3xl font-bold text-blue-800 mt-2">${fmt(kpis.costoVentas)}</p>
            </div>
            <div class="bg-purple-50 rounded-2xl p-5 border border-purple-100">
              <p class="text-sm text-purple-700">ğŸ“¦ Total Ã“rdenes</p>
              <p class="text-3xl font-bold text-purple-800 mt-2">${kpis.totalOrdenes}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ† Productos MÃ¡s Vendidos</h3>
              <div class="space-y-3">
                ${kpis.topProductos.length > 0 ? kpis.topProductos.map((p, i) => `
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div class="flex items-center gap-3">
                      <span class="w-8 h-8 flex items-center justify-center rounded-full ${i === 0 ? 'bg-amber-100 text-amber-700' : 'bg-gray-200 text-gray-700'} font-bold text-sm">${i + 1}</span>
                      <span class="font-medium">${p.producto?.nombre || 'Producto'}</span>
                    </div>
                    <p class="font-bold text-amber-700">${p.cantidad} vendidos</p>
                  </div>
                `).join('') : '<p class="text-gray-400 text-center py-4">Sin datos de ventas</p>'}
              </div>
            </div>

            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ§¾ Gastos por CategorÃ­a</h3>
              <div class="space-y-3">
                ${CATEGORIAS_GASTOS.restaurante.map(cat => {
                  const total = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.categoria === cat.id).reduce((sum, g) => sum + (g.monto || 0), 0);
                  return `<div class="flex items-center justify-between p-3 bg-amber-50 rounded-xl"><div class="flex items-center gap-2"><span>${cat.icono}</span><span>${cat.nombre}</span></div><span class="font-bold text-amber-800">${fmt(total)}</span></div>`;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== CONTABILIDAD - JARDÃN ==========
    function renderContabilidadJardin() {
      const kpis = calcularKPIsJardin();
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸŒ¿ Contabilidad JardÃ­n</h2>
              <p class="text-gray-500">AnÃ¡lisis financiero del Ã¡rea de eventos</p>
            </div>
            <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-3 border-2 rounded-xl focus:border-emerald-500 outline-none" />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl p-5 border-l-4 border-emerald-500 shadow-sm">
              <p class="text-sm text-gray-500">Ingresos Brutos</p>
              <p class="text-2xl font-bold text-gray-800 mt-1">${fmt(kpis.ingresosBrutos)}</p>
              <p class="text-xs text-gray-400 mt-2">${kpis.eventosRealizados} eventos</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-purple-500 shadow-sm">
              <p class="text-sm text-gray-500">Anticipos Recibidos</p>
              <p class="text-2xl font-bold text-purple-600 mt-1">${fmt(kpis.anticiposRecibidos)}</p>
              <p class="text-xs text-gray-400 mt-2">Por realizar</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-red-500 shadow-sm">
              <p class="text-sm text-gray-500">Gastos Directos</p>
              <p class="text-2xl font-bold text-red-600 mt-1">${fmt(kpis.gastosDirectos)}</p>
              <p class="text-xs text-gray-400 mt-2">Del Ã¡rea</p>
            </div>
            <div class="bg-white rounded-2xl p-5 border-l-4 border-teal-500 shadow-sm">
              <p class="text-sm text-gray-500">Utilidad Neta</p>
              <p class="text-2xl font-bold ${kpis.utilidadNeta >= 0 ? 'text-teal-600' : 'text-red-600'} mt-1">${fmt(kpis.utilidadNeta)}</p>
              <p class="text-xs ${kpis.margenNeto >= 0 ? 'text-teal-600' : 'text-red-600'} mt-2">Margen: ${kpis.margenNeto.toFixed(1)}%</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-emerald-50 rounded-2xl p-5 border border-emerald-100">
              <p class="text-sm text-emerald-700">ğŸ“ Cotizaciones</p>
              <p class="text-3xl font-bold text-emerald-800 mt-2">${kpis.cotizacionesMes}</p>
            </div>
            <div class="bg-blue-50 rounded-2xl p-5 border border-blue-100">
              <p class="text-sm text-blue-700">âœ… Confirmados</p>
              <p class="text-3xl font-bold text-blue-800 mt-2">${kpis.eventosConfirmados}</p>
            </div>
            <div class="bg-green-50 rounded-2xl p-5 border border-green-100">
              <p class="text-sm text-green-700">ğŸ¯ Tasa ConversiÃ³n</p>
              <p class="text-3xl font-bold text-green-800 mt-2">${kpis.tasaConversion.toFixed(1)}%</p>
            </div>
            <div class="bg-amber-50 rounded-2xl p-5 border border-amber-100">
              <p class="text-sm text-amber-700">ğŸ’µ Ingreso Promedio</p>
              <p class="text-3xl font-bold text-amber-800 mt-2">${fmt(kpis.ingresoPromedio)}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ“¦ Ingresos por Paquete</h3>
              <div class="space-y-3">
                ${Object.entries(kpis.porPaquete).length > 0 ? Object.entries(kpis.porPaquete).map(([id, data]) => {
                  const paquete = PAQUETES.find(p => p.id === id);
                  return `<div class="flex items-center justify-between p-4 bg-emerald-50 rounded-xl"><div><p class="font-medium">${paquete?.nombre || id}</p><p class="text-sm text-gray-500">${data.cantidad} evento${data.cantidad > 1 ? 's' : ''}</p></div><p class="text-xl font-bold text-emerald-700">${fmt(data.ingresos)}</p></div>`;
                }).join('') : '<p class="text-gray-400 text-center py-4">Sin eventos este mes</p>'}
              </div>
            </div>

            <div class="bg-white rounded-2xl border p-6">
              <h3 class="font-semibold text-lg mb-4">ğŸ§¾ Gastos por CategorÃ­a</h3>
              <div class="space-y-3">
                ${CATEGORIAS_GASTOS.jardin.map(cat => {
                  const total = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.categoria === cat.id).reduce((sum, g) => sum + (g.monto || 0), 0);
                  return `<div class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl"><div class="flex items-center gap-2"><span>${cat.icono}</span><span>${cat.nombre}</span></div><span class="font-bold text-emerald-800">${fmt(total)}</span></div>`;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== CONTABILIDAD - REGISTRO DE GASTOS ==========
    function renderContabilidadGastos() {
      const gastosDelMes = gastos.filter(g => g.fecha?.startsWith(filtroMes)).sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));
      const totalRest = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'restaurante').reduce((sum, g) => sum + (g.monto || 0), 0);
      const totalJardin = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'jardin').reduce((sum, g) => sum + (g.monto || 0), 0);
      const totalCompartido = gastos.filter(g => g.fecha?.startsWith(filtroMes) && g.area === 'compartido').reduce((sum, g) => sum + (g.monto || 0), 0);
      
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ğŸ§¾ Registrar Gastos</h2>
              <p class="text-gray-500">GestiÃ³n de gastos por Ã¡rea</p>
            </div>
            <div class="flex items-center gap-3">
              <input type="month" value="${filtroMes}" onchange="setFiltroMes(this.value)" class="p-3 border-2 rounded-xl outline-none" />
              <button onclick="abrirModal('gastoContabilidad')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl font-medium">â• Nuevo Gasto</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-5 text-white">
              <p class="text-amber-100 text-sm">ğŸ½ï¸ Gastos Restaurante</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalRest)}</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl p-5 text-white">
              <p class="text-emerald-100 text-sm">ğŸŒ¿ Gastos JardÃ­n</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalJardin)}</p>
            </div>
            <div class="bg-gradient-to-br from-indigo-500 to-purple-500 rounded-2xl p-5 text-white">
              <p class="text-indigo-100 text-sm">ğŸ”— Gastos Compartidos</p>
              <p class="text-3xl font-bold mt-2">${fmt(totalCompartido)}</p>
            </div>
          </div>

          <div class="bg-white rounded-2xl border overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Fecha</th>
                  <th class="px-4 py-3 text-left font-semibold">Ãrea</th>
                  <th class="px-4 py-3 text-left font-semibold">CategorÃ­a</th>
                  <th class="px-4 py-3 text-left font-semibold">DescripciÃ³n</th>
                  <th class="px-4 py-3 text-right font-semibold">Monto</th>
                  <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${gastosDelMes.length > 0 ? gastosDelMes.map(g => {
                  const areaColors = { restaurante: 'bg-amber-100 text-amber-800', jardin: 'bg-emerald-100 text-emerald-800', compartido: 'bg-indigo-100 text-indigo-800' };
                  const areaNames = { restaurante: 'ğŸ½ï¸ Restaurante', jardin: 'ğŸŒ¿ JardÃ­n', compartido: 'ğŸ”— Compartido' };
                  return `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3">${fmtFecha(g.fecha)}</td>
                      <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${areaColors[g.area] || 'bg-gray-100'}">${areaNames[g.area] || g.area}</span></td>
                      <td class="px-4 py-3">${g.categoria || '-'}</td>
                      <td class="px-4 py-3">${g.descripcion || '-'}</td>
                      <td class="px-4 py-3 text-right font-bold">${fmt(g.monto)}</td>
                      <td class="px-4 py-3 text-right">
                        <button onclick="eliminarGasto('${g.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                      </td>
                    </tr>
                  `;
                }).join('') : '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-400">No hay gastos registrados este mes</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== MODAL ==========
    function renderModal() {
      if (modalAbierto === 'producto') {
        return renderModalProducto();
      }
      if (modalAbierto === 'verCotizacion') {
        return renderModalVerCotizacion();
      }
      if (modalAbierto === 'insumo') {
        return renderModalInsumo();
      }
      if (modalAbierto === 'receta') {
        return renderModalReceta();
      }
      if (modalAbierto === 'gastoContabilidad') {
        return renderModalGastoContabilidad();
      }
      if (modalAbierto === 'visita') {
        return renderModalVisita();
      }
      if (modalAbierto === 'cliente') {
        return renderModalCliente();
      }
      if (modalAbierto === 'proveedor') {
        return renderModalProveedor();
      }
      if (modalAbierto === 'cobrarOrden') {
        return renderModalCobrarOrden();
      }
      if (modalAbierto === 'nuevaCotizacionCatering') {
        return renderModalNuevaCotizacionCatering();
      }
      if (modalAbierto === 'verCotizacionCatering') {
        return renderModalVerCotizacionCatering();
      }
      if (modalAbierto === 'configCatering') {
        return renderModalConfigCatering();
      }
      if (modalAbierto === 'editarPaqueteCatering') {
        return renderModalEditarPaqueteCatering();
      }
      if (modalAbierto === 'editarExtraCatering') {
        return renderModalEditarExtraCatering();
      }
      if (modalAbierto === 'nuevoEmpleado') {
        return renderModalNuevoEmpleado();
      }
      if (modalAbierto === 'verEmpleado') {
        return renderModalVerEmpleado();
      }
      if (modalAbierto === 'editarNomina') {
        return renderModalEditarNomina();
      }
      if (modalAbierto === 'generarRecibo') {
        return renderModalGenerarRecibo();
      }
      if (modalAbierto === 'generarContrato') {
        return renderModalGenerarContrato();
      }
      if (modalAbierto === 'nuevoUsuario') {
        return renderModalNuevoUsuario();
      }
      if (modalAbierto === 'editarUsuarioSistema') {
        return renderModalEditarUsuario();
      }
      return '';
    }

    // ========== MODALES DE PERSONAL ==========
    function renderModalNuevoEmpleado() {
      const emp = itemEditando || {
        nombre: '', telefono: '', email: '', direccion: '',
        curp: '', rfc: '', nss: '',
        puesto: 'mesero', tipoContrato: 'tiempo-completo',
        salario: 0, periodoSalario: 'quincena',
        fechaIngreso: new Date().toISOString().slice(0, 10),
        fechaNacimiento: '', contactoEmergencia: '', telEmergencia: '',
        cuentaBanco: '', banco: '', horarios: {}
      };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[95vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-2xl sticky top-0 z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'âœï¸ Editar' : 'â• Nuevo'} Empleado</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-5 space-y-6">
              <!-- Datos Personales -->
              <div class="bg-gray-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ‘¤ Datos Personales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-700">Nombre Completo *</label>
                    <input type="text" id="emp-nombre" value="${emp.nombre || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">TelÃ©fono *</label>
                    <input type="tel" id="emp-telefono" value="${emp.telefono || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="emp-email" value="${emp.email || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                    <input type="date" id="emp-fechaNacimiento" value="${emp.fechaNacimiento || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">DirecciÃ³n</label>
                    <input type="text" id="emp-direccion" value="${emp.direccion || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>

              <!-- Documentos -->
              <div class="bg-blue-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ“„ Documentos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">CURP</label>
                    <input type="text" id="emp-curp" value="${emp.curp || ''}" maxlength="18" class="w-full mt-1 p-3 border rounded-xl uppercase" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">RFC</label>
                    <input type="text" id="emp-rfc" value="${emp.rfc || ''}" maxlength="13" class="w-full mt-1 p-3 border rounded-xl uppercase" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">NSS (IMSS)</label>
                    <input type="text" id="emp-nss" value="${emp.nss || ''}" maxlength="11" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>

              <!-- Datos Laborales -->
              <div class="bg-green-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ’¼ Datos Laborales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Puesto *</label>
                    <select id="emp-puesto" class="w-full mt-1 p-3 border rounded-xl">
                      ${PUESTOS_DISPONIBLES.map(p => `
                        <option value="${p.id}" ${emp.puesto === p.id ? 'selected' : ''}>${p.nombre}</option>
                      `).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Tipo de Contrato *</label>
                    <select id="emp-tipoContrato" class="w-full mt-1 p-3 border rounded-xl">
                      ${TIPOS_CONTRATO.map(c => `
                        <option value="${c.id}" ${emp.tipoContrato === c.id ? 'selected' : ''}>${c.nombre}</option>
                      `).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="emp-fechaIngreso" value="${emp.fechaIngreso || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <label class="text-sm font-medium text-gray-700">Salario *</label>
                      <input type="number" id="emp-salario" value="${emp.salario || 0}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" />
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700">Periodo</label>
                      <select id="emp-periodoSalario" class="w-full mt-1 p-3 border rounded-xl">
                        <option value="dia" ${emp.periodoSalario === 'dia' ? 'selected' : ''}>Diario</option>
                        <option value="semana" ${emp.periodoSalario === 'semana' ? 'selected' : ''}>Semanal</option>
                        <option value="quincena" ${emp.periodoSalario === 'quincena' ? 'selected' : ''}>Quincenal</option>
                        <option value="mes" ${emp.periodoSalario === 'mes' ? 'selected' : ''}>Mensual</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Datos Bancarios -->
              <div class="bg-amber-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ¦ Datos Bancarios</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Banco</label>
                    <input type="text" id="emp-banco" value="${emp.banco || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">NÃºmero de Cuenta / CLABE</label>
                    <input type="text" id="emp-cuentaBanco" value="${emp.cuentaBanco || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>

              <!-- Contacto de Emergencia -->
              <div class="bg-red-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ†˜ Contacto de Emergencia</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="emp-contactoEmergencia" value="${emp.contactoEmergencia || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">TelÃ©fono</label>
                    <input type="tel" id="emp-telEmergencia" value="${emp.telEmergencia || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>

              <!-- Botones -->
              <div class="flex gap-3">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-4 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarEmpleado()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-medium">ğŸ’¾ Guardar Empleado</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalVerEmpleado() {
      const emp = itemEditando;
      if (!emp) return '';
      
      const puesto = PUESTOS_DISPONIBLES.find(p => p.id === emp.puesto);
      const contrato = TIPOS_CONTRATO.find(c => c.id === emp.tipoContrato);
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-2xl">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                  <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center text-3xl">
                    ${emp.nombre?.charAt(0)?.toUpperCase() || 'ğŸ‘¤'}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold">${emp.nombre}</h2>
                    <p class="text-blue-200">${puesto?.nombre || emp.puesto}</p>
                  </div>
                </div>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-5 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500">Tipo de Contrato</p>
                  <p class="font-semibold">${contrato?.nombre || '-'}</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500">Salario</p>
                  <p class="font-semibold">${fmt(emp.salario || 0)} / ${emp.periodoSalario || 'mes'}</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500">Fecha de Ingreso</p>
                  <p class="font-semibold">${emp.fechaIngreso ? fmtFecha(emp.fechaIngreso) : '-'}</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500">TelÃ©fono</p>
                  <p class="font-semibold">${emp.telefono || '-'}</p>
                </div>
              </div>

              ${emp.email ? `<p class="text-sm"><span class="text-gray-500">Email:</span> ${emp.email}</p>` : ''}
              ${emp.direccion ? `<p class="text-sm"><span class="text-gray-500">DirecciÃ³n:</span> ${emp.direccion}</p>` : ''}
              ${emp.curp ? `<p class="text-sm"><span class="text-gray-500">CURP:</span> ${emp.curp}</p>` : ''}
              ${emp.rfc ? `<p class="text-sm"><span class="text-gray-500">RFC:</span> ${emp.rfc}</p>` : ''}
              ${emp.nss ? `<p class="text-sm"><span class="text-gray-500">NSS:</span> ${emp.nss}</p>` : ''}
              
              ${emp.banco ? `
                <div class="bg-amber-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500">Datos Bancarios</p>
                  <p class="font-semibold">${emp.banco} - ${emp.cuentaBanco}</p>
                </div>
              ` : ''}

              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium">Cerrar</button>
                <button onclick="editarEmpleado('${emp.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium">âœï¸ Editar</button>
                <button onclick="generarContrato('${emp.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium">ğŸ“„ Contrato</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalEditarNomina() {
      const emp = itemEditando;
      if (!emp) return '';
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">âœï¸ Ajustar NÃ³mina - ${emp.nombre}</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-sm text-gray-600">Salario Base Quincenal</p>
                <p class="text-2xl font-bold">${fmt(emp.salario / (emp.periodoSalario === 'mes' ? 2 : 1))}</p>
              </div>
              
              <div>
                <label class="text-sm font-medium text-gray-700">Horas Extra (esta quincena)</label>
                <input type="number" id="nomina-horasExtra" value="${emp.horasExtraQuincena || 0}" min="0" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              
              <div>
                <label class="text-sm font-medium text-gray-700">Bono (esta quincena)</label>
                <input type="number" id="nomina-bono" value="${emp.bonoQuincena || 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              
              <div>
                <label class="text-sm font-medium text-gray-700">Otras Deducciones</label>
                <input type="number" id="nomina-deducciones" value="${emp.otrasDeduciones || 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarAjusteNomina('${emp.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium">ğŸ’¾ Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalGenerarRecibo() {
      const emp = itemEditando;
      if (!emp) return '';
      
      const periodoActual = window.periodoNomina || new Date().toISOString().slice(0, 7);
      const salarioBase = emp.salario || 0;
      const periodo = emp.periodoSalario || 'mes';
      let salarioQuincenal = salarioBase;
      if (periodo === 'mes') salarioQuincenal = salarioBase / 2;
      
      const imss = emp.tipoContrato === 'tiempo-completo' ? salarioQuincenal * 0.025 : 0;
      const isr = salarioQuincenal > 7000 ? (salarioQuincenal - 7000) * 0.09 : 0;
      const horasExtra = (emp.horasExtraQuincena || 0) * (salarioBase / 240) * 2;
      const bonos = emp.bonoQuincena || 0;
      const totalPercepciones = salarioQuincenal + horasExtra + bonos;
      const totalDeducciones = imss + isr + (emp.otrasDeduciones || 0);
      const netoAPagar = totalPercepciones - totalDeducciones;
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-green-600 to-green-700 text-white rounded-t-2xl">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ“„ Recibo de NÃ³mina</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-6" id="recibo-contenido">
              <!-- Header del recibo -->
              <div class="text-center border-b pb-4 mb-4">
                <h1 class="text-2xl font-bold">ğŸŒ¿ JardÃ­n Escondido</h1>
                <p class="text-gray-600">Recibo de NÃ³mina</p>
                <p class="text-sm text-gray-500">Periodo: ${periodoActual}</p>
              </div>
              
              <!-- Datos del empleado -->
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <p class="text-sm text-gray-500">Empleado</p>
                  <p class="font-bold">${emp.nombre}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Puesto</p>
                  <p class="font-semibold">${PUESTOS_DISPONIBLES.find(p => p.id === emp.puesto)?.nombre || emp.puesto}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">RFC</p>
                  <p class="font-mono">${emp.rfc || 'N/A'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Fecha de Pago</p>
                  <p class="font-semibold">${fmtFecha(new Date())}</p>
                </div>
              </div>
              
              <!-- Percepciones -->
              <div class="bg-green-50 rounded-xl p-4 mb-4">
                <h3 class="font-semibold text-green-800 mb-3">PERCEPCIONES</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>Salario Base Quincenal</span>
                    <span class="font-semibold">${fmt(salarioQuincenal)}</span>
                  </div>
                  ${horasExtra > 0 ? `
                    <div class="flex justify-between">
                      <span>Horas Extra (${emp.horasExtraQuincena || 0} hrs)</span>
                      <span class="font-semibold">${fmt(horasExtra)}</span>
                    </div>
                  ` : ''}
                  ${bonos > 0 ? `
                    <div class="flex justify-between">
                      <span>Bonos</span>
                      <span class="font-semibold">${fmt(bonos)}</span>
                    </div>
                  ` : ''}
                  <div class="flex justify-between border-t pt-2 font-bold">
                    <span>Total Percepciones</span>
                    <span class="text-green-700">${fmt(totalPercepciones)}</span>
                  </div>
                </div>
              </div>
              
              <!-- Deducciones -->
              <div class="bg-red-50 rounded-xl p-4 mb-4">
                <h3 class="font-semibold text-red-800 mb-3">DEDUCCIONES</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>IMSS (2.5%)</span>
                    <span class="font-semibold">${fmt(imss)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>ISR</span>
                    <span class="font-semibold">${fmt(isr)}</span>
                  </div>
                  ${(emp.otrasDeduciones || 0) > 0 ? `
                    <div class="flex justify-between">
                      <span>Otras Deducciones</span>
                      <span class="font-semibold">${fmt(emp.otrasDeduciones)}</span>
                    </div>
                  ` : ''}
                  <div class="flex justify-between border-t pt-2 font-bold">
                    <span>Total Deducciones</span>
                    <span class="text-red-700">-${fmt(totalDeducciones)}</span>
                  </div>
                </div>
              </div>
              
              <!-- Neto a Pagar -->
              <div class="bg-blue-100 rounded-xl p-4">
                <div class="flex justify-between items-center">
                  <span class="text-xl font-bold">NETO A PAGAR</span>
                  <span class="text-3xl font-bold text-blue-700">${fmt(netoAPagar)}</span>
                </div>
              </div>
              
              <!-- Firmas -->
              <div class="mt-8 pt-8 border-t grid grid-cols-2 gap-8">
                <div class="text-center">
                  <div class="border-b border-gray-400 mb-2 h-12"></div>
                  <p class="text-sm text-gray-600">Firma del Empleado</p>
                </div>
                <div class="text-center">
                  <div class="border-b border-gray-400 mb-2 h-12"></div>
                  <p class="text-sm text-gray-600">Firma del PatrÃ³n</p>
                </div>
              </div>
            </div>
            
            <div class="p-4 border-t flex gap-3">
              <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium">Cerrar</button>
              <button onclick="imprimirRecibo()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium">ğŸ–¨ï¸ Imprimir</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalGenerarContrato() {
      const emp = itemEditando;
      if (!emp) return '';
      
      const contrato = TIPOS_CONTRATO.find(c => c.id === emp.tipoContrato);
      const puesto = PUESTOS_DISPONIBLES.find(p => p.id === emp.puesto);
      const hoy = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[95vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-t-2xl sticky top-0 z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ“„ Contrato Individual de Trabajo</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-8 text-sm leading-relaxed" id="contrato-contenido">
              <div class="text-center mb-8">
                <h1 class="text-xl font-bold mb-2">CONTRATO INDIVIDUAL DE TRABAJO</h1>
                <p class="text-gray-600">Por ${contrato?.nombre || 'Tiempo Indeterminado'}</p>
              </div>
              
              <p class="mb-4">
                En la Ciudad de MÃ©xico, a ${hoy}, celebran el presente contrato individual de trabajo por una parte 
                <strong>"JARDÃN ESCONDIDO"</strong>, representada por su propietario/administrador, a quien en lo sucesivo 
                se le denominarÃ¡ <strong>"EL PATRÃ“N"</strong>, y por la otra parte <strong>${emp.nombre?.toUpperCase()}</strong>, 
                a quien en lo sucesivo se le denominarÃ¡ <strong>"EL TRABAJADOR"</strong>, al tenor de las siguientes:
              </p>
              
              <h2 class="font-bold mt-6 mb-2">D E C L A R A C I O N E S</h2>
              
              <p class="mb-2"><strong>I.</strong> Declara EL PATRÃ“N ser una empresa dedicada al servicio de restaurante y eventos.</p>
              
              <p class="mb-2"><strong>II.</strong> Declara EL TRABAJADOR:</p>
              <ul class="list-disc ml-8 mb-4">
                <li>Llamarse ${emp.nombre || '_______________'}</li>
                <li>Tener ${emp.fechaNacimiento ? calcularEdad(emp.fechaNacimiento) : '___'} aÃ±os de edad</li>
                <li>CURP: ${emp.curp || '_______________'}</li>
                <li>RFC: ${emp.rfc || '_______________'}</li>
                <li>NSS: ${emp.nss || '_______________'}</li>
                <li>Domicilio: ${emp.direccion || '_______________'}</li>
              </ul>
              
              <h2 class="font-bold mt-6 mb-2">C L Ã U S U L A S</h2>
              
              <p class="mb-2"><strong>PRIMERA.- </strong>EL TRABAJADOR se obliga a prestar sus servicios personales subordinados a EL PATRÃ“N, 
              desempeÃ±ando el puesto de <strong>${puesto?.nombre || emp.puesto || '_______________'}</strong>.</p>
              
              <p class="mb-2"><strong>SEGUNDA.- </strong>La duraciÃ³n del presente contrato serÃ¡ por <strong>${contrato?.nombre || 'tiempo indeterminado'}</strong>.</p>
              
              <p class="mb-2"><strong>TERCERA.- </strong>EL TRABAJADOR percibirÃ¡ un salario de <strong>${fmt(emp.salario || 0)} ${emp.periodoSalario === 'mes' ? 'mensuales' : emp.periodoSalario === 'quincena' ? 'quincenales' : emp.periodoSalario === 'semana' ? 'semanales' : 'diarios'}</strong>, 
              que le serÃ¡ cubierto en el domicilio de trabajo.</p>
              
              <p class="mb-2"><strong>CUARTA.- </strong>La jornada de trabajo serÃ¡ conforme al horario establecido por EL PATRÃ“N, 
              respetando los mÃ¡ximos legales de 8 horas diarias y 48 horas semanales.</p>
              
              <p class="mb-2"><strong>QUINTA.- </strong>EL TRABAJADOR disfrutarÃ¡ de un dÃ­a de descanso por cada seis dÃ­as de trabajo, 
              asÃ­ como de los dÃ­as de descanso obligatorio establecidos en la Ley Federal del Trabajo.</p>
              
              <p class="mb-2"><strong>SEXTA.- </strong>EL TRABAJADOR tendrÃ¡ derecho a un perÃ­odo anual de vacaciones y al pago 
              de prima vacacional conforme a la Ley Federal del Trabajo.</p>
              
              <p class="mb-2"><strong>SÃ‰PTIMA.- </strong>EL TRABAJADOR se obliga a guardar absoluta discreciÃ³n y reserva de 
              toda la informaciÃ³n de la empresa a la que tenga acceso.</p>
              
              <p class="mb-4"><strong>OCTAVA.- </strong>Ambas partes reconocen que para todo lo no previsto en este contrato, 
              se aplicarÃ¡n las disposiciones de la Ley Federal del Trabajo.</p>
              
              <p class="mb-8">LeÃ­do el presente contrato, y enteradas las partes de su contenido y alcance legal, 
              lo firman por duplicado en la Ciudad de MÃ©xico, a ${hoy}.</p>
              
              <div class="grid grid-cols-2 gap-12 mt-12">
                <div class="text-center">
                  <div class="border-b border-gray-400 mb-2 h-16"></div>
                  <p class="font-bold">EL PATRÃ“N</p>
                  <p class="text-gray-600">JardÃ­n Escondido</p>
                </div>
                <div class="text-center">
                  <div class="border-b border-gray-400 mb-2 h-16"></div>
                  <p class="font-bold">EL TRABAJADOR</p>
                  <p class="text-gray-600">${emp.nombre || '_______________'}</p>
                </div>
              </div>
            </div>
            
            <div class="p-4 border-t flex gap-3 sticky bottom-0 bg-white">
              <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium">Cerrar</button>
              <button onclick="imprimirContrato()" class="flex-1 bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-xl font-medium">ğŸ–¨ï¸ Imprimir</button>
            </div>
          </div>
        </div>
      `;
    }

    function calcularEdad(fechaNacimiento) {
      const hoy = new Date();
      const nacimiento = new Date(fechaNacimiento);
      let edad = hoy.getFullYear() - nacimiento.getFullYear();
      const m = hoy.getMonth() - nacimiento.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
      return edad;
    }

    window.guardarEmpleado = async () => {
      const datos = {
        nombre: document.getElementById('emp-nombre').value.trim(),
        telefono: document.getElementById('emp-telefono').value.trim(),
        email: document.getElementById('emp-email').value.trim(),
        direccion: document.getElementById('emp-direccion').value.trim(),
        curp: document.getElementById('emp-curp').value.trim().toUpperCase(),
        rfc: document.getElementById('emp-rfc').value.trim().toUpperCase(),
        nss: document.getElementById('emp-nss').value.trim(),
        puesto: document.getElementById('emp-puesto').value,
        tipoContrato: document.getElementById('emp-tipoContrato').value,
        salario: parseFloat(document.getElementById('emp-salario').value) || 0,
        periodoSalario: document.getElementById('emp-periodoSalario').value,
        fechaIngreso: document.getElementById('emp-fechaIngreso').value,
        fechaNacimiento: document.getElementById('emp-fechaNacimiento').value,
        banco: document.getElementById('emp-banco').value.trim(),
        cuentaBanco: document.getElementById('emp-cuentaBanco').value.trim(),
        contactoEmergencia: document.getElementById('emp-contactoEmergencia').value.trim(),
        telEmergencia: document.getElementById('emp-telEmergencia').value.trim(),
        activo: true
      };
      
      if (!datos.nombre || !datos.telefono) {
        alert('El nombre y telÃ©fono son obligatorios');
        return;
      }
      
      try {
        if (itemEditando?.id) {
          await updateDoc(doc(db, 'empleados', itemEditando.id), datos);
          const idx = empleados.findIndex(e => e.id === itemEditando.id);
          if (idx >= 0) empleados[idx] = { ...empleados[idx], ...datos };
        } else {
          datos.fechaCreacion = serverTimestamp();
          const docRef = await addDoc(collection(db, 'empleados'), datos);
          empleados.push({ id: docRef.id, ...datos });
        }
        cerrarModal();
        render();
        alert('âœ… Empleado guardado correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.guardarAjusteNomina = async (empleadoId) => {
      const horasExtra = parseFloat(document.getElementById('nomina-horasExtra').value) || 0;
      const bono = parseFloat(document.getElementById('nomina-bono').value) || 0;
      const deducciones = parseFloat(document.getElementById('nomina-deducciones').value) || 0;
      
      try {
        await updateDoc(doc(db, 'empleados', empleadoId), {
          horasExtraQuincena: horasExtra,
          bonoQuincena: bono,
          otrasDeduciones: deducciones
        });
        
        const emp = empleados.find(e => e.id === empleadoId);
        if (emp) {
          emp.horasExtraQuincena = horasExtra;
          emp.bonoQuincena = bono;
          emp.otrasDeduciones = deducciones;
        }
        
        cerrarModal();
        render();
        alert('âœ… Ajustes de nÃ³mina guardados');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.imprimirRecibo = () => {
      const contenido = document.getElementById('recibo-contenido').innerHTML;
      const ventana = window.open('', '', 'width=800,height=600');
      ventana.document.write(`
        <html>
          <head>
            <title>Recibo de NÃ³mina</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .bg-green-50 { background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 10px 0; }
              .bg-red-50 { background: #fef2f2; padding: 15px; border-radius: 8px; margin: 10px 0; }
              .bg-blue-100 { background: #dbeafe; padding: 15px; border-radius: 8px; margin: 10px 0; }
            </style>
          </head>
          <body>${contenido}</body>
        </html>
      `);
      ventana.document.close();
      ventana.print();
    };

    window.imprimirContrato = () => {
      const contenido = document.getElementById('contrato-contenido').innerHTML;
      const ventana = window.open('', '', 'width=800,height=600');
      ventana.document.write(`
        <html>
          <head>
            <title>Contrato de Trabajo</title>
            <style>
              body { font-family: 'Times New Roman', serif; padding: 40px; line-height: 1.8; }
              h1 { text-align: center; }
              h2 { margin-top: 20px; }
              ul { margin-left: 30px; }
            </style>
          </head>
          <body>${contenido}</body>
        </html>
      `);
      ventana.document.close();
      ventana.print();
    };

    function renderModalNuevoUsuario() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">â• Nuevo Usuario</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre completo</label>
                <input id="nuevo-nombre" type="text" placeholder="Ej: Juan PÃ©rez" 
                  class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Correo electrÃ³nico</label>
                <input id="nuevo-email" type="email" placeholder="correo@ejemplo.com" 
                  class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">ContraseÃ±a</label>
                <input id="nuevo-password" type="password" placeholder="MÃ­nimo 6 caracteres" 
                  class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Rol</label>
                <select id="nuevo-rol" class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                  ${ROLES_SISTEMA.map(r => `<option value="${r.id}">${r.icono} ${r.nombre} - ${r.descripcion}</option>`).join('')}
                </select>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarNuevoUsuarioSistema()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-medium">Crear Usuario</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalEditarUsuario() {
      if (!itemEditando) return '';
      const u = itemEditando;
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">âœï¸ Editar Usuario</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre completo</label>
                <input id="editar-nombre" type="text" value="${u.nombre || ''}" 
                  class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Correo</label>
                <input type="email" value="${u.email}" disabled
                  class="w-full mt-1 p-3 border rounded-xl bg-gray-100 text-gray-500" />
                <p class="text-xs text-gray-400 mt-1">El correo no se puede cambiar</p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Rol</label>
                <select id="editar-rol" class="w-full mt-1 p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                  ${ROLES_SISTEMA.map(r => `<option value="${r.id}" ${u.rol === r.id ? 'selected' : ''}>${r.icono} ${r.nombre}</option>`).join('')}
                </select>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarEditarUsuarioSistema()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-medium">Guardar Cambios</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODAL VISITA ==========
    function renderModalVisita() {
      const visita = itemEditando || { fecha: new Date().toISOString().slice(0, 10), hora: '10:00', cliente: '', telefono: '', email: '', tipoEvento: '', personas: '', notas: '', estado: 'programada' };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'âœï¸ Editar' : 'â• Nueva'} Visita</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Fecha</label>
                  <input type="date" id="visita-fecha" value="${visita.fecha}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Hora</label>
                  <input type="time" id="visita-hora" value="${visita.hora}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre del Cliente</label>
                <input type="text" id="visita-cliente" value="${visita.cliente || ''}" placeholder="Nombre completo" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">TelÃ©fono</label>
                  <input type="tel" id="visita-telefono" value="${visita.telefono || ''}" placeholder="55 1234 5678" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Email (opcional)</label>
                  <input type="email" id="visita-email" value="${visita.email || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Tipo de Evento</label>
                  <select id="visita-tipoEvento" class="w-full mt-1 p-3 border rounded-xl">
                    <option value="">Seleccionar...</option>
                    ${['Boda', 'XV AÃ±os', 'Bautizo', 'Primera ComuniÃ³n', 'CumpleaÃ±os', 'GraduaciÃ³n', 'Baby Shower', 'Corporativo', 'Otro'].map(t => `<option value="${t}" ${visita.tipoEvento === t ? 'selected' : ''}>${t}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Personas (aprox)</label>
                  <input type="number" id="visita-personas" value="${visita.personas || ''}" placeholder="70" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Notas</label>
                <textarea id="visita-notas" rows="2" class="w-full mt-1 p-3 border rounded-xl" placeholder="Observaciones...">${visita.notas || ''}</textarea>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarVisita()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODAL CLIENTE ==========
    function renderModalCliente() {
      const cliente = itemEditando || { nombre: '', telefono: '', email: '', tipoEvento: '', fechaEvento: '', personas: '', notas: '' };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'âœï¸ Editar' : 'â• Nuevo'} Cliente</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre Completo *</label>
                <input type="text" id="cliente-nombre" value="${cliente.nombre || ''}" placeholder="Nombre del cliente" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">TelÃ©fono *</label>
                  <input type="tel" id="cliente-telefono" value="${cliente.telefono || ''}" placeholder="55 1234 5678" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Email</label>
                  <input type="email" id="cliente-email" value="${cliente.email || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Tipo de Evento</label>
                  <select id="cliente-tipoEvento" class="w-full mt-1 p-3 border rounded-xl">
                    <option value="">Seleccionar...</option>
                    ${['Boda', 'XV AÃ±os', 'Bautizo', 'Primera ComuniÃ³n', 'CumpleaÃ±os', 'GraduaciÃ³n', 'Baby Shower', 'Corporativo', 'Otro'].map(t => `<option value="${t}" ${cliente.tipoEvento === t ? 'selected' : ''}>${t}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Personas</label>
                  <input type="number" id="cliente-personas" value="${cliente.personas || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Fecha del Evento</label>
                <input type="date" id="cliente-fechaEvento" value="${cliente.fechaEvento || ''}" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Notas</label>
                <textarea id="cliente-notas" rows="2" class="w-full mt-1 p-3 border rounded-xl" placeholder="Observaciones adicionales...">${cliente.notas || ''}</textarea>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarCliente()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODAL PROVEEDOR ==========
    function renderModalProveedor() {
      const proveedor = itemEditando || { nombre: '', contacto: '', telefono: '', email: '', categoria: '', direccion: '', notas: '' };
      const categorias = ['Mobiliario', 'Carpas', 'Catering', 'DecoraciÃ³n', 'Audio/IluminaciÃ³n', 'FotografÃ­a', 'Flores', 'Transporte', 'Otros'];
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'âœï¸ Editar' : 'â• Nuevo'} Proveedor</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre de la Empresa *</label>
                <input type="text" id="proveedor-nombre" value="${proveedor.nombre || ''}" placeholder="Nombre del proveedor" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">CategorÃ­a *</label>
                <select id="proveedor-categoria" class="w-full mt-1 p-3 border rounded-xl">
                  <option value="">Seleccionar...</option>
                  ${categorias.map(c => `<option value="${c}" ${proveedor.categoria === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Persona de Contacto</label>
                <input type="text" id="proveedor-contacto" value="${proveedor.contacto || ''}" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">TelÃ©fono *</label>
                  <input type="tel" id="proveedor-telefono" value="${proveedor.telefono || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Email</label>
                  <input type="email" id="proveedor-email" value="${proveedor.email || ''}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">DirecciÃ³n</label>
                <input type="text" id="proveedor-direccion" value="${proveedor.direccion || ''}" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Notas</label>
                <textarea id="proveedor-notas" rows="2" class="w-full mt-1 p-3 border rounded-xl" placeholder="Productos, precios, observaciones...">${proveedor.notas || ''}</textarea>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarProveedor()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODAL COBRAR ORDEN ==========
    function renderModalCobrarOrden() {
      if (!itemEditando) return '';
      const orden = itemEditando;
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ’µ Cobrar Orden #${orden.numero || orden.id?.slice(-4)}</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div class="bg-amber-50 rounded-xl p-4 text-center">
                <p class="text-sm text-amber-700">Total a Cobrar</p>
                <p class="text-4xl font-bold text-amber-800">${fmt(orden.total)}</p>
              </div>
              
              <div>
                <label class="text-sm font-medium text-gray-700">MÃ©todo de Pago</label>
                <select id="cobro-metodo" class="w-full mt-1 p-3 border rounded-xl">
                  <option value="efectivo">ğŸ’µ Efectivo</option>
                  <option value="tarjeta">ğŸ’³ Tarjeta</option>
                  <option value="transferencia">ğŸ“² Transferencia</option>
                </select>
              </div>
              
              <div id="seccion-efectivo">
                <label class="text-sm font-medium text-gray-700">Recibido</label>
                <input type="number" id="cobro-recibido" value="${orden.total}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" oninput="calcularCambio()" />
                <div class="mt-2 p-3 bg-green-50 rounded-xl flex justify-between items-center">
                  <span class="text-green-700">Cambio:</span>
                  <span id="cobro-cambio" class="text-xl font-bold text-green-800">${fmt(0)}</span>
                </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="procesarCobro('${orden.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium">âœ“ Cobrar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODAL INSUMO ==========
    function renderModalInsumo() {
      const insumo = itemEditando || { nombre: '', categoria: '', unidad: 'piezas', cantidad: 0, minimo: 5, precioUnitario: 0 };
      const categorias = ['Carnes', 'Verduras', 'LÃ¡cteos', 'Abarrotes', 'Bebidas', 'Desechables', 'Limpieza', 'Otros'];
      const unidades = ['piezas', 'kg', 'litros', 'gramos', 'ml', 'cajas', 'paquetes'];
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'âœï¸ Editar' : 'â• Nuevo'} Insumo</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre del Insumo *</label>
                <input type="text" id="insumo-nombre" value="${insumo.nombre || ''}" placeholder="Ej: Aceite vegetal" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">CategorÃ­a</label>
                  <select id="insumo-categoria" class="w-full mt-1 p-3 border rounded-xl">
                    <option value="">Seleccionar...</option>
                    ${categorias.map(c => `<option value="${c}" ${insumo.categoria === c ? 'selected' : ''}>${c}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Unidad</label>
                  <select id="insumo-unidad" class="w-full mt-1 p-3 border rounded-xl">
                    ${unidades.map(u => `<option value="${u}" ${insumo.unidad === u ? 'selected' : ''}>${u}</option>`).join('')}
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Cantidad Actual</label>
                  <input type="number" id="insumo-cantidad" value="${insumo.cantidad || 0}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Stock MÃ­nimo</label>
                  <input type="number" id="insumo-minimo" value="${insumo.minimo || 5}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Precio Unit.</label>
                  <input type="number" id="insumo-precio" value="${insumo.precioUnitario || 0}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarInsumo()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODALES DE CATERING ==========
    function renderModalNuevaCotizacionCatering() {
      const cat = window.cateringActual;
      const calculos = calcularTotalCatering();
      const tipoSeleccionado = TIPOS_CATERING.find(t => t.id === cat.tipoServicio);
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-t-2xl sticky top-0">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${cat.id ? 'âœï¸ Editar' : 'â• Nueva'} CotizaciÃ³n de Catering</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-5 space-y-6">
              <!-- Datos del Cliente -->
              <div class="bg-gray-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ‘¤ Datos del Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Nombre del Cliente *</label>
                    <input type="text" value="${cat.cliente || ''}" onchange="window.cateringActual.cliente = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" placeholder="Nombre completo" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Empresa</label>
                    <input type="text" value="${cat.empresa || ''}" onchange="window.cateringActual.empresa = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" placeholder="Nombre de la empresa" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">TelÃ©fono</label>
                    <input type="tel" value="${cat.telefono || ''}" onchange="window.cateringActual.telefono = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" placeholder="55 1234 5678" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <input type="email" value="${cat.email || ''}" onchange="window.cateringActual.email = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" placeholder="correo@empresa.com" />
                  </div>
                </div>
              </div>

              <!-- Datos del Evento -->
              <div class="bg-blue-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ“… Datos del Evento</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Fecha *</label>
                    <input type="date" value="${cat.fechaEvento || ''}" onchange="window.cateringActual.fechaEvento = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Hora Inicio</label>
                    <input type="time" value="${cat.horaInicio || '09:00'}" onchange="window.cateringActual.horaInicio = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Hora Fin</label>
                    <input type="time" value="${cat.horaFin || '14:00'}" onchange="window.cateringActual.horaFin = this.value" 
                      class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Personas *</label>
                    <input type="number" value="${cat.personas || 20}" min="1" onchange="window.cateringActual.personas = parseInt(this.value); render()" 
                      class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
                <div class="mt-4">
                  <label class="text-sm font-medium text-gray-700">UbicaciÃ³n</label>
                  <input type="text" value="${cat.ubicacion || ''}" onchange="window.cateringActual.ubicacion = this.value" 
                    class="w-full mt-1 p-3 border rounded-xl" placeholder="DirecciÃ³n del evento" />
                </div>
              </div>

              <!-- Tipo de Servicio -->
              <div class="bg-amber-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">ğŸ± Tipo de Servicio</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  ${TIPOS_CATERING.map(t => `
                    <div onclick="window.cateringActual.tipoServicio = '${t.id}'; render()" 
                      class="border-2 rounded-xl p-4 cursor-pointer transition-all ${cat.tipoServicio === t.id ? 'border-amber-500 bg-amber-100' : 'border-gray-200 bg-white hover:border-amber-300'}">
                      <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-sm">${t.nombre}</span>
                        <span class="text-amber-600 font-bold text-sm">${t.precioBase > 0 ? fmt(t.precioBase) : 'Cotizar'}</span>
                      </div>
                      <p class="text-xs text-gray-600">${t.descripcion}</p>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Productos del MenÃº (solo para MenÃº Personalizado) -->
              ${cat.tipoServicio === 'personalizado' ? `
                <div class="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                  <div class="flex justify-between items-center mb-4">
                    <div>
                      <h3 class="font-semibold">ğŸ½ï¸ Armar MenÃº con Productos del Restaurante</h3>
                      <p class="text-sm text-gray-600">Selecciona los platillos para este evento</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <label class="text-sm text-gray-600">Margen adicional:</label>
                      <input type="number" value="${cat.margenCatering || 30}" min="0" max="100" 
                        onchange="window.cateringActual.margenCatering = parseFloat(this.value); render()" 
                        class="w-20 p-2 border rounded-lg text-center" />
                      <span class="text-sm text-gray-600">%</span>
                    </div>
                  </div>
                  
                  <!-- Productos seleccionados -->
                  ${cat.productosMenu?.length > 0 ? `
                    <div class="mb-4 bg-white rounded-xl p-4">
                      <h4 class="font-medium text-sm text-gray-700 mb-3">âœ… Productos Seleccionados</h4>
                      <div class="space-y-2">
                        ${cat.productosMenu.map(pm => {
                          const prod = productos.find(p => p.id === pm.productoId);
                          if (!prod) return '';
                          const cantidadTotal = pm.porPersona ? pm.cantidad * (cat.personas || 1) : pm.cantidad;
                          const precioTotal = prod.precio * cantidadTotal;
                          const costoTotal = (prod.costo || prod.precio * 0.35) * cantidadTotal;
                          return `
                            <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
                              <div class="flex-1">
                                <p class="font-medium">${prod.nombre}</p>
                                <p class="text-xs text-gray-500">${prod.categoria} â€¢ Costo: ${fmt(prod.costo || prod.precio * 0.35)} â€¢ Precio: ${fmt(prod.precio)}</p>
                              </div>
                              <div class="flex items-center gap-2">
                                <input type="number" value="${pm.cantidad}" min="1" 
                                  onchange="actualizarProductoMenuCatering('${pm.productoId}', 'cantidad', parseInt(this.value))" 
                                  class="w-16 p-2 border rounded-lg text-center" />
                                <label class="flex items-center gap-1 text-sm whitespace-nowrap">
                                  <input type="checkbox" ${pm.porPersona ? 'checked' : ''} 
                                    onchange="actualizarProductoMenuCatering('${pm.productoId}', 'porPersona', this.checked)" />
                                  x persona
                                </label>
                              </div>
                              <div class="text-right min-w-[80px]">
                                <p class="font-bold text-amber-700">${fmt(precioTotal)}</p>
                                <p class="text-xs text-gray-500">${cantidadTotal} uds</p>
                              </div>
                              <button onclick="quitarProductoMenuCatering('${pm.productoId}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">âœ•</button>
                            </div>
                          `;
                        }).join('')}
                      </div>
                      <div class="mt-3 pt-3 border-t flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                          Costo total productos: <span class="font-bold text-red-600">${fmt(calculos.costoTotal)}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                          Utilidad estimada: <span class="font-bold text-green-600">${fmt(calculos.utilidadEstimada)} (${calculos.margenUtilidad.toFixed(1)}%)</span>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                  
                  <!-- CatÃ¡logo de productos -->
                  <div class="bg-white rounded-xl p-4">
                    <h4 class="font-medium text-sm text-gray-700 mb-3">ğŸ“‹ CatÃ¡logo de Productos</h4>
                    <div class="max-h-[300px] overflow-y-auto">
                      ${(() => {
                        const categorias = [...new Set(productos.filter(p => p.activo !== false).map(p => p.categoria))];
                        return categorias.map(cat => `
                          <div class="mb-4">
                            <h5 class="font-semibold text-sm text-gray-600 mb-2 sticky top-0 bg-white py-1">${cat}</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                              ${productos.filter(p => p.categoria === cat && p.activo !== false).map(p => {
                                const yaSeleccionado = window.cateringActual.productosMenu?.some(pm => pm.productoId === p.id);
                                return `
                                  <div onclick="${yaSeleccionado ? '' : `agregarProductoMenuCatering('${p.id}')`}" 
                                    class="flex justify-between items-center p-2 rounded-lg cursor-pointer transition-all ${yaSeleccionado ? 'bg-green-100 border border-green-300' : 'bg-gray-50 hover:bg-amber-50 border border-transparent'}">
                                    <div>
                                      <p class="font-medium text-sm">${p.nombre}</p>
                                      <p class="text-xs text-gray-500">Costo: ${fmt(p.costo || p.precio * 0.35)}</p>
                                    </div>
                                    <div class="text-right">
                                      <p class="font-bold text-amber-600">${fmt(p.precio)}</p>
                                      ${yaSeleccionado ? '<span class="text-xs text-green-600">âœ“ Agregado</span>' : '<span class="text-xs text-gray-400">Click para agregar</span>'}
                                    </div>
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          </div>
                        `).join('');
                      })()}
                    </div>
                  </div>
                </div>
              ` : ''}

              <!-- Items Personalizados -->
              <div class="bg-green-50 rounded-xl p-4">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="font-semibold">ğŸ›’ Items Adicionales / Personalizados</h3>
                  <button onclick="agregarItemPersonalizado()" class="text-sm bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">
                    + Agregar Item
                  </button>
                </div>
                ${cat.itemsPersonalizados?.length > 0 ? `
                  <div class="space-y-2">
                    ${cat.itemsPersonalizados.map((item, idx) => `
                      <div class="flex gap-3 items-center bg-white p-3 rounded-lg">
                        <input type="text" value="${item.nombre}" onchange="actualizarItemPersonalizado(${idx}, 'nombre', this.value)" 
                          class="flex-1 p-2 border rounded-lg" placeholder="Nombre del item" />
                        <input type="number" value="${item.precio}" onchange="actualizarItemPersonalizado(${idx}, 'precio', parseFloat(this.value)); render()" 
                          class="w-24 p-2 border rounded-lg" placeholder="Precio" />
                        <label class="flex items-center gap-1 text-sm">
                          <input type="checkbox" ${item.porPersona ? 'checked' : ''} onchange="actualizarItemPersonalizado(${idx}, 'porPersona', this.checked); render()" />
                          /persona
                        </label>
                        <button onclick="eliminarItemPersonalizado(${idx})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                      </div>
                    `).join('')}
                  </div>
                ` : '<p class="text-gray-500 text-sm text-center py-4">Sin items adicionales</p>'}
              </div>

              <!-- Extras -->
              <div class="bg-purple-50 rounded-xl p-4">
                <h3 class="font-semibold mb-4">âœ¨ Servicios Extra</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  ${EXTRAS_CATERING.map(e => `
                    <div onclick="toggleExtraCatering('${e.id}')" 
                      class="border-2 rounded-xl p-3 cursor-pointer transition-all ${cat.extras?.includes(e.id) ? 'border-purple-500 bg-purple-100' : 'border-gray-200 bg-white hover:border-purple-300'}">
                      <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">${e.nombre}</span>
                        <span class="text-purple-600 font-bold text-sm">${e.precioPP ? fmt(e.precioPP) + '/pp' : fmt(e.precio)}</span>
                      </div>
                      <p class="text-xs text-gray-500">${e.descripcion}</p>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Notas y Descuento -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Notas / Observaciones</label>
                  <textarea rows="3" onchange="window.cateringActual.notas = this.value" 
                    class="w-full mt-1 p-3 border rounded-xl" placeholder="Requerimientos especiales...">${cat.notas || ''}</textarea>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Descuento (%)</label>
                  <input type="number" value="${cat.descuento || 0}" min="0" max="100" 
                    onchange="window.cateringActual.descuento = parseFloat(this.value); render()" 
                    class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>

              <!-- Resumen de Costos -->
              <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl p-5 text-white">
                <h3 class="font-semibold mb-4">ğŸ’° Resumen de CotizaciÃ³n</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                  <div class="bg-white/20 rounded-lg p-3">
                    <p class="text-amber-100 text-sm">Subtotal</p>
                    <p class="text-xl font-bold">${fmt(calculos.subtotal)}</p>
                  </div>
                  <div class="bg-white/20 rounded-lg p-3">
                    <p class="text-amber-100 text-sm">Descuento</p>
                    <p class="text-xl font-bold">-${fmt(calculos.descuentoMonto)}</p>
                  </div>
                  <div class="bg-white/20 rounded-lg p-3">
                    <p class="text-amber-100 text-sm">IVA (16%)</p>
                    <p class="text-xl font-bold">${fmt(calculos.iva)}</p>
                  </div>
                  <div class="bg-white/30 rounded-lg p-3">
                    <p class="text-amber-100 text-sm">Total</p>
                    <p class="text-2xl font-bold">${fmt(calculos.total)}</p>
                  </div>
                </div>
                <div class="mt-4 text-center">
                  <p class="text-amber-100">Precio por persona: <span class="font-bold">${fmt(calculos.total / (cat.personas || 1))}</span></p>
                </div>
              </div>

              <!-- Botones -->
              <div class="flex gap-3">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-4 rounded-xl font-medium">
                  Cancelar
                </button>
                <button onclick="guardarCotizacionCatering()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-4 rounded-xl font-medium">
                  ğŸ’¾ Guardar CotizaciÃ³n
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalVerCotizacionCatering() {
      const cot = itemEditando;
      if (!cot) return '';
      
      const tipo = TIPOS_CATERING.find(t => t.id === cot.tipoServicio) || { nombre: cot.tipoServicio };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-t-2xl">
              <div class="flex justify-between items-center">
                <div>
                  <h2 class="text-xl font-bold">ğŸ± CotizaciÃ³n #CAT-${cot.folio || cot.id?.slice(-4)}</h2>
                  <p class="text-amber-100">${tipo.nombre}</p>
                </div>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-5 space-y-4">
              <!-- Info Cliente -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500">Cliente</p>
                  <p class="font-semibold">${cot.cliente || '-'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Empresa</p>
                  <p class="font-semibold">${cot.empresa || '-'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">TelÃ©fono</p>
                  <p class="font-semibold">${cot.telefono || '-'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Email</p>
                  <p class="font-semibold">${cot.email || '-'}</p>
                </div>
              </div>

              <hr />

              <!-- Info Evento -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500">Fecha del Evento</p>
                  <p class="font-semibold">${fmtFecha(cot.fechaEvento)}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Horario</p>
                  <p class="font-semibold">${cot.horaInicio || '00:00'} - ${cot.horaFin || '00:00'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Personas</p>
                  <p class="font-semibold text-xl">${cot.personas}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">UbicaciÃ³n</p>
                  <p class="font-semibold">${cot.ubicacion || '-'}</p>
                </div>
              </div>

              ${cot.extras?.length > 0 ? `
                <div class="bg-purple-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500 mb-2">Servicios Extra</p>
                  <div class="flex flex-wrap gap-2">
                    ${cot.extras.map(e => {
                      const extra = EXTRAS_CATERING.find(x => x.id === e);
                      return `<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">${extra?.nombre || e}</span>`;
                    }).join('')}
                  </div>
                </div>
              ` : ''}

              ${cot.productosMenu?.length > 0 ? `
                <div class="bg-orange-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500 mb-2">ğŸ½ï¸ Productos del MenÃº</p>
                  <div class="space-y-2">
                    ${cot.productosMenu.map(pm => {
                      const prod = productos.find(p => p.id === pm.productoId);
                      const cantidadTotal = pm.porPersona ? pm.cantidad * (cot.personas || 1) : pm.cantidad;
                      return `
                        <div class="flex justify-between items-center bg-white p-2 rounded-lg">
                          <div>
                            <p class="font-medium">${prod?.nombre || 'Producto'}</p>
                            <p class="text-xs text-gray-500">${pm.cantidad} ${pm.porPersona ? 'x persona' : 'unidades'} = ${cantidadTotal} total</p>
                          </div>
                          <p class="font-bold text-amber-600">${fmt((prod?.precio || 0) * cantidadTotal)}</p>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  ${cot.margenCatering ? `<p class="text-xs text-gray-500 mt-2">+ Margen catering: ${cot.margenCatering}%</p>` : ''}
                </div>
              ` : ''}

              ${cot.notas ? `
                <div class="bg-gray-50 rounded-xl p-4">
                  <p class="text-sm text-gray-500 mb-2">Notas</p>
                  <p>${cot.notas}</p>
                </div>
              ` : ''}

              <!-- Totales -->
              <div class="bg-amber-50 rounded-xl p-5">
                <div class="grid grid-cols-2 gap-4 text-right">
                  <p class="text-gray-600">Subtotal:</p>
                  <p class="font-semibold">${fmt(cot.subtotal || 0)}</p>
                  ${cot.descuentoMonto > 0 ? `
                    <p class="text-gray-600">Descuento (${cot.descuento}%):</p>
                    <p class="font-semibold text-green-600">-${fmt(cot.descuentoMonto)}</p>
                  ` : ''}
                  <p class="text-gray-600">IVA (16%):</p>
                  <p class="font-semibold">${fmt(cot.iva || 0)}</p>
                  <p class="text-xl font-bold">Total:</p>
                  <p class="text-2xl font-bold text-amber-600">${fmt(cot.total || 0)}</p>
                </div>
                <div class="mt-4 text-center text-gray-600">
                  Precio por persona: <span class="font-bold">${fmt((cot.total || 0) / (cot.personas || 1))}</span>
                </div>
              </div>

              <!-- Estado y Acciones -->
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500">Estado actual</p>
                  <span class="px-3 py-1 rounded-full text-sm font-medium ${
                    cot.estado === 'pendiente' ? 'bg-yellow-100 text-yellow-800' :
                    cot.estado === 'confirmado' ? 'bg-blue-100 text-blue-800' :
                    cot.estado === 'realizado' || cot.estado === 'pagado' ? 'bg-green-100 text-green-800' :
                    'bg-red-100 text-red-800'
                  }">${cot.estado || 'pendiente'}</span>
                </div>
                <div class="flex gap-2">
                  ${cot.estado === 'pendiente' ? `
                    <button onclick="cambiarEstadoCatering('${cot.id}', 'confirmado'); cerrarModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700">âœ… Confirmar</button>
                  ` : ''}
                  ${cot.estado === 'confirmado' ? `
                    <button onclick="cambiarEstadoCatering('${cot.id}', 'realizado'); cerrarModal()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700">ğŸ‰ Marcar Realizado</button>
                  ` : ''}
                  ${cot.estado !== 'cancelado' && cot.estado !== 'realizado' ? `
                    <button onclick="cambiarEstadoCatering('${cot.id}', 'cancelado'); cerrarModal()" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl hover:bg-red-200">âŒ Cancelar</button>
                  ` : ''}
                </div>
              </div>

              <div class="flex gap-3">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium">
                  Cerrar
                </button>
                <button onclick="editarCotizacionCatering('${cot.id}'); " class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl font-medium">
                  âœï¸ Editar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========== MODALES DE CONFIGURACIÃ“N DE CATERING ==========
    function renderModalConfigCatering() {
      const tabActiva = window.tabConfigCatering || 'paquetes';
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-t-2xl sticky top-0 z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">âš™ï¸ ConfiguraciÃ³n de Catering</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            
            <div class="p-5 space-y-6">
              <!-- Tabs -->
              <div class="flex gap-2 border-b pb-4">
                <button onclick="window.tabConfigCatering = 'paquetes'; render()" 
                  class="px-4 py-2 rounded-xl font-medium ${tabActiva === 'paquetes' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                  ğŸ“¦ Paquetes de Servicio
                </button>
                <button onclick="window.tabConfigCatering = 'extras'; render()" 
                  class="px-4 py-2 rounded-xl font-medium ${tabActiva === 'extras' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                  âœ¨ Servicios Extra
                </button>
              </div>

              ${tabActiva === 'paquetes' ? `
                <!-- Paquetes de Servicio -->
                <div>
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">ğŸ“¦ Paquetes de Servicio</h3>
                    <button onclick="agregarPaqueteCatering()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-xl text-sm">
                      + Agregar Paquete
                    </button>
                  </div>
                  <div class="space-y-3">
                    ${paquetesCatering.map((p, idx) => `
                      <div class="bg-gray-50 rounded-xl p-4 border ${p.id === 'personalizado' ? 'border-orange-200 bg-orange-50' : ''}">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <h4 class="font-bold">${p.nombre}</h4>
                              ${p.id === 'personalizado' ? '<span class="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded">Especial</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600">${p.descripcion}</p>
                            <div class="flex gap-4 mt-2 text-sm">
                              <span class="text-amber-700 font-semibold">Precio: ${fmt(p.precioBase)}/pp</span>
                              <span class="text-red-600">Costo: ${fmt(p.costo || 0)}/pp</span>
                              <span class="text-green-600">Utilidad: ${fmt((p.precioBase || 0) - (p.costo || 0))}/pp (${p.precioBase > 0 ? Math.round(((p.precioBase - (p.costo || 0)) / p.precioBase) * 100) : 0}%)</span>
                            </div>
                          </div>
                          <div class="flex gap-1">
                            <button onclick="editarPaqueteCatering(${idx})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Editar">âœï¸</button>
                            ${p.id !== 'personalizado' ? `
                              <button onclick="eliminarPaqueteCatering(${idx})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Eliminar">ğŸ—‘ï¸</button>
                            ` : ''}
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="mt-4 flex justify-between">
                    <button onclick="restaurarPaquetesDefault()" class="text-sm text-gray-500 hover:text-gray-700">
                      â†©ï¸ Restaurar valores por defecto
                    </button>
                    <button onclick="guardarPaquetesCatering()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-xl font-medium">
                      ğŸ’¾ Guardar Cambios
                    </button>
                  </div>
                </div>
              ` : `
                <!-- Servicios Extra -->
                <div>
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">âœ¨ Servicios Extra</h3>
                    <button onclick="agregarExtraCateringConfig()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl text-sm">
                      + Agregar Extra
                    </button>
                  </div>
                  <div class="space-y-3">
                    ${extrasCatering.map((e, idx) => `
                      <div class="bg-gray-50 rounded-xl p-4 border">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <h4 class="font-bold">${e.nombre}</h4>
                            <p class="text-sm text-gray-600">${e.descripcion}</p>
                            <div class="flex gap-4 mt-2 text-sm">
                              ${e.precioPP > 0 ? `
                                <span class="text-purple-700 font-semibold">Precio: ${fmt(e.precioPP)}/pp</span>
                                <span class="text-red-600">Costo: ${fmt(e.costo || 0)}/pp</span>
                              ` : `
                                <span class="text-purple-700 font-semibold">Precio: ${fmt(e.precio)} (fijo)</span>
                                <span class="text-red-600">Costo: ${fmt(e.costo || 0)}</span>
                              `}
                            </div>
                          </div>
                          <div class="flex gap-1">
                            <button onclick="editarExtraCateringConfig(${idx})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Editar">âœï¸</button>
                            <button onclick="eliminarExtraCateringConfig(${idx})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Eliminar">ğŸ—‘ï¸</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="mt-4 flex justify-between">
                    <button onclick="restaurarExtrasDefault()" class="text-sm text-gray-500 hover:text-gray-700">
                      â†©ï¸ Restaurar valores por defecto
                    </button>
                    <button onclick="guardarExtrasCatering()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-xl font-medium">
                      ğŸ’¾ Guardar Cambios
                    </button>
                  </div>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderModalEditarPaqueteCatering() {
      const idx = window.idxPaqueteEditar;
      const p = idx !== undefined && idx !== null ? paquetesCatering[idx] : { id: '', nombre: '', descripcion: '', precioBase: 0, costo: 0 };
      const esNuevo = idx === null || idx === undefined;
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModalPaquete()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${esNuevo ? 'â• Nuevo' : 'âœï¸ Editar'} Paquete</h2>
                <button onclick="cerrarModalPaquete()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre del Paquete *</label>
                <input type="text" id="paq-nombre" value="${p.nombre}" placeholder="Ej: Coffee Break Ejecutivo" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">DescripciÃ³n</label>
                <input type="text" id="paq-descripcion" value="${p.descripcion}" placeholder="QuÃ© incluye este paquete" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Precio por Persona *</label>
                  <input type="number" id="paq-precio" value="${p.precioBase}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Costo por Persona</label>
                  <input type="number" id="paq-costo" value="${p.costo || 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              
              <!-- Vista previa de margen -->
              <div class="bg-green-50 rounded-xl p-4">
                <p class="text-sm text-gray-600">Utilidad estimada por persona:</p>
                <p class="text-xl font-bold text-green-600" id="paq-utilidad-preview">
                  ${fmt((p.precioBase || 0) - (p.costo || 0))} (${p.precioBase > 0 ? Math.round(((p.precioBase - (p.costo || 0)) / p.precioBase) * 100) : 0}%)
                </p>
              </div>
              
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModalPaquete()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarPaqueteIndividual(${idx !== null && idx !== undefined ? idx : 'null'})" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalEditarExtraCatering() {
      const idx = window.idxExtraEditar;
      const e = idx !== undefined && idx !== null ? extrasCatering[idx] : { id: '', nombre: '', descripcion: '', precioPP: 0, precio: 0, costo: 0 };
      const esNuevo = idx === null || idx === undefined;
      const tipoPrecio = e.precioPP > 0 ? 'pp' : 'fijo';
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModalExtra()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${esNuevo ? 'â• Nuevo' : 'âœï¸ Editar'} Servicio Extra</h2>
                <button onclick="cerrarModalExtra()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-700">Nombre del Servicio *</label>
                <input type="text" id="ext-nombre" value="${e.nombre}" placeholder="Ej: Servicio de Meseros" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">DescripciÃ³n</label>
                <input type="text" id="ext-descripcion" value="${e.descripcion}" placeholder="Detalle del servicio" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              
              <div>
                <label class="text-sm font-medium text-gray-700">Tipo de Precio</label>
                <div class="flex gap-3 mt-2">
                  <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer flex-1 ${tipoPrecio === 'pp' ? 'bg-purple-50 border-purple-300' : ''}">
                    <input type="radio" name="tipoPrecio" value="pp" ${tipoPrecio === 'pp' ? 'checked' : ''} onchange="document.getElementById('ext-pp-container').style.display='block'; document.getElementById('ext-fijo-container').style.display='none';" />
                    <span>Por Persona</span>
                  </label>
                  <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer flex-1 ${tipoPrecio === 'fijo' ? 'bg-purple-50 border-purple-300' : ''}">
                    <input type="radio" name="tipoPrecio" value="fijo" ${tipoPrecio === 'fijo' ? 'checked' : ''} onchange="document.getElementById('ext-pp-container').style.display='none'; document.getElementById('ext-fijo-container').style.display='block';" />
                    <span>Precio Fijo</span>
                  </label>
                </div>
              </div>
              
              <div id="ext-pp-container" style="display: ${tipoPrecio === 'pp' ? 'block' : 'none'}">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Precio por Persona</label>
                    <input type="number" id="ext-precioPP" value="${e.precioPP || 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Costo por Persona</label>
                    <input type="number" id="ext-costoPP" value="${e.precioPP > 0 ? (e.costo || 0) : 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>
              
              <div id="ext-fijo-container" style="display: ${tipoPrecio === 'fijo' ? 'block' : 'none'}">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-700">Precio Fijo</label>
                    <input type="number" id="ext-precioFijo" value="${e.precio || 0}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-700">Costo</label>
                    <input type="number" id="ext-costoFijo" value="${e.precioPP > 0 ? 0 : (e.costo || 0)}" step="0.01" min="0" class="w-full mt-1 p-3 border rounded-xl" />
                  </div>
                </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModalExtra()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarExtraIndividual(${idx !== null && idx !== undefined ? idx : 'null'})" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Funciones para manejar paquetes de catering
    window.agregarPaqueteCatering = () => {
      window.idxPaqueteEditar = null;
      modalAbierto = 'editarPaqueteCatering';
      render();
    };

    window.editarPaqueteCatering = (idx) => {
      window.idxPaqueteEditar = idx;
      modalAbierto = 'editarPaqueteCatering';
      render();
    };

    window.eliminarPaqueteCatering = (idx) => {
      if (paquetesCatering[idx]?.id === 'personalizado') {
        alert('No se puede eliminar el paquete de MenÃº Personalizado');
        return;
      }
      if (!confirm('Â¿Eliminar este paquete?')) return;
      paquetesCatering.splice(idx, 1);
      render();
    };

    window.cerrarModalPaquete = () => {
      window.idxPaqueteEditar = null;
      modalAbierto = 'configCatering';
      render();
    };

    window.guardarPaqueteIndividual = (idx) => {
      const nombre = document.getElementById('paq-nombre').value.trim();
      const descripcion = document.getElementById('paq-descripcion').value.trim();
      const precioBase = parseFloat(document.getElementById('paq-precio').value) || 0;
      const costo = parseFloat(document.getElementById('paq-costo').value) || 0;
      
      if (!nombre) {
        alert('El nombre es obligatorio');
        return;
      }
      
      const paquete = {
        id: idx !== null ? paquetesCatering[idx].id : nombre.toLowerCase().replace(/\s+/g, '-'),
        nombre,
        descripcion,
        precioBase,
        costo
      };
      
      if (idx !== null) {
        paquetesCatering[idx] = paquete;
      } else {
        // Insertar antes del "personalizado"
        const idxPersonalizado = paquetesCatering.findIndex(p => p.id === 'personalizado');
        if (idxPersonalizado >= 0) {
          paquetesCatering.splice(idxPersonalizado, 0, paquete);
        } else {
          paquetesCatering.push(paquete);
        }
      }
      
      cerrarModalPaquete();
    };

    window.guardarPaquetesCatering = async () => {
      try {
        await guardarConfiguracion('paquetesCatering', paquetesCatering);
        alert('âœ… Paquetes guardados correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.restaurarPaquetesDefault = () => {
      if (!confirm('Â¿Restaurar los paquetes a los valores por defecto?\n\nEsto sobrescribirÃ¡ los cambios actuales.')) return;
      paquetesCatering = [...TIPOS_CATERING_DEFAULT];
      render();
    };

    // Funciones para manejar extras de catering
    window.agregarExtraCateringConfig = () => {
      window.idxExtraEditar = null;
      modalAbierto = 'editarExtraCatering';
      render();
    };

    window.editarExtraCateringConfig = (idx) => {
      window.idxExtraEditar = idx;
      modalAbierto = 'editarExtraCatering';
      render();
    };

    window.eliminarExtraCateringConfig = (idx) => {
      if (!confirm('Â¿Eliminar este servicio extra?')) return;
      extrasCatering.splice(idx, 1);
      render();
    };

    window.cerrarModalExtra = () => {
      window.idxExtraEditar = null;
      modalAbierto = 'configCatering';
      window.tabConfigCatering = 'extras';
      render();
    };

    window.guardarExtraIndividual = (idx) => {
      const nombre = document.getElementById('ext-nombre').value.trim();
      const descripcion = document.getElementById('ext-descripcion').value.trim();
      const tipoPrecio = document.querySelector('input[name="tipoPrecio"]:checked')?.value || 'pp';
      
      let precioPP = 0, precio = 0, costo = 0;
      
      if (tipoPrecio === 'pp') {
        precioPP = parseFloat(document.getElementById('ext-precioPP').value) || 0;
        costo = parseFloat(document.getElementById('ext-costoPP').value) || 0;
      } else {
        precio = parseFloat(document.getElementById('ext-precioFijo').value) || 0;
        costo = parseFloat(document.getElementById('ext-costoFijo').value) || 0;
      }
      
      if (!nombre) {
        alert('El nombre es obligatorio');
        return;
      }
      
      const extra = {
        id: idx !== null ? extrasCatering[idx].id : nombre.toLowerCase().replace(/\s+/g, '-'),
        nombre,
        descripcion,
        precioPP,
        precio,
        costo
      };
      
      if (idx !== null) {
        extrasCatering[idx] = extra;
      } else {
        extrasCatering.push(extra);
      }
      
      cerrarModalExtra();
    };

    window.guardarExtrasCatering = async () => {
      try {
        await guardarConfiguracion('extrasCatering', extrasCatering);
        alert('âœ… Servicios extra guardados correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.restaurarExtrasDefault = () => {
      if (!confirm('Â¿Restaurar los servicios extra a los valores por defecto?\n\nEsto sobrescribirÃ¡ los cambios actuales.')) return;
      extrasCatering = [...EXTRAS_CATERING_DEFAULT];
      render();
    };

    function renderModalGastoContabilidad() {
      const gasto = itemEditando || { fecha: new Date().toISOString().slice(0, 10), area: 'restaurante', categoria: '', descripcion: '', monto: 0, proveedor: '' };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-5 border-b">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'Editar' : 'Nuevo'} Gasto</h2>
                <button onclick="cerrarModal()" class="p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-700">Fecha</label>
                  <input type="date" id="gasto-fecha" value="${gasto.fecha}" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700">Monto</label>
                  <input type="number" id="gasto-monto" value="${gasto.monto}" step="0.01" class="w-full mt-1 p-3 border rounded-xl" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Ãrea</label>
                <select id="gasto-area" onchange="actualizarCategoriasGasto()" class="w-full mt-1 p-3 border rounded-xl">
                  <option value="restaurante" ${gasto.area === 'restaurante' ? 'selected' : ''}>ğŸ½ï¸ Restaurante</option>
                  <option value="jardin" ${gasto.area === 'jardin' ? 'selected' : ''}>ğŸŒ¿ JardÃ­n</option>
                  <option value="compartido" ${gasto.area === 'compartido' ? 'selected' : ''}>ğŸ”— Compartido</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">CategorÃ­a</label>
                <select id="gasto-categoria" class="w-full mt-1 p-3 border rounded-xl">
                  ${CATEGORIAS_GASTOS[gasto.area || 'restaurante'].map(c => `<option value="${c.id}" ${gasto.categoria === c.id ? 'selected' : ''}>${c.icono} ${c.nombre}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">DescripciÃ³n</label>
                <input type="text" id="gasto-descripcion" value="${gasto.descripcion || ''}" placeholder="Detalle del gasto" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700">Proveedor (opcional)</label>
                <input type="text" id="gasto-proveedor" value="${gasto.proveedor || ''}" placeholder="Nombre del proveedor" class="w-full mt-1 p-3 border rounded-xl" />
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="cerrarModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Cancelar</button>
                <button onclick="guardarGastoContabilidad()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-medium">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalReceta() {
      const rec = itemEditando || { 
        nombre: '', productoId: '', porciones: 1, ingredientes: [], instrucciones: '' 
      };
      
      // Estado temporal para ingredientes
      if (!window.tempIngredientes) {
        window.tempIngredientes = rec.ingredientes ? [...rec.ingredientes] : [];
      }

      const costoTotal = window.tempIngredientes.reduce((sum, ing) => {
        const insumo = insumos.find(i => i.id === ing.insumoId);
        if (insumo && insumo.equivalencia > 0) {
          return sum + (insumo.precioCompra / insumo.equivalencia) * ing.cantidad;
        }
        return sum;
      }, 0);

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-t-2xl">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">${itemEditando ? 'Editar' : 'Nueva'} Receta</h2>
                <button onclick="cerrarModalReceta()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600">Nombre de la receta *</label>
                  <input id="rec-nombre" type="text" value="${rec.nombre}" placeholder="Ej: Tacos al Pastor" class="w-full p-3 border rounded-xl mt-1" />
                </div>
                <div>
                  <label class="text-sm text-gray-600">Vincular a producto</label>
                  <select id="rec-productoId" class="w-full p-3 border rounded-xl mt-1">
                    <option value="">-- Sin vincular --</option>
                    ${productos.filter(p => p.activo).map(p => `<option value="${p.id}" ${rec.productoId === p.id ? 'selected' : ''}>${p.nombre} (${fmt(p.precio)})</option>`).join('')}
                  </select>
                </div>
              </div>

              <div>
                <label class="text-sm text-gray-600">Porciones que rinde esta receta</label>
                <input id="rec-porciones" type="number" min="1" value="${rec.porciones || 1}" class="w-full p-3 border rounded-xl mt-1" />
              </div>

              <!-- Agregar ingredientes -->
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="font-medium mb-3">ğŸ¥¬ Ingredientes</p>
                <div class="flex gap-2 mb-3">
                  <select id="rec-insumo" class="flex-1 p-2 border rounded-lg">
                    <option value="">-- Seleccionar insumo --</option>
                    ${insumos.map(i => `<option value="${i.id}">${i.nombre} (${i.unidadUso})</option>`).join('')}
                  </select>
                  <input id="rec-cantidad" type="number" step="0.01" placeholder="Cantidad" class="w-24 p-2 border rounded-lg" />
                  <button onclick="agregarIngredienteReceta()" class="px-4 py-2 bg-amber-600 text-white rounded-lg">+</button>
                </div>

                <div class="space-y-2 max-h-48 overflow-y-auto">
                  ${window.tempIngredientes.map((ing, idx) => {
                    const insumo = insumos.find(i => i.id === ing.insumoId);
                    const costoIng = insumo ? (insumo.precioCompra / insumo.equivalencia) * ing.cantidad : 0;
                    return `
                      <div class="flex items-center justify-between p-2 bg-white rounded-lg border">
                        <span>${insumo?.nombre || 'No encontrado'}</span>
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500">${ing.cantidad} ${insumo?.unidadUso || ''}</span>
                          <span class="font-medium text-amber-700">${fmt(costoIng)}</span>
                          <button onclick="quitarIngredienteReceta(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded">âœ•</button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

              <!-- Resumen de costo -->
              <div class="bg-green-50 rounded-xl p-4">
                <div class="flex justify-between items-center">
                  <span class="font-medium text-green-800">Costo total de ingredientes:</span>
                  <span class="text-2xl font-bold text-green-700">${fmt(costoTotal)}</span>
                </div>
                <div class="flex justify-between items-center mt-2 text-sm">
                  <span class="text-green-600">Costo por porciÃ³n:</span>
                  <span class="font-medium text-green-700">${fmt(costoTotal / (parseInt(document.getElementById('rec-porciones')?.value) || rec.porciones || 1))}</span>
                </div>
              </div>

              <div>
                <label class="text-sm text-gray-600">Instrucciones (opcional)</label>
                <textarea id="rec-instrucciones" rows="3" placeholder="Pasos de preparaciÃ³n..." class="w-full p-3 border rounded-xl mt-1">${rec.instrucciones || ''}</textarea>
              </div>

              <button onclick="guardarReceta('${rec.id || ''}')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 rounded-xl">
                ğŸ’¾ Guardar Receta
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalVerCotizacion() {
      const cot = itemEditando;
      if (!cot) return '';
      
      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      const tipoAlimento = TIPOS_ALIMENTO.find(t => t.id === cot.tipoAlimento) || TIPOS_ALIMENTO[0];

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-5 border-b bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-t-2xl">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm opacity-80">CotizaciÃ³n</p>
                  <p class="text-2xl font-bold">${cot.folio}</p>
                </div>
                <button onclick="cerrarModal()" class="p-2 hover:bg-white/20 rounded-xl">âœ•</button>
              </div>
            </div>

            <div class="p-5 space-y-4">
              <!-- Estado -->
              <div class="flex items-center justify-between">
                <span class="px-4 py-2 rounded-full font-medium ${getEstado(cot.estado).color}">${getEstado(cot.estado).icon} ${getEstado(cot.estado).nombre}</span>
                <select onchange="cambiarEstadoCotizacion('${cot.id}', this.value)" class="p-2 border rounded-lg text-sm">
                  ${ESTADOS.map(e => `<option value="${e.id}" ${cot.estado === e.id ? 'selected' : ''}>${e.nombre}</option>`).join('')}
                </select>
              </div>

              <!-- Datos Cliente -->
              <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-semibold text-gray-700 mb-2">ğŸ‘¤ Cliente</h4>
                <p class="font-medium text-lg">${cot.cliente?.nombre}</p>
                <p class="text-gray-600">${cot.cliente?.telefono || ''} ${cot.cliente?.email ? 'â€¢ ' + cot.cliente.email : ''}</p>
              </div>

              <!-- Evento -->
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-emerald-50 rounded-xl p-4">
                  <p class="text-sm text-emerald-600">ğŸ“… Fecha del evento</p>
                  <p class="font-bold text-emerald-800">${fmtFechaLarga(cot.cliente?.fechaEvento)}</p>
                </div>
                <div class="bg-blue-50 rounded-xl p-4">
                  <p class="text-sm text-blue-600">ğŸ‘¥ Personas</p>
                  <p class="font-bold text-blue-800">${cot.personas} personas</p>
                </div>
              </div>

              <!-- Paquete y Alimentos -->
              <div class="bg-gray-50 rounded-xl p-4">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-sm text-gray-500">Paquete</p>
                    <p class="font-semibold">${paquete.nombre}</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-gray-500">Alimentos</p>
                    <p class="font-semibold">${tipoAlimento.nombre}</p>
                  </div>
                </div>
              </div>

              <!-- Totales -->
              <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl p-5 text-white">
                <div class="flex justify-between items-center mb-3">
                  <span>Mobiliario</span>
                  <span>${fmt(cot.mobiliario)}</span>
                </div>
                <div class="flex justify-between items-center mb-3">
                  <span>Alimentos</span>
                  <span>${fmt(cot.alimentos)}</span>
                </div>
                ${cot.extras > 0 ? `
                <div class="flex justify-between items-center mb-3">
                  <span>Extras</span>
                  <span>${fmt(cot.extras)}</span>
                </div>
                ` : ''}
                <div class="border-t border-white/30 pt-3 flex justify-between items-center">
                  <span class="text-lg font-bold">TOTAL</span>
                  <span class="text-2xl font-bold">${fmt(cot.total)}</span>
                </div>
                <div class="mt-2 text-sm opacity-80">
                  Anticipo (${CONFIG_NEGOCIO.condiciones.anticipo}%): ${fmt(cot.anticipo)}
                </div>
              </div>

              <!-- Acciones -->
              <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="generarPDFCotizacion('${cot.id}')" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  ğŸ“„ Generar PDF
                </button>
                <button onclick="imprimirCotizacion('${cot.id}')" class="bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  ğŸ–¨ï¸ Imprimir
                </button>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button onclick="enviarWhatsApp('${cot.id}')" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  ğŸ“± WhatsApp Cliente
                </button>
                <button onclick="enviarWhatsAppNumeroPersonalizado('${cot.id}')" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  ğŸ“² Otro NÃºmero
                </button>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button onclick="editarCotizacion('${cot.id}'); cerrarModal();" class="bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  âœï¸ Editar
                </button>
                <button onclick="eliminarDoc('cotizaciones', '${cot.id}'); cerrarModal();" class="bg-red-100 hover:bg-red-200 text-red-700 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                  ğŸ—‘ï¸ Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderModalProducto() {
      const p = itemEditando || { nombre: '', categoria: 'Platillos', precio: 0, costo: 0, activo: true };
      
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="cerrarModal()">
          <div class="bg-white rounded-2xl w-full max-w-md p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold">${itemEditando ? 'Editar' : 'Nuevo'} Producto</h2>
              <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 text-xl">âœ•</button>
            </div>
            <div class="space-y-4">
              <input id="prod-nombre" type="text" placeholder="Nombre del producto" value="${p.nombre}" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-amber-500 outline-none" />
              <select id="prod-categoria" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-amber-500 outline-none">
                <option value="Platillos" ${p.categoria === 'Platillos' ? 'selected' : ''}>Platillos</option>
                <option value="Bebidas" ${p.categoria === 'Bebidas' ? 'selected' : ''}>Bebidas</option>
                <option value="Postres" ${p.categoria === 'Postres' ? 'selected' : ''}>Postres</option>
                <option value="Entradas" ${p.categoria === 'Entradas' ? 'selected' : ''}>Entradas</option>
              </select>
              <div class="grid grid-cols-2 gap-4">
                <input id="prod-costo" type="number" placeholder="Costo" value="${p.costo}" class="p-3 border rounded-xl focus:ring-2 focus:ring-amber-500 outline-none" />
                <input id="prod-precio" type="number" placeholder="Precio venta" value="${p.precio}" class="p-3 border rounded-xl focus:ring-2 focus:ring-amber-500 outline-none" />
              </div>
              <label class="flex items-center gap-2">
                <input id="prod-activo" type="checkbox" ${p.activo ? 'checked' : ''} class="w-5 h-5" />
                <span>Producto activo</span>
              </label>
              <button onclick="guardarProducto('${p.id || ''}')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 rounded-xl">
                ğŸ’¾ Guardar Producto
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ========== ACCIONES GLOBALES ==========
    window.crearPerfilAdmin = async () => {
      if (!usuario || !usuario.uid) {
        alert('Error: No hay sesiÃ³n activa');
        return;
      }
      
      try {
        await setDoc(doc(db, 'usuarios', usuario.uid), {
          email: usuario.email,
          nombre: usuario.email.split('@')[0],
          rol: 'admin',
          activo: true,
          fechaCreacion: serverTimestamp()
        });
        alert('âœ… Â¡Perfil de administrador creado! Recargando...');
        location.reload();
      } catch (e) {
        console.error('Error creando perfil:', e);
        alert('Error: ' + e.message);
      }
    };

    window.iniciarSesion = async () => {
      const email = document.getElementById('email')?.value?.trim();
      const password = document.getElementById('password')?.value;
      
      if (!email || !password) {
        alert('Por favor ingresa tu correo y contraseÃ±a');
        return;
      }
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        if (e.code === 'auth/invalid-email') {
          alert('El correo electrÃ³nico no es vÃ¡lido');
        } else if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
          alert('ContraseÃ±a incorrecta');
        } else if (e.code === 'auth/user-not-found') {
          alert('Usuario no encontrado');
        } else {
          alert('Error al iniciar sesiÃ³n: ' + e.message);
        }
      }
    };

    window.registrarUsuario = async () => {
      const nombre = document.getElementById('nombreUsuario')?.value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('passwordConfirm')?.value;
      const rol = document.getElementById('rolUsuario')?.value || 'viewer';

      if (password !== passwordConfirm) { alert('Las contraseÃ±as no coinciden'); return; }
      if (password.length < 6) { alert('La contraseÃ±a debe tener al menos 6 caracteres'); return; }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'usuarios', userCredential.user.uid), {
          nombre: nombre || email.split('@')[0],
          email, rol,
          fechaCreacion: serverTimestamp()
        });
        alert('âœ… Cuenta creada');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.cerrarSesion = async () => {
      if (confirm('Â¿Cerrar sesiÃ³n?')) await signOut(auth);
    };

    // CotizaciÃ³n
    window.actualizarCotizacion = (campo, valor) => {
      if (campo.includes('.')) {
        const partes = campo.split('.');
        if (partes.length === 2) {
          const [obj, key] = partes;
          if (!cotizacionActual[obj]) cotizacionActual[obj] = {};
          cotizacionActual[obj][key] = valor;
        }
      } else {
        cotizacionActual[campo] = valor;
      }
      render();
    };

    window.toggleExtra = (id) => {
      if (cotizacionActual.extras.includes(id)) {
        cotizacionActual.extras = cotizacionActual.extras.filter(e => e !== id);
      } else {
        cotizacionActual.extras.push(id);
      }
      render();
    };

    window.guardarCotizacion = async () => {
      if (!cotizacionActual.cliente.nombre || !cotizacionActual.cliente.fechaEvento) {
        alert('Completa nombre del cliente y fecha del evento');
        return;
      }
      
      const calculos = calcularCotizacion(cotizacionActual);
      const id = itemEditando?.id || genId();
      
      const cotizacion = {
        ...cotizacionActual,
        folio: itemEditando?.folio || `JE-${new Date().getFullYear()}-${String(cotizaciones.length + 1).padStart(4, '0')}`,
        ...calculos,
        estado: itemEditando?.estado || 'pendiente',
        fechaCreacion: itemEditando?.fechaCreacion || serverTimestamp()
      };

      if (await guardarDoc('cotizaciones', id, cotizacion)) {
        alert('âœ… CotizaciÃ³n guardada');
        cotizacionActual = { 
          cliente: { nombre: '', telefono: '', email: '', fechaEvento: '', tipoEvento: '' }, 
          personas: 70, 
          paquete: 'basico', 
          tipoAlimento: 'taquiza', 
          extras: [], 
          descuento: 0, 
          notas: '',
          modoPersonalizado: false,
          itemsPersonalizados: [],
          alimentoPersonalizado: { nombre: '', precioPP: 0 }
        };
        itemEditando = null;
        setSeccion('cotizaciones');
      }
    };

    window.guardarYGenerarPDF = async () => {
      if (!cotizacionActual.cliente.nombre || !cotizacionActual.cliente.fechaEvento) {
        alert('Completa nombre del cliente y fecha del evento');
        return;
      }
      
      const calculos = calcularCotizacion(cotizacionActual);
      const id = genId();
      const cotizacion = {
        ...cotizacionActual,
        folio: `JE-${new Date().getFullYear()}-${String(cotizaciones.length + 1).padStart(4, '0')}`,
        ...calculos,
        estado: 'pendiente',
        fechaCreacion: serverTimestamp()
      };

      if (await guardarDoc('cotizaciones', id, cotizacion)) {
        generarPDFCotizacion(id);
        cotizacionActual = { cliente: { nombre: '', telefono: '', email: '', fechaEvento: '', tipoEvento: '' }, personas: 70, paquete: 'basico', tipoAlimento: 'taquiza', extras: [], descuento: 0, notas: '' };
      }
    };

    window.verCotizacion = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (cot) {
        modalAbierto = 'verCotizacion';
        itemEditando = cot;
        render();
      }
    };

    window.editarCotizacion = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (cot) {
        cotizacionActual = { 
          ...cot,
          cliente: cot.cliente || { nombre: '', telefono: '', email: '', fechaEvento: '', tipoEvento: '' },
          extras: cot.extras || [],
          itemsPersonalizados: cot.itemsPersonalizados || [],
          alimentoPersonalizado: cot.alimentoPersonalizado || { nombre: '', precioPP: 0 },
          modoPersonalizado: cot.modoPersonalizado || false
        };
        itemEditando = cot;
        setSeccion('nueva-cotizacion');
      }
    };

    window.generarPDFCotizacion = (id) => {
      const cot = cotizaciones.find(c => c.id === id) || { ...cotizacionActual, folio: 'PREVIEW', ...calcularCotizacion(cotizacionActual) };
      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      const tipoAlimento = TIPOS_ALIMENTO.find(t => t.id === cot.tipoAlimento) || TIPOS_ALIMENTO[0];
      
      const extrasSeleccionados = (cot.extras || []).map(eId => EXTRAS.find(e => e.id === eId)).filter(Boolean);
      
      // Construir lista de lo que incluye el paquete
      let itemsIncluidos = [];
      if (cot.modoPersonalizado && cot.itemsPersonalizados?.length > 0) {
        itemsIncluidos = cot.itemsPersonalizados;
      }

      const contenidoPDF = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <style>
            @page { 
              margin: 12mm 15mm; 
              size: A4;
              @bottom-center {
                content: "CallejÃ³n de Esfuerzo No. 4 Santa Ãšrsula Coapa Tel. 56170149";
              }
            }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
              font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; 
              font-size: 11pt; 
              color: #333; 
              line-height: 1.6;
              background: #fff;
            }
            .page { 
              max-width: 210mm; 
              margin: 0 auto; 
              padding: 0 5mm;
              position: relative;
            }
            
            /* Header con logo */
            .header {
              text-align: center;
              padding: 15px 0 20px 0;
              margin-bottom: 15px;
            }
            .logo {
              font-size: 42pt;
              font-weight: 300;
              color: #4a7c43;
              letter-spacing: 1px;
              font-family: Georgia, serif;
            }
            .logo .jar { color: #333; font-weight: 300; }
            .logo .din { color: #7cb342; }
            .logo .leaf { 
              color: #7cb342; 
              font-size: 36pt;
              position: relative;
              top: -5px;
            }
            .logo .escondido { color: #333; font-weight: 300; }
            
            /* Intro */
            .intro {
              background: #f9f9f9;
              padding: 15px 20px;
              border-radius: 8px;
              margin-bottom: 20px;
              border-left: 4px solid #7cb342;
            }
            .intro p {
              font-size: 11pt;
              color: #444;
            }
            .intro strong { color: #2d5a27; }
            
            /* Datos del evento */
            .event-info {
              display: flex;
              justify-content: space-between;
              background: linear-gradient(135deg, #2d5a27 0%, #4a7c43 100%);
              color: white;
              padding: 15px 20px;
              border-radius: 8px;
              margin-bottom: 25px;
            }
            .event-info-item {
              text-align: center;
            }
            .event-info-label {
              font-size: 9pt;
              opacity: 0.8;
              text-transform: uppercase;
              letter-spacing: 1px;
            }
            .event-info-value {
              font-size: 14pt;
              font-weight: 600;
              margin-top: 3px;
            }
            
            /* Cliente */
            .cliente-box {
              background: #fff;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 15px 20px;
              margin-bottom: 20px;
            }
            .cliente-title {
              font-size: 12pt;
              font-weight: 600;
              color: #2d5a27;
              margin-bottom: 10px;
              padding-bottom: 8px;
              border-bottom: 2px solid #e8f5e9;
            }
            .cliente-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 8px 20px;
            }
            .cliente-item {
              display: flex;
              gap: 10px;
            }
            .cliente-label { color: #666; min-width: 80px; }
            .cliente-value { font-weight: 500; }
            
            /* Paquete seleccionado */
            .paquete-section {
              margin-bottom: 25px;
            }
            .paquete-header {
              background: #2d5a27;
              color: white;
              padding: 12px 20px;
              border-radius: 8px 8px 0 0;
              font-size: 14pt;
              font-weight: 600;
            }
            .paquete-content {
              border: 2px solid #2d5a27;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 20px;
            }
            .paquete-includes {
              columns: 2;
              column-gap: 30px;
              margin-bottom: 15px;
            }
            .paquete-item {
              padding: 5px 0;
              padding-left: 25px;
              position: relative;
              break-inside: avoid;
            }
            .paquete-item::before {
              content: "âœ“";
              position: absolute;
              left: 0;
              color: #7cb342;
              font-weight: bold;
            }
            .paquete-qty {
              display: inline-block;
              background: #e8f5e9;
              color: #2d5a27;
              padding: 2px 8px;
              border-radius: 4px;
              font-weight: 600;
              margin-right: 8px;
              font-size: 10pt;
            }
            
            /* Precios del paquete */
            .precios-grid {
              display: grid;
              grid-template-columns: 1fr auto;
              gap: 10px;
              margin-top: 15px;
              padding-top: 15px;
              border-top: 1px dashed #ccc;
            }
            .precio-row {
              display: contents;
            }
            .precio-concepto {
              font-size: 11pt;
            }
            .precio-monto {
              font-weight: 600;
              color: #2d5a27;
              text-align: right;
              font-size: 12pt;
            }
            
            /* Barra mezcladores */
            .barra-box {
              background: #e3f2fd;
              border: 1px solid #90caf9;
              border-radius: 8px;
              padding: 15px 20px;
              margin-bottom: 20px;
            }
            .barra-title {
              font-weight: 600;
              color: #1565c0;
              margin-bottom: 8px;
              font-size: 11pt;
            }
            .barra-desc {
              font-size: 10pt;
              color: #444;
            }
            
            /* Extras */
            .extras-section {
              margin-bottom: 20px;
            }
            .extras-title {
              font-size: 12pt;
              font-weight: 600;
              color: #2d5a27;
              margin-bottom: 10px;
            }
            .extras-table {
              width: 100%;
              border-collapse: collapse;
            }
            .extras-table td {
              padding: 10px 15px;
              border-bottom: 1px solid #eee;
            }
            .extras-table tr:nth-child(even) { background: #f9f9f9; }
            .extras-table td:last-child {
              text-align: right;
              font-weight: 600;
              color: #2d5a27;
            }
            
            /* Resumen total */
            .resumen-box {
              background: #f5f5f5;
              border-radius: 8px;
              padding: 20px;
              margin-bottom: 20px;
            }
            .resumen-title {
              font-size: 12pt;
              font-weight: 600;
              color: #333;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 2px solid #ddd;
            }
            .resumen-row {
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              font-size: 11pt;
            }
            .resumen-row.subtotal {
              border-top: 1px solid #ddd;
              padding-top: 12px;
              margin-top: 5px;
            }
            .resumen-row.descuento { color: #e53935; }
            
            .total-final {
              background: linear-gradient(135deg, #2d5a27 0%, #4a7c43 100%);
              color: white;
              padding: 15px 20px;
              border-radius: 8px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-top: 15px;
            }
            .total-label { font-size: 16pt; font-weight: 500; }
            .total-amount { font-size: 24pt; font-weight: 700; }
            
            .anticipo-box {
              background: #fff8e1;
              border: 2px solid #ffc107;
              border-radius: 8px;
              padding: 15px 20px;
              margin-top: 15px;
            }
            .anticipo-row {
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .anticipo-label { font-weight: 500; color: #f57c00; }
            .anticipo-amount { 
              font-size: 18pt; 
              font-weight: 700; 
              color: #e65100;
            }
            .anticipo-note {
              font-size: 10pt;
              color: #666;
              margin-top: 8px;
            }
            
            /* Estacionamiento */
            .estacionamiento {
              background: #fafafa;
              padding: 12px 15px;
              border-radius: 6px;
              margin-bottom: 15px;
              font-size: 10pt;
            }
            .estacionamiento strong { color: #333; }
            
            /* Servicios adicionales disponibles */
            .servicios-adicionales {
              background: #f0f0f0;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
            }
            .servicios-title {
              font-weight: 600;
              margin-bottom: 10px;
              color: #555;
            }
            .servicios-list {
              font-size: 10pt;
              color: #666;
              line-height: 1.8;
            }
            .servicios-list span {
              display: inline-block;
              margin-right: 5px;
            }
            
            /* Condiciones */
            .condiciones {
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 20px;
            }
            .condiciones-title {
              font-weight: 600;
              color: #333;
              margin-bottom: 10px;
            }
            .condiciones-list {
              font-size: 10pt;
              color: #555;
              padding-left: 20px;
            }
            .condiciones-list li { margin: 5px 0; }
            
            /* Notas */
            .notas-box {
              background: #fff3e0;
              border-left: 4px solid #ff9800;
              padding: 12px 15px;
              margin-bottom: 20px;
              font-size: 10pt;
            }
            .notas-title {
              font-weight: 600;
              color: #e65100;
              margin-bottom: 5px;
            }
            
            /* Footer */
            .footer {
              text-align: center;
              padding: 20px 0;
              margin-top: 20px;
              border-top: 3px solid #7cb342;
            }
            .footer-msg {
              font-size: 11pt;
              color: #555;
              margin-bottom: 15px;
            }
            .footer-firma {
              font-style: italic;
              margin-bottom: 5px;
            }
            .footer-nombre {
              font-size: 14pt;
              font-weight: 600;
              color: #2d5a27;
            }
            .footer-direccion {
              font-size: 10pt;
              color: #888;
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px solid #ddd;
            }
            
            /* Vigencia */
            .vigencia {
              text-align: center;
              margin-top: 15px;
            }
            .vigencia-badge {
              display: inline-block;
              background: #ffeb3b;
              color: #333;
              padding: 8px 20px;
              border-radius: 20px;
              font-size: 10pt;
              font-weight: 600;
            }
            
            /* Print styles */
            @media print {
              body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              .page { padding: 0; }
            }
          </style>
        </head>
        <body>
          <div class="page">
            <!-- Header con logo -->
            <div class="header">
              <div class="logo">
                <span class="jar">jar</span><span class="din">d</span><span class="leaf">ğŸŒ¿</span><span class="din">n</span><span class="escondido"> escondido</span>
              </div>
            </div>
            
            <!-- IntroducciÃ³n -->
            <div class="intro">
              <p>
                Ponemos a su apreciable consideraciÃ³n la siguiente cotizaciÃ³n para su evento de 
                <strong>${cot.personas} personas</strong>. Incluye instalaciones y servicios por 
                <strong>${CONFIG_NEGOCIO.condiciones.duracionBase} horas</strong> mÃ¡s media hora de recepciÃ³n de invitados 
                y media hora para salida, un coordinador y personal de limpieza.
              </p>
            </div>
            
            <!-- Info del evento -->
            <div class="event-info">
              <div class="event-info-item">
                <div class="event-info-label">CotizaciÃ³n</div>
                <div class="event-info-value">${cot.folio || 'NUEVA'}</div>
              </div>
              <div class="event-info-item">
                <div class="event-info-label">Fecha del Evento</div>
                <div class="event-info-value">${fmtFechaLarga(cot.cliente?.fechaEvento)}</div>
              </div>
              <div class="event-info-item">
                <div class="event-info-label">Tipo de Evento</div>
                <div class="event-info-value">${cot.cliente?.tipoEvento || 'Evento'}</div>
              </div>
              <div class="event-info-item">
                <div class="event-info-label">No. de Personas</div>
                <div class="event-info-value">${cot.personas}</div>
              </div>
            </div>
            
            <!-- Datos del cliente -->
            <div class="cliente-box">
              <div class="cliente-title">ğŸ‘¤ Datos del Cliente</div>
              <div class="cliente-grid">
                <div class="cliente-item">
                  <span class="cliente-label">Nombre:</span>
                  <span class="cliente-value">${cot.cliente?.nombre || '-'}</span>
                </div>
                <div class="cliente-item">
                  <span class="cliente-label">TelÃ©fono:</span>
                  <span class="cliente-value">${cot.cliente?.telefono || '-'}</span>
                </div>
                <div class="cliente-item">
                  <span class="cliente-label">Email:</span>
                  <span class="cliente-value">${cot.cliente?.email || '-'}</span>
                </div>
                <div class="cliente-item">
                  <span class="cliente-label">Fecha emisiÃ³n:</span>
                  <span class="cliente-value">${new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                </div>
              </div>
            </div>
            
            <!-- Paquete/Mobiliario -->
            <div class="paquete-section">
              <div class="paquete-header">
                ğŸ“¦ ${cot.modoPersonalizado ? 'Servicios y Mobiliario Personalizado' : paquete.nombre}
              </div>
              <div class="paquete-content">
                ${cot.modoPersonalizado && cot.itemsPersonalizados?.length > 0 ? `
                  <div class="paquete-includes" style="columns: 1;">
                    ${cot.itemsPersonalizados.map(item => `
                      <div class="paquete-item">
                        <span class="paquete-qty">${item.cantidad}</span>
                        ${item.nombre}
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <p style="margin-bottom: 15px; color: #666; font-size: 10pt;">${paquete.descripcion}</p>
                  <div class="paquete-includes">
                    ${(paquete.incluye || []).map(item => `
                      <div class="paquete-item">${item}</div>
                    `).join('')}
                  </div>
                `}
                
                <div class="precios-grid">
                  <div class="precio-row">
                    <span class="precio-concepto"><strong>Mobiliario</strong></span>
                    <span class="precio-monto">${fmt(cot.mobiliario || 0)}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Alimentos -->
            <div class="paquete-section">
              <div class="paquete-header" style="background: #f57c00;">
                ğŸ½ï¸ Alimentos - ${cot.modoPersonalizado && cot.alimentoPersonalizado?.nombre ? cot.alimentoPersonalizado.nombre : tipoAlimento.nombre}
              </div>
              <div class="paquete-content" style="border-color: #f57c00;">
                ${cot.modoPersonalizado && cot.alimentoPersonalizado?.nombre ? `
                  <p style="color: #666; margin-bottom: 10px;">${cot.alimentoPersonalizado.nombre}</p>
                ` : `
                  <p style="color: #666; margin-bottom: 10px;">${tipoAlimento.descripcion}</p>
                `}
                <div class="precios-grid" style="border-top: none; padding-top: 0; margin-top: 0;">
                  <div class="precio-row">
                    <span class="precio-concepto">
                      <strong>${cot.personas} personas</strong> Ã— 
                      ${fmt(cot.modoPersonalizado && cot.alimentoPersonalizado?.precioPP ? cot.alimentoPersonalizado.precioPP : (cot.precioPP || 0))} por persona
                    </span>
                    <span class="precio-monto">${fmt(cot.alimentos || 0)}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Barra de Mezcladores -->
            <div class="barra-box">
              <div class="barra-title">ğŸ¹ Barra de Mezcladores (Incluida)</div>
              <div class="barra-desc">
                ${BARRA_MEZCLADORES.descripcion}<br>
                <strong>Opciones de agua:</strong> ${BARRA_MEZCLADORES.opciones.join(', ')}
              </div>
            </div>
            
            ${extrasSeleccionados.length > 0 ? `
            <!-- Extras contratados -->
            <div class="extras-section">
              <div class="extras-title">âœ¨ Servicios Adicionales Contratados</div>
              <table class="extras-table">
                ${extrasSeleccionados.map(e => `
                  <tr>
                    <td>${e.nombre}</td>
                    <td>
                      ${e.precioPP ? `${cot.personas} Ã— ${fmt(e.precioPP)} = ` : ''}${fmt(e.precioPP ? e.precioPP * cot.personas : e.precio)}
                    </td>
                  </tr>
                `).join('')}
              </table>
            </div>
            ` : ''}
            
            <!-- Resumen de inversiÃ³n -->
            <div class="resumen-box">
              <div class="resumen-title">ğŸ’° Resumen de InversiÃ³n</div>
              
              <div class="resumen-row">
                <span>Mobiliario ${cot.modoPersonalizado ? 'personalizado' : '(' + paquete.nombre + ')'}</span>
                <span>${fmt(cot.mobiliario || 0)}</span>
              </div>
              <div class="resumen-row">
                <span>Alimentos (${cot.personas} personas)</span>
                <span>${fmt(cot.alimentos || 0)}</span>
              </div>
              ${(cot.extras || 0) > 0 ? `
              <div class="resumen-row">
                <span>Servicios adicionales</span>
                <span>${fmt(cot.extras)}</span>
              </div>
              ` : ''}
              <div class="resumen-row subtotal">
                <span>Subtotal</span>
                <span><strong>${fmt(cot.subtotal || 0)}</strong></span>
              </div>
              ${(cot.descuento || 0) > 0 ? `
              <div class="resumen-row descuento">
                <span>Descuento</span>
                <span>-${fmt(cot.descuento)}</span>
              </div>
              ` : ''}
              
              <div class="total-final">
                <span class="total-label">INVERSIÃ“N TOTAL</span>
                <span class="total-amount">${fmt(cot.total || 0)}</span>
              </div>
              
              <div class="anticipo-box">
                <div class="anticipo-row">
                  <span class="anticipo-label">Anticipo para apartar fecha (${CONFIG_NEGOCIO.condiciones.anticipo}%)</span>
                  <span class="anticipo-amount">${fmt(cot.anticipo || 0)}</span>
                </div>
                <div class="anticipo-note">
                  Resto (${100 - CONFIG_NEGOCIO.condiciones.anticipo}%): <strong>${fmt((cot.total || 0) - (cot.anticipo || 0))}</strong> â€” 
                  a liquidar ${CONFIG_NEGOCIO.condiciones.liquidacion} dÃ­as antes del evento
                </div>
              </div>
            </div>
            
            ${cot.notas ? `
            <!-- Notas especiales -->
            <div class="notas-box">
              <div class="notas-title">ğŸ“ Notas Especiales</div>
              <div>${cot.notas}</div>
            </div>
            ` : ''}
            
            <!-- Estacionamiento -->
            <div class="estacionamiento">
              <strong>ğŸš— Estacionamiento:</strong> 
              Privado con servicio de Valet Parking (costo por cuenta del invitado) <strong>$${CONFIG_NEGOCIO.estacionamiento.valetParking}.00</strong><br>
              Los anfitriones reciben cortesÃ­a para ${CONFIG_NEGOCIO.estacionamiento.cortesiaAnfitriones} coche(s).
            </div>
            
            <!-- Servicios adicionales disponibles -->
            <div class="servicios-adicionales">
              <div class="servicios-title">ğŸ‰ Servicios Adicionales Disponibles</div>
              <div class="servicios-list">
                <span>â€¢ Cerveza por cartÃ³n</span>
                <span>â€¢ Pista de baile iluminada</span>
                <span>â€¢ Barra de botanas</span>
                <span>â€¢ FotografÃ­a y video</span>
                <span>â€¢ Cabina de foto inflable</span>
                <span>â€¢ 360 Photo booth</span>
                <span>â€¢ Cabina tipo espejo</span>
                <span>â€¢ Letras gigantes 1.80 iluminadas</span>
                <span>â€¢ IluminaciÃ³n vintage</span>
                <span>â€¢ DJ</span>
                <span>â€¢ Personajes para animar / Batucada</span>
              </div>
            </div>
            
            <!-- Condiciones -->
            <div class="condiciones">
              <div class="condiciones-title">ğŸ“‹ Condiciones</div>
              <ul class="condiciones-list">
                <li>${CONFIG_NEGOCIO.condiciones.anticipo}% para apartar fecha y ${100 - CONFIG_NEGOCIO.condiciones.anticipo}% restante ${CONFIG_NEGOCIO.condiciones.liquidacion} dÃ­as antes del evento.</li>
                <li>El precio por persona ya incluye el mobiliario, vajilla, meseros y alimentos.</li>
                <li>DuraciÃ³n del evento: ${CONFIG_NEGOCIO.condiciones.duracionBase} horas + media hora de recepciÃ³n + media hora para salida.</li>
                <li>Cambios de menÃº o servicios se pueden realizar hasta 15 dÃ­as antes del evento.</li>
              </ul>
            </div>
            
            <!-- Footer -->
            <div class="footer">
              <div class="footer-msg">
                Quedo a su disposiciÃ³n para cualquier duda o presupuesto adicional que requiera
              </div>
              <div class="footer-firma">Atentamente</div>
              <div class="footer-nombre">${CONFIG_NEGOCIO.contacto}</div>
              <div class="footer-direccion">
                ${CONFIG_NEGOCIO.direccion} â€¢ Tel. ${CONFIG_NEGOCIO.telefono}
              </div>
            </div>
            
            <!-- Vigencia -->
            <div class="vigencia">
              <span class="vigencia-badge">â° Esta cotizaciÃ³n tiene vigencia de 15 dÃ­as</span>
            </div>
          </div>
        </body>
        </html>
      `;

      // MÃ©todo alternativo: usar iframe oculto para imprimir
      let iframe = document.getElementById('print-iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'print-iframe';
        iframe.style.cssText = 'position: fixed; right: 0; bottom: 0; width: 0; height: 0; border: 0;';
        document.body.appendChild(iframe);
      }
      
      const iframeDoc = iframe.contentWindow || iframe.contentDocument;
      const doc = iframeDoc.document || iframeDoc;
      
      doc.open();
      doc.write(contenidoPDF);
      doc.close();
      
      // Esperar a que cargue y luego imprimir
      iframe.onload = () => {
        setTimeout(() => {
          try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
          } catch (e) {
            // Si falla el iframe, intentar abrir ventana
            const ventana = window.open('', '_blank');
            if (ventana) {
              ventana.document.write(contenidoPDF);
              ventana.document.close();
              ventana.onload = () => ventana.print();
            } else {
              alert('Por favor permite las ventanas emergentes para imprimir la cotizaciÃ³n.\n\nEn Chrome: Click en el Ã­cono de bloqueo ğŸ”’ en la barra de direcciones â†’ Permitir ventanas emergentes');
            }
          }
        }, 300);
      };
    };

    window.enviarWhatsApp = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;

      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      
      const mensaje = `ğŸŒ¿ *JARDÃN ESCONDIDO*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ *CotizaciÃ³n ${cot.folio}*

ğŸ‘¤ *Cliente:* ${cot.cliente?.nombre}
ğŸ“… *Fecha del evento:* ${fmtFechaLarga(cot.cliente?.fechaEvento)}
ğŸ‘¥ *Personas:* ${cot.personas}
ğŸª *Tipo de evento:* ${cot.cliente?.tipoEvento || 'Evento'}

ğŸ“¦ *Paquete:* ${paquete.nombre}
ğŸ½ï¸ *Alimentos:* ${TIPOS_ALIMENTO.find(t => t.id === cot.tipoAlimento)?.nombre || 'Taquiza'}

ğŸ’° *INVERSIÃ“N TOTAL:* ${fmt(cot.total)}
ğŸ’µ *Anticipo (${CONFIG_NEGOCIO.condiciones.anticipo}%):* ${fmt(cot.anticipo)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ${CONFIG_NEGOCIO.direccion}
ğŸ“ Tel. ${CONFIG_NEGOCIO.telefono}

_CotizaciÃ³n vÃ¡lida por 15 dÃ­as_
_Le envÃ­o el PDF con los detalles completos_`;

      const telefono = cot.cliente?.telefono?.replace(/\D/g, '') || '';
      const telefonoCompleto = telefono.startsWith('52') ? telefono : '52' + telefono;
      
      const url = `https://wa.me/${telefonoCompleto}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    window.enviarWhatsAppNumeroPersonalizado = (id) => {
      const numero = prompt('Ingresa el nÃºmero de WhatsApp (10 dÃ­gitos):');
      if (!numero) return;
      
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;

      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      
      const mensaje = `ğŸŒ¿ *JARDÃN ESCONDIDO*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ *CotizaciÃ³n ${cot.folio}*

ğŸ‘¤ *Cliente:* ${cot.cliente?.nombre}
ğŸ“… *Fecha del evento:* ${fmtFechaLarga(cot.cliente?.fechaEvento)}
ğŸ‘¥ *Personas:* ${cot.personas}

ğŸ“¦ *Paquete:* ${paquete.nombre}
ğŸ½ï¸ *Alimentos:* ${TIPOS_ALIMENTO.find(t => t.id === cot.tipoAlimento)?.nombre || 'Taquiza'}

ğŸ’° *INVERSIÃ“N TOTAL:* ${fmt(cot.total)}
ğŸ’µ *Anticipo (${CONFIG_NEGOCIO.condiciones.anticipo}%):* ${fmt(cot.anticipo)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ${CONFIG_NEGOCIO.direccion}
ğŸ“ Tel. ${CONFIG_NEGOCIO.telefono}`;

      const telefonoLimpio = numero.replace(/\D/g, '');
      const telefonoCompleto = telefonoLimpio.startsWith('52') ? telefonoLimpio : '52' + telefonoLimpio;
      
      const url = `https://wa.me/${telefonoCompleto}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    window.imprimirCotizacion = (id) => {
      generarPDFCotizacion(id);
    };

    window.cambiarEstadoCotizacion = async (id, nuevoEstado) => {
      try {
        await updateDoc(doc(db, 'cotizaciones', id), { 
          estado: nuevoEstado,
          fechaActualizacion: serverTimestamp()
        });
        await cargarDatos();
        // Actualizar el item editando
        if (itemEditando && itemEditando.id === id) {
          itemEditando = cotizaciones.find(c => c.id === id);
        }
        render();
      } catch (e) {
        console.error('Error:', e);
        alert('Error al actualizar estado');
      }
    };

    // ========== VOUCHERS / TICKETS ==========
    window.imprimirVoucherAnticipo = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;
      
      const ahora = new Date();
      const fechaHora = ahora.toLocaleDateString('es-MX') + ' ' + ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      
      const ticket = generarTicketVoucher(cot, 'ANTICIPO', cot.anticipo, fechaHora);
      imprimirTicket(ticket);
    };

    window.imprimirVoucherLiquidacion = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;
      
      const ahora = new Date();
      const fechaHora = ahora.toLocaleDateString('es-MX') + ' ' + ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      const restante = (cot.total || 0) - (cot.anticipo || 0);
      
      const ticket = generarTicketVoucher(cot, 'LIQUIDACIÃ“N', restante, fechaHora);
      imprimirTicket(ticket);
    };

    window.imprimirVoucherPagoTotal = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;
      
      const ahora = new Date();
      const fechaHora = ahora.toLocaleDateString('es-MX') + ' ' + ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      
      const ticket = generarTicketVoucher(cot, 'PAGO TOTAL', cot.total, fechaHora);
      imprimirTicket(ticket);
    };

    window.imprimirVoucherPersonalizado = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;
      
      const monto = prompt('Ingresa el monto del pago:');
      if (!monto) return;
      
      const concepto = prompt('Concepto del pago:', 'Abono a evento');
      if (!concepto) return;
      
      const ahora = new Date();
      const fechaHora = ahora.toLocaleDateString('es-MX') + ' ' + ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      
      const ticket = generarTicketVoucher(cot, concepto.toUpperCase(), parseFloat(monto), fechaHora);
      imprimirTicket(ticket);
    };

    function generarTicketVoucher(cot, concepto, monto, fechaHora) {
      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      const folio = `V${Date.now().toString().slice(-8)}`;
      
      return `
        <div class="ticket-font" style="width: 280px; padding: 10px; font-size: 12px; line-height: 1.4;">
          <!-- Header -->
          <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
            <div style="font-size: 18px; font-weight: bold;">ğŸŒ¿ JARDÃN ESCONDIDO</div>
            <div style="font-size: 10px; margin-top: 5px;">${CONFIG_NEGOCIO.direccion}</div>
            <div style="font-size: 10px;">Tel. ${CONFIG_NEGOCIO.telefono}</div>
          </div>

          <!-- Tipo de Voucher -->
          <div style="text-align: center; background: #000; color: #fff; padding: 8px; margin: 10px 0; font-weight: bold; font-size: 14px;">
            COMPROBANTE DE ${concepto}
          </div>

          <!-- Info del Voucher -->
          <div style="margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between;">
              <span>Voucher:</span>
              <span style="font-weight: bold;">${folio}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Fecha:</span>
              <span>${fechaHora}</span>
            </div>
          </div>

          <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
            <!-- Datos del Cliente -->
            <div style="margin-bottom: 8px;">
              <div style="font-weight: bold;">CLIENTE:</div>
              <div>${cot.cliente?.nombre || '-'}</div>
              <div style="font-size: 10px;">${cot.cliente?.telefono || ''}</div>
            </div>

            <!-- Datos del Evento -->
            <div style="margin-bottom: 8px;">
              <div style="font-weight: bold;">EVENTO:</div>
              <div>${cot.cliente?.tipoEvento || 'Evento'}</div>
              <div>Fecha: ${fmtFecha(cot.cliente?.fechaEvento)}</div>
              <div>Personas: ${cot.personas}</div>
            </div>

            <!-- CotizaciÃ³n -->
            <div>
              <div style="font-weight: bold;">COTIZACIÃ“N:</div>
              <div>Folio: ${cot.folio}</div>
              <div>Paquete: ${paquete.nombre}</div>
            </div>
          </div>

          <!-- Resumen Financiero -->
          <div style="margin: 10px 0; padding: 10px 0; border-bottom: 1px dashed #000;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Total evento:</span>
              <span>${fmt(cot.total)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Anticipo (${CONFIG_NEGOCIO.condiciones.anticipo}%):</span>
              <span>${fmt(cot.anticipo)}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Resto a pagar:</span>
              <span>${fmt((cot.total || 0) - (cot.anticipo || 0))}</span>
            </div>
          </div>

          <!-- Monto Pagado -->
          <div style="text-align: center; margin: 15px 0; padding: 15px; border: 2px solid #000;">
            <div style="font-size: 11px; margin-bottom: 5px;">${concepto}</div>
            <div style="font-size: 24px; font-weight: bold;">${fmt(monto)}</div>
          </div>

          <!-- MÃ©todo de Pago -->
          <div style="text-align: center; margin: 10px 0;">
            <div style="font-size: 10px;">MÃ©todo de pago: ________________</div>
          </div>

          <!-- Footer -->
          <div style="text-align: center; border-top: 1px dashed #000; padding-top: 10px; margin-top: 10px;">
            <div style="font-size: 10px; margin-bottom: 5px;">Â¡Gracias por su preferencia!</div>
            <div style="font-size: 9px; color: #666;">Conserve este comprobante</div>
            <div style="font-size: 9px; color: #666; margin-top: 5px;">AtendiÃ³: ${usuario?.nombre || 'Sistema'}</div>
          </div>

          <!-- Firma -->
          <div style="margin-top: 30px; border-top: 1px solid #000; padding-top: 5px; text-align: center;">
            <div style="font-size: 9px;">Firma de recibido</div>
          </div>

          <!-- Corte -->
          <div style="text-align: center; margin-top: 20px; font-size: 10px; color: #999;">
            - - - - - - - - - - - - - - - - - -
          </div>
        </div>
      `;
    }

    function imprimirTicket(contenido) {
      const printArea = document.getElementById('print-area');
      printArea.innerHTML = contenido;
      printArea.classList.remove('hidden');
      
      // Estilos especÃ­ficos para ticket
      const style = document.createElement('style');
      style.id = 'ticket-print-style';
      style.innerHTML = `
        @media print {
          @page {
            size: 80mm auto;
            margin: 0;
          }
          body * {
            visibility: hidden;
          }
          #print-area, #print-area * {
            visibility: visible;
          }
          #print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 80mm;
          }
        }
      `;
      document.head.appendChild(style);
      
      setTimeout(() => {
        window.print();
        printArea.classList.add('hidden');
        document.getElementById('ticket-print-style')?.remove();
      }, 300);
    }

    // Voucher de reservaciÃ³n confirmada
    window.imprimirVoucherReservacion = (id) => {
      const cot = cotizaciones.find(c => c.id === id);
      if (!cot) return;
      
      const ahora = new Date();
      const fechaHora = ahora.toLocaleDateString('es-MX') + ' ' + ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      const paquete = PAQUETES.find(p => p.id === cot.paquete) || PAQUETES[0];
      
      const ticket = `
        <div class="ticket-font" style="width: 280px; padding: 10px; font-size: 12px; line-height: 1.4;">
          <!-- Header -->
          <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
            <div style="font-size: 18px; font-weight: bold;">ğŸŒ¿ JARDÃN ESCONDIDO</div>
            <div style="font-size: 10px; margin-top: 5px;">${CONFIG_NEGOCIO.direccion}</div>
            <div style="font-size: 10px;">Tel. ${CONFIG_NEGOCIO.telefono}</div>
          </div>

          <!-- Tipo -->
          <div style="text-align: center; background: #000; color: #fff; padding: 8px; margin: 10px 0; font-weight: bold; font-size: 14px;">
            âœ“ RESERVACIÃ“N CONFIRMADA
          </div>

          <!-- Datos -->
          <div style="border: 2px solid #000; padding: 15px; margin: 10px 0; text-align: center;">
            <div style="font-size: 10px; color: #666;">FECHA DEL EVENTO</div>
            <div style="font-size: 18px; font-weight: bold; margin: 5px 0;">${fmtFechaLarga(cot.cliente?.fechaEvento)}</div>
            <div style="font-size: 14px; margin-top: 10px;">${cot.cliente?.tipoEvento || 'Evento'}</div>
            <div style="font-size: 12px; color: #666;">${cot.personas} personas</div>
          </div>

          <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
            <div style="margin-bottom: 8px;">
              <div style="font-weight: bold;">CLIENTE:</div>
              <div>${cot.cliente?.nombre}</div>
              <div style="font-size: 10px;">${cot.cliente?.telefono || ''}</div>
            </div>
            <div>
              <div style="font-weight: bold;">PAQUETE:</div>
              <div>${paquete.nombre}</div>
            </div>
          </div>

          <!-- Resumen -->
          <div style="margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
              <span>TOTAL:</span>
              <span>${fmt(cot.total)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
              <span>Anticipo pagado:</span>
              <span>${fmt(cot.anticipo)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px;">
              <span>Pendiente:</span>
              <span>${fmt((cot.total || 0) - (cot.anticipo || 0))}</span>
            </div>
          </div>

          <!-- Recordatorio -->
          <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 10px; text-align: center;">
            <div style="font-weight: bold;">ğŸ“… RECORDATORIO</div>
            <div>Liquidar ${CONFIG_NEGOCIO.condiciones.liquidacion} dÃ­as antes del evento</div>
          </div>

          <!-- Footer -->
          <div style="text-align: center; border-top: 1px dashed #000; padding-top: 10px; margin-top: 10px;">
            <div style="font-size: 11px; font-weight: bold;">Folio: ${cot.folio}</div>
            <div style="font-size: 9px; margin-top: 5px;">Emitido: ${fechaHora}</div>
            <div style="font-size: 10px; margin-top: 10px;">Â¡Gracias por elegirnos!</div>
          </div>

          <div style="text-align: center; margin-top: 20px; font-size: 10px; color: #999;">
            - - - - - - - - - - - - - - - - - -
          </div>
        </div>
      `;
      
      imprimirTicket(ticket);
    };

    // Productos
    window.guardarProducto = async (id) => {
      const producto = {
        nombre: document.getElementById('prod-nombre').value,
        categoria: document.getElementById('prod-categoria').value,
        costo: parseFloat(document.getElementById('prod-costo').value) || 0,
        precio: parseFloat(document.getElementById('prod-precio').value) || 0,
        activo: document.getElementById('prod-activo').checked
      };

      if (!producto.nombre) { alert('Ingresa el nombre del producto'); return; }

      if (await guardarDoc('productos', id || genId(), producto)) {
        alert('âœ… Producto guardado');
        cerrarModal();
      }
    };

    // ========== FUNCIONES DE COTIZACIÃ“N PERSONALIZADA ==========
    window.agregarItemPersonalizado = (itemId) => {
      const item = ITEMS_INDIVIDUALES.find(i => i.id === itemId);
      if (!item) return;

      const cantidad = item.porPersona ? cotizacionActual.personas : 1;
      const subtotal = item.precio * cantidad;

      cotizacionActual.itemsPersonalizados = cotizacionActual.itemsPersonalizados || [];
      cotizacionActual.itemsPersonalizados.push({
        itemId: item.id,
        nombre: item.nombre,
        cantidad,
        precioUnitario: item.precio,
        subtotal,
        porPersona: item.porPersona
      });
      render();
    };

    window.agregarItemManual = () => {
      const nombre = document.getElementById('item-custom-nombre').value;
      const cantidad = parseInt(document.getElementById('item-custom-cantidad').value) || 1;
      const precio = parseFloat(document.getElementById('item-custom-precio').value) || 0;

      if (!nombre || !precio) { alert('Ingresa nombre y precio'); return; }

      cotizacionActual.itemsPersonalizados = cotizacionActual.itemsPersonalizados || [];
      cotizacionActual.itemsPersonalizados.push({
        itemId: 'custom_' + genId(),
        nombre,
        cantidad,
        precioUnitario: precio,
        subtotal: cantidad * precio
      });

      document.getElementById('item-custom-nombre').value = '';
      document.getElementById('item-custom-cantidad').value = '1';
      document.getElementById('item-custom-precio').value = '';
      render();
    };

    window.quitarItemPersonalizado = (idx) => {
      cotizacionActual.itemsPersonalizados.splice(idx, 1);
      render();
    };

    // ========== FUNCIONES DE CONFIGURACIÃ“N ==========
    // Paquetes
    window.actualizarPaquete = (idx, campo, valor) => {
      PAQUETES[idx][campo] = valor;
      render();
    };

    window.actualizarPaqueteIncluye = (paqIdx, itemIdx, valor) => {
      PAQUETES[paqIdx].incluye[itemIdx] = valor;
      render();
    };

    window.agregarPaqueteIncluye = (idx) => {
      PAQUETES[idx].incluye = PAQUETES[idx].incluye || [];
      PAQUETES[idx].incluye.push('Nuevo item');
      render();
    };

    window.quitarPaqueteIncluye = (paqIdx, itemIdx) => {
      PAQUETES[paqIdx].incluye.splice(itemIdx, 1);
      render();
    };

    window.actualizarPaquetePrecio = (idx, personas, campo, valor) => {
      if (!PAQUETES[idx].precios) PAQUETES[idx].precios = {};
      if (!PAQUETES[idx].precios[personas]) PAQUETES[idx].precios[personas] = { mobiliario: 0, taquiza: 0, parrillada: 0 };
      PAQUETES[idx].precios[personas][campo] = parseFloat(valor) || 0;
      render();
    };

    window.agregarRangoPersonas = (idx) => {
      const personas = prompt('NÃºmero de personas para este rango:');
      if (!personas) return;
      if (!PAQUETES[idx].precios) PAQUETES[idx].precios = {};
      PAQUETES[idx].precios[personas] = { mobiliario: 0, taquiza: 0, parrillada: 0 };
      render();
    };

    window.agregarNuevoPaquete = () => {
      PAQUETES.push({
        id: 'paquete_' + genId(),
        nombre: 'Nuevo Paquete',
        descripcion: 'DescripciÃ³n del paquete',
        incluye: ['Item 1', 'Item 2'],
        precios: {
          50: { mobiliario: 20000, taquiza: 500, parrillada: 480 },
          70: { mobiliario: 25000, taquiza: 520, parrillada: 500 }
        }
      });
      render();
    };

    window.eliminarPaquete = (idx) => {
      if (!confirm('Â¿Eliminar este paquete?')) return;
      PAQUETES.splice(idx, 1);
      render();
    };

    window.guardarConfiguracionPaquetes = async () => {
      if (await guardarConfiguracion('paquetes', PAQUETES)) {
        alert('âœ… Paquetes guardados');
      }
    };

    // Extras
    window.actualizarExtra = (idx, campo, valor) => {
      EXTRAS[idx][campo] = valor;
      render();
    };

    window.toggleExtraPorPersona = (idx) => {
      const extra = EXTRAS[idx];
      if (extra.precioPP) {
        extra.precio = extra.precioPP;
        delete extra.precioPP;
      } else {
        extra.precioPP = extra.precio;
        delete extra.precio;
      }
      render();
    };

    window.agregarNuevoExtra = () => {
      const nombre = document.getElementById('nuevo-extra-nombre').value;
      const precio = parseFloat(document.getElementById('nuevo-extra-precio').value) || 0;
      const porPersona = document.getElementById('nuevo-extra-pp').checked;

      if (!nombre) { alert('Ingresa el nombre'); return; }

      const nuevoExtra = { id: 'extra_' + genId(), nombre };
      if (porPersona) nuevoExtra.precioPP = precio;
      else nuevoExtra.precio = precio;

      EXTRAS.push(nuevoExtra);
      document.getElementById('nuevo-extra-nombre').value = '';
      document.getElementById('nuevo-extra-precio').value = '';
      document.getElementById('nuevo-extra-pp').checked = false;
      render();
    };

    window.eliminarExtra = (idx) => {
      EXTRAS.splice(idx, 1);
      render();
    };

    window.guardarConfiguracionExtras = async () => {
      if (await guardarConfiguracion('extras', EXTRAS)) {
        alert('âœ… Extras guardados');
      }
    };

    // Items individuales
    window.actualizarItem = (idx, campo, valor) => {
      ITEMS_INDIVIDUALES[idx][campo] = valor;
      render();
    };

    window.agregarNuevoItem = () => {
      const nombre = document.getElementById('nuevo-item-nombre').value;
      let categoria = document.getElementById('nuevo-item-categoria').value;
      const precio = parseFloat(document.getElementById('nuevo-item-precio').value) || 0;
      const porPersona = document.getElementById('nuevo-item-pp').checked;

      if (!nombre) { alert('Ingresa el nombre'); return; }
      
      if (categoria === '__nueva__') {
        categoria = prompt('Nombre de la nueva categorÃ­a:');
        if (!categoria) return;
      }

      ITEMS_INDIVIDUALES.push({
        id: 'item_' + genId(),
        nombre,
        categoria,
        precio,
        porPersona
      });

      document.getElementById('nuevo-item-nombre').value = '';
      document.getElementById('nuevo-item-precio').value = '';
      document.getElementById('nuevo-item-pp').checked = false;
      render();
    };

    window.eliminarItem = (idx) => {
      ITEMS_INDIVIDUALES.splice(idx, 1);
      render();
    };

    window.guardarConfiguracionItems = async () => {
      if (await guardarConfiguracion('itemsIndividuales', ITEMS_INDIVIDUALES)) {
        alert('âœ… Items guardados');
      }
    };

    // Tipos de alimento
    window.actualizarTipoAlimento = (idx, campo, valor) => {
      TIPOS_ALIMENTO[idx][campo] = valor;
      render();
    };

    window.agregarNuevoTipoAlimento = () => {
      const nombre = document.getElementById('nuevo-alimento-nombre').value;
      const descripcion = document.getElementById('nuevo-alimento-desc').value;

      if (!nombre) { alert('Ingresa el nombre'); return; }

      TIPOS_ALIMENTO.push({
        id: 'alimento_' + genId(),
        nombre,
        descripcion
      });

      document.getElementById('nuevo-alimento-nombre').value = '';
      document.getElementById('nuevo-alimento-desc').value = '';
      render();
    };

    window.eliminarTipoAlimento = (idx) => {
      TIPOS_ALIMENTO.splice(idx, 1);
      render();
    };

    window.guardarConfiguracionAlimentos = async () => {
      if (await guardarConfiguracion('tiposAlimento', TIPOS_ALIMENTO)) {
        alert('âœ… Tipos de alimento guardados');
      }
    };

    // ========== FUNCIONES DE INSUMOS ==========
    window.filtrarInsumos = (cat) => {
      window.categoriaInsumoFiltro = cat;
      render();
    };

    window.guardarInsumo = async (id) => {
      const insumo = {
        nombre: document.getElementById('ins-nombre').value,
        categoria: document.getElementById('ins-categoria').value,
        unidadCompra: document.getElementById('ins-unidadCompra').value,
        precioCompra: parseFloat(document.getElementById('ins-precioCompra').value) || 0,
        unidadUso: document.getElementById('ins-unidadUso').value,
        equivalencia: parseFloat(document.getElementById('ins-equivalencia').value) || 1,
        stockActual: parseFloat(document.getElementById('ins-stockActual').value) || 0,
        stockMinimo: parseFloat(document.getElementById('ins-stockMinimo').value) || 0,
        proveedor: document.getElementById('ins-proveedor').value
      };

      if (!insumo.nombre) { alert('Ingresa el nombre del insumo'); return; }

      if (await guardarDoc('insumos', id || genId(), insumo)) {
        alert('âœ… Insumo guardado');
        cerrarModal();
      }
    };

    // ========== FUNCIONES DE RECETAS ==========
    window.agregarIngredienteReceta = () => {
      const insumoId = document.getElementById('rec-insumo').value;
      const cantidad = parseFloat(document.getElementById('rec-cantidad').value);

      if (!insumoId || !cantidad) { alert('Selecciona insumo y cantidad'); return; }

      if (!window.tempIngredientes) window.tempIngredientes = [];
      window.tempIngredientes.push({ insumoId, cantidad });
      
      document.getElementById('rec-insumo').value = '';
      document.getElementById('rec-cantidad').value = '';
      render();
    };

    window.quitarIngredienteReceta = (idx) => {
      window.tempIngredientes.splice(idx, 1);
      render();
    };

    window.cerrarModalReceta = () => {
      window.tempIngredientes = null;
      cerrarModal();
    };

    window.guardarReceta = async (id) => {
      const receta = {
        nombre: document.getElementById('rec-nombre').value,
        productoId: document.getElementById('rec-productoId').value,
        porciones: parseInt(document.getElementById('rec-porciones').value) || 1,
        ingredientes: window.tempIngredientes || [],
        instrucciones: document.getElementById('rec-instrucciones').value
      };

      if (!receta.nombre) { alert('Ingresa el nombre de la receta'); return; }
      if (receta.ingredientes.length === 0) { alert('Agrega al menos un ingrediente'); return; }

      if (await guardarDoc('recetas', id || genId(), receta)) {
        // Actualizar costo del producto vinculado
        if (receta.productoId) {
          const costoReceta = calcularCostoReceta(receta);
          await updateDoc(doc(db, 'productos', receta.productoId), { costo: costoReceta });
        }
        alert('âœ… Receta guardada');
        window.tempIngredientes = null;
        cerrarModal();
      }
    };

    // ========== FUNCIONES DE LISTA DE COMPRAS ==========
    window.agregarItemManualLista = async () => {
      const nombre = document.getElementById('item-manual-nombre').value;
      const cantidad = document.getElementById('item-manual-cantidad').value;
      const unidad = document.getElementById('item-manual-unidad').value;

      if (!nombre || !cantidad) { alert('Ingresa nombre y cantidad'); return; }

      listaCompras = listaCompras || [];
      listaCompras.push({ nombre, cantidad: parseFloat(cantidad), unidad });
      
      await guardarDoc('listaCompras', 'manual', { items: listaCompras });
      
      document.getElementById('item-manual-nombre').value = '';
      document.getElementById('item-manual-cantidad').value = '';
      render();
    };

    window.quitarItemManualLista = async (idx) => {
      listaCompras.splice(idx, 1);
      await guardarDoc('listaCompras', 'manual', { items: listaCompras });
      render();
    };

    window.toggleSelectAll = (checkbox) => {
      document.querySelectorAll('.item-compra').forEach(cb => cb.checked = checkbox.checked);
    };

    window.generarListaComprasPDF = () => {
      const itemsStockBajo = insumos.filter(i => i.stockActual <= i.stockMinimo).map(ins => ({
        ...ins,
        cantidadSugerida: Math.max(ins.stockMinimo * 2 - ins.stockActual, 1),
        costoEstimado: (Math.max(ins.stockMinimo * 2 - ins.stockActual, 1)) * ins.precioCompra
      }));

      const totalEstimado = itemsStockBajo.reduce((sum, i) => sum + i.costoEstimado, 0);
      const fecha = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });

      const contenido = `
        <div id="pdf-content" style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
          <div style="text-align: center; border-bottom: 2px solid #d97706; padding-bottom: 15px; margin-bottom: 20px;">
            <h1 style="color: #d97706; margin: 0;">ğŸ›’ Lista de Compras</h1>
            <p style="color: #666; margin: 5px 0 0 0;">JardÃ­n Escondido - ${fecha}</p>
          </div>

          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #fef3c7;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d97706;">Insumo</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d97706;">CategorÃ­a</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #d97706;">Cantidad</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d97706;">Precio Est.</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #d97706;">âœ“</th>
              </tr>
            </thead>
            <tbody>
              ${itemsStockBajo.map(ins => `
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${ins.nombre}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${ins.categoria}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">${ins.cantidadSugerida} ${ins.unidadCompra}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${fmt(ins.costoEstimado)}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">â˜</td>
                </tr>
              `).join('')}
              ${(listaCompras || []).map(item => `
                <tr style="background: #f0fdf4;">
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${item.nombre}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">Manual</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">${item.cantidad} ${item.unidad}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">-</td>
                  <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">â˜</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="background: #fef3c7;">
                <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold;">TOTAL ESTIMADO:</td>
                <td style="padding: 10px; text-align: right; font-weight: bold; font-size: 16px;">${fmt(totalEstimado)}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>

          <div style="margin-top: 30px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
            <p style="margin: 0; font-size: 12px; color: #666;">Notas: ________________________________________________</p>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">________________________________________________</p>
          </div>
        </div>
      `;

      const printArea = document.getElementById('print-area');
      printArea.innerHTML = contenido;
      printArea.classList.remove('hidden');

      const opt = {
        margin: 10,
        filename: `Lista_Compras_${new Date().toISOString().slice(0,10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(document.getElementById('pdf-content')).save().then(() => {
        printArea.classList.add('hidden');
        alert('âœ… PDF generado');
      });
    };

    // ========== AUTH STATE ==========
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const userDoc = await getDoc(doc(db, 'usuarios', user.uid));
          if (userDoc.exists()) {
            usuario = { uid: user.uid, email: user.email, ...userDoc.data() };
          } else {
            // Usuario sin documento - puede ser el primer admin
            usuario = { uid: user.uid, email: user.email, rol: null, sinPerfil: true };
          }
          
          // Solo cargar datos si es admin
          if (usuario.rol === 'admin') {
            await cargarDatos();
            escucharOrdenesRestaurante();
          }
        } catch (e) {
          console.error('Error cargando usuario:', e);
          usuario = { uid: user.uid, email: user.email, rol: null, sinPerfil: true };
        }
      } else {
        usuario = null;
      }
      render();
    });

    render();
  </script>
</body>
</html>
